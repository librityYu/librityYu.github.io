<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta property="og:type" content="website">
<meta property="og:title" content="Liberty&#39;s Blog">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Liberty&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Liberty">
<meta name="twitter:card" content="summary"><title>Liberty's Blog</title><link ref="canonical" href="http://example.com/page/2/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/日记/"><span class="header-nav-menu-item__icon"><i class="fas fa-book"></i></span><span class="header-nav-menu-item__text">日记</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Liberty's Blog</div><div class="header-banner-info__subtitle"></div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/03/15/HashMap%E5%A4%8D%E4%B9%A0%E6%97%B6%E5%80%99%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/">HashMap复习时候的一些问题总结</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-03-15</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-04-26</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="在获取hash值的时候-为什么要对hashcode进行一个右移16位的操作">
          <a href="#在获取hash值的时候-为什么要对hashcode进行一个右移16位的操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#在获取hash值的时候-为什么要对hashcode进行一个右移16位的操作" class="headerlink" title="在获取hash值的时候,为什么要对hashcode进行一个右移16位的操作"></a>在获取hash值的时候,为什么要对hashcode进行一个右移16位的操作</h1>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static final int hash(Object key) &#123;</span><br><span class="line">    int h;</span><br><span class="line">    return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>答: 目的是为了将hashcode的高位和低位进行混合,从而减少hash冲突的发生,也只能降低hash冲突的可能,增加性能.</p>

        <h1 id="为什么hash冲突会影响性能">
          <a href="#为什么hash冲突会影响性能" class="heading-link"><i class="fas fa-link"></i></a><a href="#为什么hash冲突会影响性能" class="headerlink" title="为什么hash冲突会影响性能"></a>为什么hash冲突会影响性能</h1>
      <p>因为hashmap最好的性能是实现O1的查找,插入,删除效率,但是由于会出现hash冲突,会导致多个值被装进同一个桶中,在hashmap里面桶里面的数据结果是用链表,红黑树来实现的,链表和红黑树的插入删除查找的复杂度增加了,就导致了hashmap的效率降低了.<br>为了减少hash冲突,应该选择合适的hash函数.调整hash表的大小,调整合适的装载因子.<br>hashmap里面默认的装载因子是0.75.  </p>

        <h1 id="扩容发生在哪些情况">
          <a href="#扩容发生在哪些情况" class="heading-link"><i class="fas fa-link"></i></a><a href="#扩容发生在哪些情况" class="headerlink" title="扩容发生在哪些情况"></a>扩容发生在哪些情况</h1>
      <ol>
<li>当hashmap里面的所有键值对的数量超过了设置的hashmap容量(默认大小16),时候会发生扩容</li>
</ol>

        <h1 id="什么情况下会转换成红黑树">
          <a href="#什么情况下会转换成红黑树" class="heading-link"><i class="fas fa-link"></i></a><a href="#什么情况下会转换成红黑树" class="headerlink" title="什么情况下会转换成红黑树"></a>什么情况下会转换成红黑树</h1>
      <p>当单个桶的数量超过8的时候:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">    treeifyBin(tab, hash);</span><br></pre></td></tr></table></div></figure>


        <h1 id="线程安全的话使用谁比较好">
          <a href="#线程安全的话使用谁比较好" class="heading-link"><i class="fas fa-link"></i></a><a href="#线程安全的话使用谁比较好" class="headerlink" title="线程安全的话使用谁比较好"></a>线程安全的话使用谁比较好</h1>
      <p>首先需要知道HashMap不是线程安全的.<br>线程安全的有:  </p>
<ul>
<li>HashTable</li>
<li>ConcurrentHashMap  </li>
</ul>
<p>HashTable : 实现的线程安全很简单,他直接给 put get 方法进行上锁(synchronized).这就导致在插入获取数据的时候效率会降低.<br>ConcurrentHashMap : 他在获取数据的时候效率比HashTable高,因为 get操作是不加锁的,他用了 volatile 关键字进行修饰,这个关键字保证了有序性和可见性,保证了每次获取的数据都是最新的.然后在 put 的时候使用乐观锁实现同步问题.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/03/10/Glide%E7%9A%84%E8%87%AA%E9%97%AE%E8%87%AA%E7%AD%94/">Glide的自问自答</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-03-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-04-26</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="1-Glide的缓存有哪些">
          <a href="#1-Glide的缓存有哪些" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Glide的缓存有哪些" class="headerlink" title="1. Glide的缓存有哪些"></a>1. Glide的缓存有哪些</h1>
      <p>内存缓存和磁盘缓存</p>

        <h1 id="2-缓存对应的实现类是什么">
          <a href="#2-缓存对应的实现类是什么" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-缓存对应的实现类是什么" class="headerlink" title="2. 缓存对应的实现类是什么"></a>2. 缓存对应的实现类是什么</h1>
      <p>内存缓存:  </p>
<ol>
<li>ActiveResource</li>
<li>LruResourceCache</li>
</ol>
<ul>
<li><code>ActiveResource</code>是使用<code>HaspMap</code>进行的数据存储.键值是用弱引用进行的包装.为什么要用弱引用,因为他缓存的是正在使用的图片,当页面被销毁了,你还拿着对象的引用,会造成内存泄漏,所以要用弱引用进行包装.</li>
<li><code>LruResourceCache</code>他缓存的是所有曾经加载过的图片信息,他和<code>ActiveResource</code>的区别是,他底层使用了<code>Lru</code>算法,然后<code>Lru</code>算法的实现是通过<code>LinkedHashmap</code>.为什么<code>LruResourceCache</code>要用到<code>Lru</code>算法,然后还不用弱引用.因为他缓存的不是正在使用的图片,不会存在内存泄漏的问题.然后如果他也使用了弱引用,就会导致缓存的资源被频繁的清空,也就失去了缓存的意义了.当然,缓存的大小总是有个边界的,所以使用了Lru算法,在超过缓存大小后删除那些最近最少使用的资源.这个实现就是用到了<code>LinkedHashMap</code>.<code>LinkedHashMap</code>继承<code>HashMap</code>,他重写了<code>newNode</code>方法,键值封装到了<code>LinkedHashMapEntry</code>里面,维护了一个双向链表.这样我们就能得到我们的插入顺序了.新插入的值是插在链表的尾部的.默认情况下<code>LinkedHashMap</code>的插入顺序和遍历顺序是一样的,但是我们通过改变<code>accessOrder</code>值为<code>true</code></li>
</ul>

        <h1 id="3-如何全局设置Glide的加载配置-并且他的原理是什么-为什么可以设置一个全局的加载配置">
          <a href="#3-如何全局设置Glide的加载配置-并且他的原理是什么-为什么可以设置一个全局的加载配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-如何全局设置Glide的加载配置-并且他的原理是什么-为什么可以设置一个全局的加载配置" class="headerlink" title="3. 如何全局设置Glide的加载配置,并且他的原理是什么,为什么可以设置一个全局的加载配置"></a>3. 如何全局设置Glide的加载配置,并且他的原理是什么,为什么可以设置一个全局的加载配置</h1>
      <p>在Glide里,配置信息都是写入<code>BaseRequesOptions</code>里面.我们每次发起请求通过<code>Glide.with(context)</code>先获取当前页面的<code>RequestManager</code>,然后在调用<code>load</code>创建<code>RequestBuilder</code>对象,这个对象是每次调用load都会创建一个新的.我们可以看到<code>RequestBuilder</code>是继承<code>BaseRequestOptions</code>的.看下对象创建的代码:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestManager</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">load</span><span class="params">(<span class="meta">@Nullable</span> String string)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> asDrawable().load(string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">asDrawable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> as(Drawable.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> &lt;ResourceType&gt; <span class="function">RequestBuilder&lt;ResourceType&gt; <span class="title">as</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Class&lt;ResourceType&gt; resourceClass)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> RequestBuilder&lt;&gt;(glide, <span class="keyword">this</span>, resourceClass, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RquestBuilder</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">RequestBuilder</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Glide glide,</span></span></span><br><span class="line"><span class="params"><span class="function">        RequestManager requestManager,</span></span></span><br><span class="line"><span class="params"><span class="function">        Class&lt;TranscodeType&gt; transcodeClass,</span></span></span><br><span class="line"><span class="params"><span class="function">        Context context)</span> </span>&#123;</span><br><span class="line">      ----</span><br><span class="line">      apply(requestManager.getDefaultRequestOptions());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>其他都是浮云.重点是<code>RequestBuilder</code>的构造函数里面的<code>apply</code>方法.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">apply</span><span class="params">(<span class="meta">@NonNull</span> BaseRequestOptions&lt;?&gt; o)</span> </span>&#123;</span><br><span class="line">  BaseRequestOptions&lt;?&gt; other = o;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, SIZE_MULTIPLIER)) &#123;</span><br><span class="line">    sizeMultiplier = other.sizeMultiplier;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, USE_UNLIMITED_SOURCE_GENERATORS_POOL)) &#123;</span><br><span class="line">    useUnlimitedSourceGeneratorsPool = other.useUnlimitedSourceGeneratorsPool;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, USE_ANIMATION_POOL)) &#123;</span><br><span class="line">    useAnimationPool = other.useAnimationPool;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, DISK_CACHE_STRATEGY)) &#123;</span><br><span class="line">    diskCacheStrategy = other.diskCacheStrategy;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, PRIORITY)) &#123;</span><br><span class="line">    priority = other.priority;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, ERROR_PLACEHOLDER)) &#123;</span><br><span class="line">    errorPlaceholder = other.errorPlaceholder;</span><br><span class="line">    errorId = <span class="number">0</span>;</span><br><span class="line">    fields &amp;= ~ERROR_ID;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, ERROR_ID)) &#123;</span><br><span class="line">    errorId = other.errorId;</span><br><span class="line">    errorPlaceholder = <span class="keyword">null</span>;</span><br><span class="line">    fields &amp;= ~ERROR_PLACEHOLDER;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, PLACEHOLDER)) &#123;</span><br><span class="line">    placeholderDrawable = other.placeholderDrawable;</span><br><span class="line">    placeholderId = <span class="number">0</span>;</span><br><span class="line">    fields &amp;= ~PLACEHOLDER_ID;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, PLACEHOLDER_ID)) &#123;</span><br><span class="line">    placeholderId = other.placeholderId;</span><br><span class="line">    placeholderDrawable = <span class="keyword">null</span>;</span><br><span class="line">    fields &amp;= ~PLACEHOLDER;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, IS_CACHEABLE)) &#123;</span><br><span class="line">    isCacheable = other.isCacheable;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, OVERRIDE)) &#123;</span><br><span class="line">    overrideWidth = other.overrideWidth;</span><br><span class="line">    overrideHeight = other.overrideHeight;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, SIGNATURE)) &#123;</span><br><span class="line">    signature = other.signature;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, RESOURCE_CLASS)) &#123;</span><br><span class="line">    resourceClass = other.resourceClass;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, FALLBACK)) &#123;</span><br><span class="line">    fallbackDrawable = other.fallbackDrawable;</span><br><span class="line">    fallbackId = <span class="number">0</span>;</span><br><span class="line">    fields &amp;= ~FALLBACK_ID;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, FALLBACK_ID)) &#123;</span><br><span class="line">    fallbackId = other.fallbackId;</span><br><span class="line">    fallbackDrawable = <span class="keyword">null</span>;</span><br><span class="line">    fields &amp;= ~FALLBACK;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, THEME)) &#123;</span><br><span class="line">    theme = other.theme;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, TRANSFORMATION_ALLOWED)) &#123;</span><br><span class="line">    isTransformationAllowed = other.isTransformationAllowed;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, TRANSFORMATION_REQUIRED)) &#123;</span><br><span class="line">    isTransformationRequired = other.isTransformationRequired;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, TRANSFORMATION)) &#123;</span><br><span class="line">    transformations.putAll(other.transformations);</span><br><span class="line">    isScaleOnlyOrNoTransform = other.isScaleOnlyOrNoTransform;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, ONLY_RETRIEVE_FROM_CACHE)) &#123;</span><br><span class="line">    onlyRetrieveFromCache = other.onlyRetrieveFromCache;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Applying options with dontTransform() is expected to clear our transformations.</span></span><br><span class="line">  <span class="keyword">if</span> (!isTransformationAllowed) &#123;</span><br><span class="line">    transformations.clear();</span><br><span class="line">    fields &amp;= ~TRANSFORMATION;</span><br><span class="line">    isTransformationRequired = <span class="keyword">false</span>;</span><br><span class="line">    fields &amp;= ~TRANSFORMATION_REQUIRED;</span><br><span class="line">    isScaleOnlyOrNoTransform = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fields |= other.fields;</span><br><span class="line">  options.putAll(other.options);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> selfOrThrowIfLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>可以看到<code>apply</code>方法就是一个拷贝的操作,他将<code>requestManager.getDefaultRequestOptions()</code>默认配置赋值给了新的<code>RequestBuilder</code>.所以我们可以操作的点出来了.<br>我们通过修改<code>getDefultRequestoptions</code>就可以实现修改全局的GLide加载属性了. 这里我拿修改Glide的编码格式为<code>DecodeFormat.PREFER_RGB_565</code>来举例.(应用场景:在手机内存太小的手机上,用来减少图片的内存占用).</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlideModule</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyGlideModule</span> : <span class="title">AppGlideModule</span>()</span>&#123;</span><br><span class="line">    <span class="function">override fun <span class="title">applyOptions</span><span class="params">(context: Context, builder: GlideBuilder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.applyOptions(context, builder)</span><br><span class="line">        val activityManager:ActivityManager = context.getSystemService(Context.ALARM_SERVICE) <span class="function">as ActivityManager</span></span><br><span class="line"><span class="function">        <span class="title">if</span><span class="params">(activityManager!=<span class="keyword">null</span>)</span></span>&#123;</span><br><span class="line">            <span class="keyword">var</span> memoryInfo = ActivityManager.MemoryInfo()</span><br><span class="line">            activityManager.getMemoryInfo(memoryInfo)</span><br><span class="line">            builder.setDefaultRequestOptions(RequestOptions().format(DecodeFormat.PREFER_RGB_565))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta-data</span><br><span class="line">    android:name=<span class="string">&quot;com.adventure.live.MyGlideModule&quot;</span></span><br><span class="line">    android:value=<span class="string">&quot;GlideModule&quot;</span> /&gt;</span><br></pre></td></tr></table></div></figure>
<p>实现方法就是继承<code>AppGlideModule</code>重写<code>applyOptions</code>方法.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/02/26/rebase%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0/">rebase命令学习</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-02-26</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-04-26</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h2 id="reword">
          <a href="#reword" class="heading-link"><i class="fas fa-link"></i></a><a href="#reword" class="headerlink" title="reword"></a>reword</h2>
      <p>修改你的提交信息.<br><strong>演示</strong><br>第一步:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase -i HEAD~2</span><br></pre></td></tr></table></div></figure>

<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/197a6ed491394b4f82b21799b49fe3cb~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>第二步:<br>将提交7前面的<code>pick</code>改成<code>reword</code></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e6259e1ca8c841c4b48971d71d375b41~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>然后键盘按 ctrl + x  </p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/07686d53cf434911a4e1684f0d7843dd~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>键盘按Y.然后再按 回车  </p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56a9f633acbf403f870ddc0ac0b85e2e~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>修改成:提交8,然后键盘输入 ctrl+x 在 按 y 在 按回车.</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2dae05397cf2406da7b59cabf32a4432~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>修改完成.</p>

        <h2 id="edit">
          <a href="#edit" class="heading-link"><i class="fas fa-link"></i></a><a href="#edit" class="headerlink" title="edit"></a>edit</h2>
      <p>看名字就是修改的意思.你可以修改任意位置已经提交的内容.<br><strong>演示</strong><br>首先提交两个:</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f64822aee134f9989ab941755676a1c~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>内容分别为:<br>第一次提交:</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>第二次提交:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Test &#123;</span><br><span class="line">    fun main()&#123;</span><br><span class="line">        print(&quot;111111&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>执行命令:<code>git rebase -i HEAD~2</code></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60c6b156aef04a799c4d786e22fbbb5a~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>比如我要修改第一次提交的内容.那就需要将第一个的pick改成edit:</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1993f551316c4c0dabfbb796cc4e748f~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>然后按 ctrl+x y 回车<br>这时候我的工作取回到了第一次提交的时候的样子:</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/64591bd534244e2dbab77f885f472a08~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>这时候我们修改下:<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a8740af59de24b339112c8cf9af0ea6f~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>修改完成后,就需要执行<code>git add .</code>表示保存这次修改.<br>然后执行commit操作.commit有两种方式</p>
<ul>
<li>–amend: 表示这次的提交内容还是会被保存在当前这个提交信息上</li>
<li>-m : 会新开一个提交</li>
</ul>
<p>这里我执行 <code>git commit --amend</code>  </p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e62e2104ae14f2b8e928e845eecf3e0~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>现在就需要执行<code>git rebase --continue</code>,表示继续下一个指令操作:</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e153c9f4413b447cab551127be29fd37~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>可以看到出现了合并冲突.我们需要解决下.<br>解决完继续执行<code>git add .  git commit --amend</code></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f12a531119b4937a2d3b92ffa6e510d~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>解决完成了合并冲突:<br>继续执行<code>git rebase --continue</code></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1abae7f6b5c41c0a4316b449fccf620~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>可以看到我们成功在第一次提交信息里面增加了信息.<br>如果将中途的<code>git commit --amend</code>换成<code>git commit -m 'cha'</code>会发现:</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fe6422c32c624c608421f47928412c58~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"></p>

        <h2 id="pick">
          <a href="#pick" class="heading-link"><i class="fas fa-link"></i></a><a href="#pick" class="headerlink" title="pick"></a>pick</h2>
      <p>这个代表着一次提交如果你删除了那行pick,那么你本地的全部提交都会被删除.谨慎删除.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/02/07/%E4%B8%BA%E4%BB%80%E4%B9%88onMeasure%E4%BC%9A%E8%A2%AB%E6%89%A7%E8%A1%8C%E4%B8%A4%E6%AC%A1/">为什么onMeasure会被执行两次</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-02-07</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-04-26</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="什么情况下会onMeasure会执行">
          <a href="#什么情况下会onMeasure会执行" class="heading-link"><i class="fas fa-link"></i></a><a href="#什么情况下会onMeasure会执行" class="headerlink" title="什么情况下会onMeasure会执行?"></a>什么情况下会<code>onMeasure</code>会执行?</h1>
      <p>进入<code>View</code>的<code>measure</code>方法:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">measure</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> forceLayout = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;</span><br><span class="line">    <span class="keyword">boolean</span> specChanged = widthMeasureSpec != mOldWidthMeasureSpec</span><br><span class="line">        || heightMeasureSpec != mOldHeightMeasureSpec;</span><br><span class="line">    <span class="keyword">boolean</span> isSepcExactly = MeasureSpec.getMode(widthMeasureSpec) == MeasureSpec.EXACTLY</span><br><span class="line">        &amp;&amp; MeasureSpec.getMode(heightMeasureSpec) == MeasureSpec.EXACTLY;</span><br><span class="line">    <span class="keyword">boolean</span> matchesSpecSize = getMeasuredWidth() == MeasureSpec.getSize(widthMeasureSpec)</span><br><span class="line">        &amp;&amp; getMeasuredHeight() == MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> needsLayout = specChanged</span><br><span class="line">        &amp;&amp; (sAlwaysRemeasureExactly || !isSpecExactly || !matchesSpecSize);</span><br><span class="line">    <span class="keyword">if</span>(forceLayout || needLayout)&#123;</span><br><span class="line">        <span class="keyword">int</span> cacheIndex = forceLayout ? -<span class="number">1</span> : mMeasureCache.indexOfKey(key);</span><br><span class="line">        <span class="keyword">if</span> (cacheIndex &lt; <span class="number">0</span> || sIgnoreMeasureCache) &#123;</span><br><span class="line">            onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">            mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> value = mMeasureCache.valueAt(cacheIndex);</span><br><span class="line">            setMeasuredDimensionRaw((<span class="keyword">int</span>) (value &gt;&gt; <span class="number">32</span>), (<span class="keyword">int</span>) value);</span><br><span class="line">            mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>什么时候<code>forceLayout=true</code>:</p>
<ol>
<li>调用<code>requestLayout</code></li>
<li>调用<code>forceRequestLayout</code></li>
</ol>
<p>什么时候<code>needsLayout=true</code>:</p>
<ol>
<li>当长宽发生改变</li>
</ol>
<p>什么时候调用了<code>onMeasure></code>方法:  </p>
<ol>
<li><code>forceLayouy=true</code></li>
<li>或者<code>mMeasureCache</code>没有当前的缓存</li>
</ol>
<p>所以总结:当调用了<code>requestLayout</code>一定会测发重测过程.当<code>forceLayout=false</code>的时候会去判断<code>mMeasureCache</code>值.现在研究下这个<code>mMeasureCache</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">View</span></span>&#123;</span><br><span class="line">    LongSparseLongArray mMeasureCache;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">measure</span><span class="params">(widthSpec,heightSpec)</span></span>&#123;</span><br><span class="line">        ---</span><br><span class="line">        <span class="keyword">long</span> key = (<span class="keyword">long</span>) widthMeasureSpec &lt;&lt; <span class="number">32</span> | (<span class="keyword">long</span>) heightMeasureSpec &amp; <span class="number">0xffffffffL</span>;</span><br><span class="line">        <span class="keyword">int</span> cacheIndex = forceLayout ? -<span class="number">1</span> : mMeasureCache.indexOfKey(key);</span><br><span class="line">        <span class="keyword">if</span>(cacheIndex&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            onMeasure(widthSpec,heightSpec);</span><br><span class="line">        &#125;</span><br><span class="line">   </span><br><span class="line">        mOldWidthMeasureSpec = widthMeasureSpec;</span><br><span class="line">        mOldHeightMeasureSpec = heightMeasureSpec;</span><br><span class="line">        mMeasureCache.put(key,widhSpec|heightSpec);</span><br><span class="line">        ---</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>这里可以看到<code>oldWidthMeasureSpec</code>和<code>mMeasureCache</code>都是缓存上一次的值,那他们有什么不同呢?不同点就是,<code>oldWidthMeasureSpec></code>不仅仅缓存了测量的<code>spec</code>模式而且缓存了<code>size</code>.但是<code>mMeasureCache</code>只缓存了<code>size</code>.从这行代码可以看出:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">long key = (long) widthMeasureSpec &lt;&lt; 32 | (long) heightMeasureSpec &amp; 0xffffffffL;</span><br></pre></td></tr></table></div></figure>
<p>这里一同运算就为了排除掉<code>spec</code>造成的影响.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不信你可以试下下面的代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> widthMeasureSpec = makeMeasureSpec(<span class="number">10</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">long</span> heightMeasureSpec =  makeMeasureSpec(<span class="number">20</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">long</span> ss = widthMeasureSpec &lt;&lt; <span class="number">32</span> | (<span class="keyword">long</span>) heightMeasureSpec &amp; <span class="number">0xffffffffL</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;==========&quot;</span>+ss);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_MASK = <span class="number">0x3</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">makeMeasureSpec</span><span class="params">(<span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (size &amp; ~MODE_MASK) | (mode &amp; MODE_MASK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//42949672980</span></span><br><span class="line"><span class="comment">//42949672980</span></span><br><span class="line"><span class="comment">//42949672980</span></span><br></pre></td></tr></table></div></figure>

<hr>

        <h1 id="什么时候mPrivateFlags会被赋值PFLAG-FORCE-LAYOUT">
          <a href="#什么时候mPrivateFlags会被赋值PFLAG-FORCE-LAYOUT" class="heading-link"><i class="fas fa-link"></i></a><a href="#什么时候mPrivateFlags会被赋值PFLAG-FORCE-LAYOUT" class="headerlink" title="什么时候mPrivateFlags会被赋值PFLAG_FORCE_LAYOUT."></a>什么时候<code>mPrivateFlags</code>会被赋值<code>PFLAG_FORCE_LAYOUT</code>.</h1>
      <p>在<code>view viewGrouup</code>的构造函数里面会主动赋值一次,然后在<Code>ViewGroup.addView时候会给当前<code>View</code>的<code>mProvateFlags</code>赋值<code>PFLAG_FORCE_LAYOUT</code>.</Code></p>
<hr>

        <h1 id="为什么onMeasure会被执行两次">
          <a href="#为什么onMeasure会被执行两次" class="heading-link"><i class="fas fa-link"></i></a><a href="#为什么onMeasure会被执行两次" class="headerlink" title="为什么onMeasure会被执行两次?"></a>为什么<code>onMeasure</code>会被执行两次?</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec,<span class="keyword">int</span> heightMeasureSpec)</span></span>&#123;</span><br><span class="line">    ----</span><br><span class="line">    <span class="keyword">boolean</span> forceLayout = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT; </span><br><span class="line">    <span class="keyword">if</span>(forceLayout | needsLayout)&#123;</span><br><span class="line">        onMeasure()</span><br><span class="line">    &#125;</span><br><span class="line">    ----</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    ---</span><br><span class="line">    mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</span><br><span class="line">    ---</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>在第一次触发到<code>measure</code>方法时,<code>forceLayoyt=true needsLayout=true</code>,但是<code>layout</code>方法还没触发到.<br>在第二次触发到<code>measure></code>方法时,<code>forceLayout=true needsLayout=false</code>,所以还是会进入<code>onMeasure</code>方法.这次会执行<code>layout</code>方法.然后我们在下次的时候<code>forceLayout</code>就等于<code>false</code>了.上面的这一段分析是分析的<code>measure</code>内部如何防止多次调用<code>onMeasure</code>.</p>
<p>现在分析外部是如何多次调用<Code>measure方法的:<br>在<code>Activity</code>执行到<code>onResume</code>生命周期的时候,会执行<code>WindowManager.addView</code>操作,<code>WindowManager</code>的具体实现类是<code>WindowManagerImpl</code>然后<code>addView</code>操作交给了代理类<code>WindowManagerGlobal</code>,然后在<code>WindowManagerGlobal</code>的<code>addView</code>里面执行了<code>ViewRootImpl.setView</code>操作(<code>ViewRootImpl</code>对象也是在这个时候创建的),在<code>ViewRootImpl</code>会主动调用一次<code>requestLayout</code>,也就开启了<strong>第一次</strong>的视图 测量 布局 绘制.  </Code></p>
<p>在<code>setView</code>的时候主动调用了一次<code>ViewRootImpl.requestLayout</code>,注意这个<code>requestLayout</code>是<code>ViewRootImpl</code>的内部方法,和<code>view viewGroup</code>那些<code>requestLayout</code>不一样.在<code>ViewRootImpl.requestLayout</code>内部调用了<code>performTraversals</code>方法:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewRootImpl</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(layoutResuested)&#123;</span><br><span class="line">        <span class="comment">//标记1</span></span><br><span class="line">            windowSizeMayChanged |= measureHierarchy(host,lp,res,desiredWindowWidth,desiredWindowHeight);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//标记2</span></span><br><span class="line">        performMeasure()</span><br><span class="line">        performLayout()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">measureHierarchy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        performMeasure()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>从<code>ViewRootImpl</code>的执行逻辑你可以看出,在执行<code>performLayout</code>之前,他自己就已经调用了两次<code>performMeasure</code>方法.所以你现在就知道为啥了.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/02/01/%E4%B8%8B%E8%BD%BD%E7%BC%96%E8%AF%91%E6%9F%A5%E7%9C%8BAndroid12%E6%BA%90%E7%A0%81/">下载编译查看Android12源码</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-02-01</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-04-26</span></span></div></header><div class="post-body"><div class="post-excerpt"><ol>
<li>安装repo<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/bin</span><br><span class="line">PATH=~/bin:$PATH</span><br><span class="line">curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo</span><br><span class="line">chmod a+x ~/bin/repo</span><br></pre></td></tr></table></div></figure>
这个时候的<code>repo</code>镜像还是国外的下载会很慢,需要换成国内的.打开 <code>/home/yu/bin/repo</code>文件修改字段<code>REPO_URL</code>值:<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/">https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ol>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c1c09d43b6014ba4b403f21cb2ef2867~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<ol start="2">
<li><p>下载<br>新建一个放源码的目录,然后在目录下执行这个命令:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo init -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest -b android-11.0.0_r1</span><br></pre></td></tr></table></div></figure>
<p>(选择要下载的源码分支可以查看这个<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://source.android.com/docs/setup/about/build-numbers?hl=zh-cn#source-code-tags-and-builds">网站</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>)</p>
</li>
<li><p>同步源码树:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo sync</span><br></pre></td></tr></table></div></figure>
<p>下载完成后的样子:</p>
</li>
</ol>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ec50996403bd46948a4be2981705a51c~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"></p>
<ol start="4">
<li>编译  </li>
<li><ol>
<li>初始化编译环境 <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br></pre></td></tr></table></div></figure></li>
</ol>
</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.2. 选择产品<br>(由于我这的产品没有<code>sdk_phone_x86_64-eng</code>,我需要自己添加个,修改文件<code>build/make/target/product/AndroidProducts.mk</code>,添加<code>sdk_phone_x86_64-eng</code>)</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2cc754364b1646d7a78e7ffa816ad78a~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>选择产品:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lunch sdk_phone_x86_64-eng</span><br></pre></td></tr></table></div></figure>

<ol start="5">
<li><p>启动虚拟机:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emulator</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>AndroidStudio</code>导入源码:  </p>
</li>
<li><p>1: 首先执行命令<code><br>mmm development/tools/idegen</code>会生成<code>idegen.jar</code>文件.  </p>
</li>
<li><p>2: 执行命令<code>./development/tools/idegen/idegen.sh</code>这时候会生成文件<code>android.ipr</code></p>
</li>
</ol>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b6a882d829044fa689e61181e9f84ff7~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>我们用As打开这个文件就可以看Andoid源码了.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/02/01/Recycleview%E7%9A%84%E8%87%AA%E9%97%AE%E8%87%AA%E7%AD%94/">Recycleview的自问自答</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-02-01</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-04-26</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="RecycledView四级缓存的生命周期">
          <a href="#RecycledView四级缓存的生命周期" class="heading-link"><i class="fas fa-link"></i></a><a href="#RecycledView四级缓存的生命周期" class="headerlink" title="RecycledView四级缓存的生命周期"></a>RecycledView四级缓存的生命周期</h1>
      <ol>
<li><code>mAttachedScrap</code>,他的数据随着一次<code>layout</code>从无到有再到无.</li>
</ol>
<p><strong>从无到有 -&gt;</strong>  </p>
<p>执行<code>layoutChildren</code>时候,会执行<code>detachAndScrapAttachViews()</code>方法,当<code>viewholder.flag</code>!=<code>INVALID</code> &amp;&amp; <code>!viewHolder.isRemoved()</code> &amp;&amp; <code>!mRecyclerView.mAdapter.hasStableIds()</code>的时候,当前的<code>ViewHodler</code>就会被添加进入<code>mAttachedScrap</code></p>
<p><strong>从有到无 -&gt;</strong></p>
<p>在<code>layoutChunk</code>阶段,从<code>mAttachedScrap</code>拿到对应的<code>ViewHolder</code>后,执行<code>addView</code>操作完成后,当前<code>ViewHodler</code>就会从<code>mAttachedScrao</code>里面进行移除.</p>
<p>所以<code>mAttachedScrap</code>的值随着一次布局从存在到消失.</p>
<ol start="2">
<li><p><code>mCachedView</code>生命周期.在滑动的是动态添加和移除.然后在调用<code>notifyDataSetChanged</code>时候会被清空.</p>
</li>
<li><p><code>RecycledViewPool</code>生命周期.添加进去就会一直存在.</p>
</li>
</ol>
<hr>

        <h1 id="Recycleview获取ViewHolder顺序">
          <a href="#Recycleview获取ViewHolder顺序" class="heading-link"><i class="fas fa-link"></i></a><a href="#Recycleview获取ViewHolder顺序" class="headerlink" title="Recycleview获取ViewHolder顺序:"></a><code>Recycleview</code>获取<code>ViewHolder</code>顺序:</h1>
      <ol>
<li>如果当前<code>Recycleview.State.isPreLayout()==true</code>则先从<code>mChangedScrap</code>数组里面获取,然后会将获取到的<code>ViewHolder</code>的<code>Flag</code>赋值为<code>FLAG_RETURNED_FROM_SCRAP</code>.<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ViewHolder <span class="title">tryGetViewHolderForPositionByDeadline</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(mState.isPreLayout())&#123;</span><br><span class="line">        holder = mChangedScrap.get(position);</span><br><span class="line">        holder.addFlags(ViewHolder.FLAG_RETURNED_FROM_SCRAP);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li>从<code>mAttachedScrap</code>数组获取,还会将获取到的<code>ViewHolder</code>的<code>flag</code>赋值为<code>FLAG_RETURNED_FROM_SCRAP</code><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ViewHolder <span class="title">tryGetViewHolderForPositionByDeadline</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">    ----</span><br><span class="line">    holder = mAttachedScrap.get(position)</span><br><span class="line">    holder.addFlags(ViewHolder.FLAG_RETURNED_FROM_SCRAP);</span><br><span class="line">    ----</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li>从<code>ChildHelper.mHiddenViews</code>数组获取</li>
<li>从<code>mCachedViews</code>获取,获取完后会从<code>mCachedViews</code>里面移除当前对他的缓存<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ViewHolder <span class="title">tryGetViewHolderForPositionByDeadline</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">    ----</span><br><span class="line">    holder = mCachedViews.get(position);</span><br><span class="line">    ----</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li>从<code>mViewCacheExtenstion</code>获取,这个需要开发者自行实现</li>
<li>从<code>recycledViewPool</code>获取,需要注意,从这里获取的<code>viewHolder</code>会进行一个重置操作,重置内容如下:<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">resetInternal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mFlags = <span class="number">0</span>;</span><br><span class="line">        mPosition = NO_POSITION;</span><br><span class="line">        mOldPosition = NO_POSITION;</span><br><span class="line">        mItemId = NO_ID;</span><br><span class="line">        mPreLayoutPosition = NO_POSITION;</span><br><span class="line">        mIsRecyclableCount = <span class="number">0</span>;</span><br><span class="line">        mShadowedHolder = <span class="keyword">null</span>;</span><br><span class="line">        mShadowingHolder = <span class="keyword">null</span>;</span><br><span class="line">        clearPayload();</span><br><span class="line">        mWasImportantForAccessibilityBeforeHidden = ViewCompat.IMPORTANT_FOR_ACCESSIBILITY_AUTO;</span><br><span class="line">        mPendingAccessibilityState = PENDING_ACCESSIBILITY_STATE_NOT_SET;</span><br><span class="line">        clearNestedRecyclerViewIfNotNested(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
所有的缓存里面,只有从<code>RecycledViewPool</code>里面获取的<code>ViewHolder</code>需要重新执行<code>bind</code>操作.<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ViewHolder tryGetViewHolderForPositionByDeadline(int position)&#123;</span><br><span class="line">    ----</span><br><span class="line">    holder = getRecycledViewPool.getRecycledView(type);</span><br><span class="line">    holder.resetInternal();</span><br><span class="line">    ----</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li>缓存里面还没拿到<code>ViewHolder</code>的话就去执行<code>createViewHolder</code>操作.</li>
</ol>
<hr>

        <h1 id="Recycleview什么时候会执行bindViewHolder操作">
          <a href="#Recycleview什么时候会执行bindViewHolder操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#Recycleview什么时候会执行bindViewHolder操作" class="headerlink" title="Recycleview什么时候会执行bindViewHolder操作:"></a><code>Recycleview</code>什么时候会执行<code>bindViewHolder</code>操作:</h1>
      <p>在执行<code>bindViewHolder</code>方法前有个判断:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!holder.isBound() || holder.needsUpdate() || holder.isInvalid())&#123;</span><br><span class="line">    bindViewHolder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>holder.isBound() = true</code>是在执行过一次<code>bindViewHodler</code>后进行的赋值.在第一次布局的时候,所有的<code>ViewHolder</code>都会执行<code>bindViewHolder</code>操作.然后执行完<code>bindViewHodler</code>操作后,当前的<code>viewHodler</code>的<code>flag</code>会被赋值<code>FLAG_BOUND</code>.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bindViewHolder</span><span class="params">(ViewHodler holder,<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">    holder.position = positon;</span><br><span class="line">    holder.setFlags(ViewHolder.FLAG_BOUND,</span><br><span class="line">            ViewHolder.FLAG_BOUND | ViewHolder.FLAG_UPDATE | ViewHolder.FLAG_INVALID</span><br><span class="line">                    | ViewHolder.FLAG_ADAPTER_POSITION_UNKNOWN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>所以:</p>
<ol>
<li>第一次布局的时候会执行<code>bindViewHolder</code></li>
<li>从<code>RecycledViewPool</code>里面获取到的<code>ViewHolder</code>会重新执行<code>bind</code>,因为<code>RecycledViewPool</code>厘面的<code>viewHodler</code>的<code>flag</code>会被重置掉.</li>
<li>调用<code>notify</code>方法标记了需要更新的<code>viewHodler</code>他们的<code>flag</code>会带有<code>FLAG_UPDATE</code>.所以会重新执行<code>bind</code>操作.</li>
</ol>
<hr>

        <h1 id="为什么执行notifyDataSetChaged-所有的ViewHodler会重新执行bind操作-而执行notifyItemChanged-不会导致全部的viewHolder执行bind操作">
          <a href="#为什么执行notifyDataSetChaged-所有的ViewHodler会重新执行bind操作-而执行notifyItemChanged-不会导致全部的viewHolder执行bind操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#为什么执行notifyDataSetChaged-所有的ViewHodler会重新执行bind操作-而执行notifyItemChanged-不会导致全部的viewHolder执行bind操作" class="headerlink" title="为什么执行notifyDataSetChaged()所有的ViewHodler会重新执行bind操作,而执行notifyItemChanged()不会导致全部的viewHolder执行bind操作:"></a>为什么执行<code>notifyDataSetChaged()</code>所有的<code>ViewHodler</code>会重新执行<code>bind</code>操作,而执行<code>notifyItemChanged()</code>不会导致全部的<code>viewHolder</code>执行<code>bind操作</code>:</h1>
      <p>首先需要搞清楚哪些<code>ViewHolder</code>是需要执行<code>bind</code>操作的:</p>
<ol>
<li><code>flag</code>值没有<code>FLAG_BOUND</code>  </li>
<li><code>flag</code>值有<code>UPDATE</code>  </li>
<li><code>flag</code>值有<code>INVALID</code>  </li>
</ol>
<p>那哪些情况下<code>flag</code>会符合上面三种情况?</p>
<ol>
<li>从<code>RecycledViewPool</code>里获取到的<code>ViewHodler</code>,他们的<code>Flag</code>值都为0</li>
<li>调用了<code>notifyDataSetChanged</code>方法,导致在布局的时候,获取到的<code>ViewHodler</code>是从<code>RecycledViewPool</code>里面获取到的.</li>
<li>调用了<code>nofifyItemChanged</code>,他会将<code>flag</code>标记为<code>UPDATE</code></li>
</ol>
<p>所以上面这个问题就好回答了,因为调用<code>notifyDataSetChanged</code>会导致获取<code>viewHolder</code>的操作都从<code>RecycledViewPool</code>里面获取,所以所有的<code>viewHolder</code>都会重新执行<code>bind</code>操作.而调用<code>notifyItemChanged</code>方法,所有的<code>ViewHodler</code>都是从<code>mAttachedScrap</code>里面获取的,然后只有需要更新的<code>viewHodler</code>的<code>flag</code>等于<code>FLAG_UPDATE</code>.所以只有需要更新的才会执行<code>bind</code>操作.</p>
<hr>

        <h1 id="为什么调用notifyDataSetChanged更新视图的时候-会导致视图全部重新执行bind操作">
          <a href="#为什么调用notifyDataSetChanged更新视图的时候-会导致视图全部重新执行bind操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#为什么调用notifyDataSetChanged更新视图的时候-会导致视图全部重新执行bind操作" class="headerlink" title="为什么调用notifyDataSetChanged更新视图的时候,会导致视图全部重新执行bind操作."></a>为什么调用<code>notifyDataSetChanged</code>更新视图的时候,会导致视图全部重新执行<code>bind</code>操作.</h1>
      <p>要探究这个问题就需要去看<code>detachAndScrapAttachdViews()</code>方法.这个方法是在<code>layoutChildren</code>阶段执行的.这个方法在初学阶段你是看不懂的,更不会用了, 现在我来讲明白.<br>这个方法做的事情就是<strong>分离视图</strong>和<strong>缓存已经存在的<code>viewHodler</code></strong>.  </p>
<p>分离视图有两种选择:  </p>
<ol>
<li><code>removeView</code></li>
<li><code>detachViewFromParent</code></li>
</ol>
<p>缓存<code>viewHodler</code>有四种方法选择:</p>
<ol>
<li>存进<code>mCachedViews</code></li>
<li>存进<code>recycledViewPool</code></li>
<li>存进<code>mAttachedScrap</code></li>
<li>存进<code>mChangedScrap</code></li>
</ol>
 <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">detachAndScrapAttachdViews</span><span class="params">(Recycler recycler, <span class="keyword">int</span> index, View view)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">final</span> ViewHolder viewHolder = getChildViewHolderInt(view);</span><br><span class="line">           <span class="keyword">if</span> (viewHolder.isInvalid() &amp;&amp; !viewHolder.isRemoved()</span><br><span class="line">                   &amp;&amp; !mRecyclerView.mAdapter.hasStableIds()) &#123;</span><br><span class="line">                   <span class="comment">//情况1</span></span><br><span class="line">               removeViewAt(index);</span><br><span class="line">               addViewHolderToRecycledViewPool(holder)</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 情况2</span></span><br><span class="line">               detachViewAt(index);</span><br><span class="line">              <span class="keyword">if</span>(flag == removed || falg == Invalid || !flag==update)&#123;</span><br><span class="line">                  mAttachedScrap.add(hodler)</span><br><span class="line">              &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                  mChangedScrap.add(hodler)</span><br><span class="line">              &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></div></figure>
<p> 我们在调用<code>notifyDataSetChanged</code>的时候,他会将我们的所有的<code>viewHodler</code>的<code>flag</code>设置为<code>invalid 和 update</code>并且清空了<code>mCachedViews</code>缓存,就导致在方法<code>detachedAndScrapAttachViews</code>时候符合情况1,将当前的全部<code>ViewHodler</code>缓存进了<code>RecycledViewPool</code>里面.所以就导致执行更新时,会重新都走一遍<code>bind</code>操作.<br> 所以我们要少用<code>notifyDataSetChanged</code>方法,他在回收的时候执行的是<code>removeView</code>操作,是一个很重的操作,然后所有的ViewHodler也会被保存进<code>RecycledViewPool</code>里面,而不是<code>mRecycledScrap</code>里面,就导致还会重新走一遍<code>bind</code>操作,增加了页面更新的时间.</p>
<hr>

        <h1 id="Recycleview里面分割线的实现原理">
          <a href="#Recycleview里面分割线的实现原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#Recycleview里面分割线的实现原理" class="headerlink" title="Recycleview里面分割线的实现原理"></a>Recycleview里面分割线的实现原理</h1>
      <p><code>Recycleview</code>的分割线是单独画上去的,在<code>draw</code>阶段画的,所以他的层次要高于<code>ViewHolder</code>,因为他是晚于<code>ViewHolder</code>绘制.  </p>
<p>看下测量阶段:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Recycleview</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">LayoutManager</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,<span class="keyword">int</span> widthUsed,<span class="keyword">int</span> heightUsed)</span></span>&#123;</span><br><span class="line">         <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</span><br><span class="line"><span class="comment">//标记1</span></span><br><span class="line">            <span class="keyword">final</span> Rect insets = mRecyclerView.getItemDecorInsetsForChild(child);</span><br><span class="line">            widthUsed += insets.left + insets.right;</span><br><span class="line">            heightUsed += insets.top + insets.bottom;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> widthSpec = getChildMeasureSpec(getWidth(), getWidthMode(),</span><br><span class="line">                    getPaddingLeft() + getPaddingRight()</span><br><span class="line">                            + lp.leftMargin + lp.rightMargin + widthUsed, lp.width,</span><br><span class="line">                    canScrollHorizontally());</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> heightSpec = getChildMeasureSpec(getHeight(), getHeightMode(),</span><br><span class="line">                    getPaddingTop() + getPaddingBottom()</span><br><span class="line">                            + lp.topMargin + lp.bottomMargin + heightUsed, lp.height,</span><br><span class="line">                    canScrollVertically());</span><br><span class="line">            <span class="keyword">if</span> (shouldMeasureChild(child, widthSpec, heightSpec, lp)) &#123;</span><br><span class="line">                child.measure(widthSpec, heightSpec);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>在标记1的地方,可以看到去获取了我们分割线的大小.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Rect <span class="title">getItemDecorInsetsForChild</span><span class="params">(View child)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</span><br><span class="line">        <span class="keyword">if</span> (!lp.mInsetsDirty) &#123;</span><br><span class="line">            <span class="keyword">return</span> lp.mDecorInsets;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mState.isPreLayout() &amp;&amp; (lp.isItemChanged() || lp.isViewInvalid())) &#123;</span><br><span class="line">            <span class="keyword">return</span> lp.mDecorInsets;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> Rect insets = lp.mDecorInsets;</span><br><span class="line">        insets.set(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> decorCount = mItemDecorations.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; decorCount; i++) &#123;</span><br><span class="line">            mTempRect.set(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">           <span class="comment">//标记2</span></span><br><span class="line">            mItemDecorations.get(i).getItemOffsets(mTempRect, child, <span class="keyword">this</span>, mState);</span><br><span class="line">            insets.left += mTempRect.left;</span><br><span class="line">            insets.top += mTempRect.top;</span><br><span class="line">            insets.right += mTempRect.right;</span><br><span class="line">            insets.bottom += mTempRect.bottom;</span><br><span class="line">        &#125;</span><br><span class="line">        lp.mInsetsDirty = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> insets;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>在标记2的位置可以看到调用了<code>ItemDirection</code>的<code>getItemOffsets</code>方法,去获取每个<code>viewHolder</code>对应的边距.所以自定义<code>ItemDirection</code>的时候,需要你重写<code>getItemOffsets</code>方法.设置完的值会被保存在<code>layoutParams.mDecorInsets</code>里面.</p>
<p>大小获取完成了.现在就是布局了.再来看下布局:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinearLayoutManager</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">layoutChunk</span><span class="params">()</span></span>&#123;</span><br><span class="line">        layoutDecoratedWidthMargins(view,l,t,r,b);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layoutDecoratedWithMargins</span><span class="params">(<span class="meta">@NonNull</span> View child, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</span><br><span class="line">        <span class="keyword">final</span> Rect insets = lp.mDecorInsets;</span><br><span class="line">        child.layout(left + insets.left + lp.leftMargin, top + insets.top + lp.topMargin,</span><br><span class="line">                right - insets.right - lp.rightMargin,</span><br><span class="line">                bottom - insets.bottom - lp.bottomMargin);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>可以看到通过<code>layoutParams</code>去获取了<code>mDecorInsets</code>值.这是我们在<code>measure</code>设置进去的.</p>
<p>综上所述,分析了<code>Recycleview</code>的分割线实现原理.</p>
<hr>

        <h1 id="recycleview获取ViewHolder的方法">
          <a href="#recycleview获取ViewHolder的方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#recycleview获取ViewHolder的方法" class="headerlink" title="recycleview获取ViewHolder的方法:"></a>recycleview获取ViewHolder的方法:</h1>
      <ol>
<li><code>Recycleview</code>的成员方法<code>findViewHolderForPosition(postion)</code></li>
<li><code>Recycleview</code>的成员方法<code>findViewHolderForLayoutPosition(position)</code></li>
<li><code>Recycleview</code>的成员方法<code>findViewHolderforAdapterPosition(position)</code></li>
<li><code>Recycleview</code>的成员方法<code>findViewHolderForItemId(id)</code></li>
</ol>
<p>区别:1 和 2 是一样子的. 2 和 3是不一样的.<br><code>findViewHolderForLayoutPosition</code>获取的是<code>holder.layoutPosition</code>值.<code>findViewHolderforAdapterPosition</code>获取的是<code>holder.position</code>值.<br>那现在问题来了,<code>ViewHolder</code>里的<code>position和mPreLayoutPosition</code>他们都表示位置信息,那有什么区别呢?<br>区别在,<code>mPreLayoutPosition</code>获取的是当前此刻<code>viewHolder</code>在的位置.而<code>position</code>代表这次<code>onLayout</code>结束后这个<code>viewholder</code>的位置.这个值会更准确.  </p>
<p>我们可以来看下源码:<br><strong>首先看<code>findViewHolderForLayoutPosition</code>:</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ViewHolder <span class="title">findViewHolderForLayoutPosition</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> findViewHolderForPosition(position, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">ViewHolder <span class="title">findViewHolderForPosition</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span> checkNewPosition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = mChildHelper.getUnfilteredChildCount();</span><br><span class="line">        ViewHolder hidden = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> ViewHolder holder = getChildViewHolderInt(mChildHelper.getUnfilteredChildAt(i));</span><br><span class="line">            <span class="keyword">if</span> (holder != <span class="keyword">null</span> &amp;&amp; !holder.isRemoved()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (checkNewPosition) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (holder.mPosition != position) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (holder.getLayoutPosition() != position) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mChildHelper.isHidden(holder.itemView)) &#123;</span><br><span class="line">                    hidden = holder;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> holder;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hidden;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>可以看到默认<code>checkNewPostion</code>传的就是<code>false</code>,表示不检查新位置,直接返回当前<code>mPreLayoutPosition</code>等于目标值的<code>viewHolder</code></p>
<p>再来看看<code>findViewHolderForAdapterPosition</code>:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ViewHolder <span class="title">findViewHolderForAdapterPosition</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mDataSetHasChangedAfterLayout) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = mChildHelper.getUnfilteredChildCount();</span><br><span class="line">        ViewHolder hidden = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> ViewHolder holder = getChildViewHolderInt(mChildHelper.getUnfilteredChildAt(i));</span><br><span class="line">            <span class="keyword">if</span> (holder != <span class="keyword">null</span> &amp;&amp; !holder.isRemoved()</span><br><span class="line">                    &amp;&amp; getAdapterPositionFor(holder) == position) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mChildHelper.isHidden(holder.itemView)) &#123;</span><br><span class="line">                    hidden = holder;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> holder;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hidden;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>可以看到当<code>mDataSetHasChangedAfterLayout</code>为<code>true</code>的时候会返回<code>null</code>,那什么时候这个值会为<code>true</code>呢,在<code>adapter</code>调用方法<code>notifyDataSetHasChanged</code>的时候,会赋值他为<code>true</code>.然后在看方法<code>getAdapterPositionfor(viewHolder)</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getAdapterPositionFor</span><span class="params">(ViewHolder viewHolder)</span> </span>&#123;</span><br><span class="line">    mAdapterHelper.applyPendingUpdatesToPosition(viewHolder.mPosition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">applyPendingUpdatesToPosition</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = mPendingUpdates.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        UpdateOp op = mPendingUpdates.get(i);</span><br><span class="line">        <span class="keyword">switch</span> (op.cmd) &#123;</span><br><span class="line">            <span class="keyword">case</span> UpdateOp.ADD:</span><br><span class="line">                <span class="keyword">if</span> (op.positionStart &lt;= position) &#123;</span><br><span class="line">                    position += op.itemCount;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> UpdateOp.REMOVE:</span><br><span class="line">                <span class="keyword">if</span> (op.positionStart &lt;= position) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> end = op.positionStart + op.itemCount;</span><br><span class="line">                    <span class="keyword">if</span> (end &gt; position) &#123;</span><br><span class="line">                        <span class="keyword">return</span> RecyclerView.NO_POSITION;</span><br><span class="line">                    &#125;</span><br><span class="line">                    position -= op.itemCount;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> UpdateOp.MOVE:</span><br><span class="line">                <span class="keyword">if</span> (op.positionStart == position) &#123;</span><br><span class="line">                    position = op.itemCount; <span class="comment">//position end</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (op.positionStart &lt; position) &#123;</span><br><span class="line">                        position -= <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (op.itemCount &lt;= position) &#123;</span><br><span class="line">                        position += <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> position;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>可以看到内部调用了方法<Code>applyPendingUpdatesToPosition翻译下:执行内部位置更新操作.里面涉及到了数组<code>mPendingUpdates</code>,这个数组在我们执行<code>notifyItemInserted  notifyItemMoved  notifyItemRangeChanged</code>方法的时候会生成操作对象然后存入到<Code>mPendingUpdates数组里面….然后在我们获取<code>viewHolder.position</code>的时候,这时候会考虑到在执行更新操作的时候是否影响到了当前我们的<code>viewHolder</code>如果影响到了,就根具具体的操作去获取这次操作结束后的位置.  这就印证了我上面讲的,<code>findViewHodlerforAdapterPostion</code>获取的位置是这次<coed>onLayout结束后的位置.<code>findViewHolderForLayoutPosition</code>获取的是当前<code>viewHolder</code>的位置.</coed></Code></Code></p>

        <h1 id="分析下Recycleview的dispatchLayout1">
          <a href="#分析下Recycleview的dispatchLayout1" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析下Recycleview的dispatchLayout1" class="headerlink" title="分析下Recycleview的dispatchLayout1"></a>分析下Recycleview的dispatchLayout1</h1>
      <p>关于<code>Recycleview</code>的布局分为三个阶段:<code>dispatchLayout1()  dispatchLayout2  dispatchLayout3()</code>.先分析下<code>dispatchLayout1()</code>:  </p>
<ul>
<li>看下<code>processAdapterUpdatesAndSetAnimationFlags</code>方法:<br>这个方法会遍历数组<code>mPendingUpdates</code>数组,(这个数组存的是我们在执行<code>nofityItemInserted</code>等更新方法时候的操作),比如我们执行了一个插入更新操作,那么在<code>dispatchLayout1()</code>阶段遍历这个数组的目的就是更新所有因为这个插入操作而导致的位置更新的<code>viewHolder</code><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postponeAndUpdateViewHolders</span><span class="params">(UpdateOp op)</span> </span>&#123;</span><br><span class="line">        mPostponedList.add(op);</span><br><span class="line">        <span class="keyword">switch</span> (op.cmd) &#123;</span><br><span class="line">            <span class="keyword">case</span> UpdateOp.ADD:</span><br><span class="line">                mCallback.offsetPositionsForAdd(op.positionStart, op.itemCount);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> UpdateOp.MOVE:</span><br><span class="line">                mCallback.offsetPositionsForMove(op.positionStart, op.itemCount);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> UpdateOp.REMOVE:</span><br><span class="line">                mCallback.offsetPositionsForRemovingLaidOutOrNewView(op.positionStart,</span><br><span class="line">                        op.itemCount);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> UpdateOp.UPDATE:</span><br><span class="line">                mCallback.markViewHoldersUpdated(op.positionStart, op.itemCount, op.payload);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unknown update op type for &quot;</span> + op);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offsetPositionsForAdd</span><span class="params">(<span class="keyword">int</span> positionStart, <span class="keyword">int</span> itemCount)</span> </span>&#123;</span><br><span class="line">    offsetPositionRecordsForInsert(positionStart, itemCount);</span><br><span class="line">    mItemsAddedOrRemoved = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">offsetPositionRecordsForInsert</span><span class="params">(<span class="keyword">int</span> positionStart, <span class="keyword">int</span> itemCount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = mChildHelper.getUnfilteredChildCount();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> ViewHolder holder = getChildViewHolderInt(mChildHelper.getUnfilteredChildAt(i));</span><br><span class="line">            <span class="keyword">if</span> (holder != <span class="keyword">null</span> &amp;&amp; !holder.shouldIgnore() &amp;&amp; holder.mPosition &gt;= positionStart) &#123;</span><br><span class="line">               <span class="comment">//去更新viewHolder的position值</span></span><br><span class="line">               holder.offsetPosition(itemCount, <span class="keyword">false</span>);</span><br><span class="line">                mState.mStructureChanged = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mRecycler.offsetPositionRecordsForInsert(positionStart, itemCount);</span><br><span class="line">        requestLayout();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
<ul>
<li><p>看下方法<code>findMinMaxChildLayoutPositons(int info)</code>:<br>在<code>Recycleview</code>里有一个成员属性<code>int[] mMinMaxLayoutPosition</code>这个属性保存了<code>Recycleview</code>在屏幕上可以显示的最小和最大的<code>item</code>值.帮助<code>Recycleview</code>在滑动的时候确定要显示哪些<code>item</code>,以提高滑动的流畅性.这个值在<code>dispatchLayout1</code>阶段会去修改:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findMinMaxChildLayoutPositions</span><span class="params">(<span class="keyword">int</span>[] into)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = mChildHelper.getChildCount();</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        into[<span class="number">0</span>] = NO_POSITION;</span><br><span class="line">        into[<span class="number">1</span>] = NO_POSITION;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> minPositionPreLayout = Integer.MAX_VALUE;</span><br><span class="line">    <span class="keyword">int</span> maxPositionPreLayout = Integer.MIN_VALUE;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">        <span class="keyword">final</span> ViewHolder holder = getChildViewHolderInt(mChildHelper.getChildAt(i));</span><br><span class="line">        <span class="keyword">if</span> (holder.shouldIgnore()) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> pos = holder.getLayoutPosition();</span><br><span class="line">        <span class="keyword">if</span> (pos &lt; minPositionPreLayout) &#123;</span><br><span class="line">            minPositionPreLayout = pos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pos &gt; maxPositionPreLayout) &#123;</span><br><span class="line">            maxPositionPreLayout = pos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    into[<span class="number">0</span>] = minPositionPreLayout;</span><br><span class="line">    into[<span class="number">1</span>] = maxPositionPreLayout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>可以看到遍历了当前屏幕上的所有孩子,找到他们的最小值和最大值.</p>
</li>
<li><p>继续看<code>dispatchLayout1</code>方法,现在看的是<code>Recycleview</code>如何标记哪些是需要执行动画操作的<code>view</code>.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Recycleview</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchLayout1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ***</span><br><span class="line">        <span class="keyword">if</span>(mState.mRunSimpleAnimatioms)&#123;</span><br><span class="line">        <span class="comment">//情况1</span></span><br><span class="line">            <span class="keyword">int</span> count = mChildHelper.getChildCount();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i)&#123;</span><br><span class="line">                ViewHolder holder = getChildViewHolderInt(mChildHelper.getChildAt(i));</span><br><span class="line">                ***</span><br><span class="line">                ItemHolderInfo animationInfo = mItemAnimator.recordPreLayoutInformation(mState,holder,flag,holder.getImodifiedPayloads());</span><br><span class="line">                mViewInfoStore.addToPreLayout(holder,animationInfo);</span><br><span class="line">                ***</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mState.mRunPredictiveAnimations)&#123;</span><br><span class="line">            <span class="comment">//情况2</span></span><br><span class="line">            saveOldPositions();</span><br><span class="line">            mLayout.onLayoutChildren(mRecycler,mState);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mChildHelper.getChildCount(); ++i)&#123;</span><br><span class="line">                View child = mChildHelper.getChildAt(i);</span><br><span class="line">                ViewHolder viewHolder.getChildViewHolderInt(child);</span><br><span class="line">            </span><br><span class="line"> <span class="comment">//在刚才的预布局里面没找到这个viewholder说明这是新建的viewholder,是需要执行动画的viewholder</span></span><br><span class="line">                <span class="keyword">if</span>(!mViewInfoStore.isInPreLayout(viewHolder))&#123;</span><br><span class="line">                mViewInfoStore.addToAppearedInPreLayoutHolders(viewHolder,animationInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        ***</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>首先先看<strong>情况1:</strong>,他遍历了当前页面上的所有孩子,然后给每个<code>viewHolder</code>创建了<code>ItemHolderInfo</code>对象,并且保存在了<code>viewInfoStore</code>的<code>mLayoutHolderMap</code>里面,键名是<code>holder</code>键值是<code>InfoRecord</code>,这个时候每个<code>InfoRecord</code>的<code>flag</code>等于<strong>FLAG_PRE</strong>(从名字也可以看出是预布局的意思)</p>
</li>
</ul>
<p>再看<strong>情况2</strong>,他会去执行<code>layout.onLayoutChildren</code>进行一次布局,然后对比<strong>情况1</strong>看看多了哪些<code>ViewHolder</code>,这些多出来的<code>viewHolder</code>会被添加到<code>ViewInfoStore</code>里面然后<code>flag</code>会被赋值为<strong>FLAG_APPEAR</strong></p>
<p>到这里<code>dispatchLayout1</code>就分析完成了,他干了五件大事.</p>
<ul>
<li><p>第一件大事:<br>执行<code>processAdapterUpdatesAndSetAnimationFlags()</code>方法,遍历<code>mPendingUpdates</code>数组,修改页面上所有<code>viewHolder</code>的<code>position</code>数据,是增是减.然后给是否执行动画标志位进行赋值.</p>
</li>
<li><p>第二件大事:<br>给成员属性<code>mMinMaxLayoutPosition</code>赋值,找到目前显示的最大和最小<code>position</code>值</p>
</li>
<li><p>第三件大事:<br>将当前页面的所有<code>viewHolder</code>添加进了<code>viewInfoStore</code>里面然后设置<code>flag</code>等于<strong>FLAG_PRE</strong></p>
</li>
<li><p>第四件大事调用<code>layoutManager.onLayoutChildren()</code>,进去一次布局</p>
</li>
<li><p>第五件大事,遍历页面所有孩子,对比第三件大事里面的<code>mViewInfoStore</code>没有的<code>viewHolder</code>,然后将没有的<code>viewHodler</code>添加到<code>viewInfoStore</code>里面.并且设置<code>flag</code>等于<strong>FLAG_APPEAR</strong></p>
</li>
</ul>

        <h1 id="分析下Recycleview的dispatchLayoutSetp2">
          <a href="#分析下Recycleview的dispatchLayoutSetp2" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析下Recycleview的dispatchLayoutSetp2" class="headerlink" title="分析下Recycleview的dispatchLayoutSetp2()"></a>分析下Recycleview的dispatchLayoutSetp2()</h1>
      
        <h1 id="Recycleview中AnchorInfo的作用">
          <a href="#Recycleview中AnchorInfo的作用" class="heading-link"><i class="fas fa-link"></i></a><a href="#Recycleview中AnchorInfo的作用" class="headerlink" title="Recycleview中AnchorInfo的作用"></a>Recycleview中AnchorInfo的作用</h1>
      <p><code>AnchorInfo</code>用于记录<code>Recycleview</code>的滚动状态,</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/02/01/%E5%85%B3%E4%BA%8EAdapter%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E7%9A%84%E5%88%86%E6%9E%90/">关于Adapter进行数据更新的分析</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-02-01</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-04-26</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="调用notifyDataSetChanged">
          <a href="#调用notifyDataSetChanged" class="heading-link"><i class="fas fa-link"></i></a><a href="#调用notifyDataSetChanged" class="headerlink" title="调用notifyDataSetChanged"></a>调用notifyDataSetChanged</h1>
      <p>这是一个全局更新:</p>
<ol>
<li>他会将所有的<code>ViewHolder</code>的<code>flag</code>设为<code>ViewHolder.FLAG_UPDATE|ViewHolder.FLAG_INVALID</code>,</li>
<li>他会将所有的<code>View.LayoutParams</code>的<code>mInstesDirty</code>设置为<code>true</code>,代表这些数据都脏了.</li>
<li>将所有的<code>Recycler.mCachedViews</code>缓存的<code>ViewHodler</code>对应的<code>View.LayoutParams</code>的<code>mInsetsDirty</code>赋值为true.</li>
<li>将<Code>mCachedViews缓存的所有<code>ViewHolder</code>的<code>flag</code>赋值为<code>ViewHolder.FLAG_UPDATE|ViewHolder.FLAG_INVALID</code></Code></li>
<li>如果<code>mAdapter.mHasStableIds</code>等于<code>false</code>(默认都是false,除非你自己去改了),还会移除<code>mCachedViews</code>所有的缓存数据,移除的数据会被添加到<code>RecycledViewPool</code>里面.  </li>
</ol>
<p>上述所有事情做完会调用<code>requestLayout</code>重新开始布局.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Adapter</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">notifyDataSetChanged</span><span class="params">()</span></span>&#123;</span><br><span class="line">        mState.mStructureChanged = <span class="keyword">true</span>;</span><br><span class="line">        mDispatchItemsChangedEvent = <span class="keyword">true</span>;</span><br><span class="line">        mDataSetHasChangedAfterLayout = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//遍历所有的viewholder,将他们的flag设置为update和invalid</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = mChildHelper.getUnfilteredChildCount();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> ViewHolder holder = getChildViewHolderInt(mChildHelper.getUnfilteredChildAt(i));</span><br><span class="line">            <span class="keyword">if</span> (holder != <span class="keyword">null</span> &amp;&amp; !holder.shouldIgnore()) &#123;</span><br><span class="line">                holder.addFlags(ViewHolder.FLAG_UPDATE | ViewHolder.FLAG_INVALID);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ----还有很多代码----</span><br><span class="line">        ----具体代码详见Adapter.processDataSetCompletelyChanged----</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>这里有一点很重要,在执行<code>notifyDataSetChanged</code>方法的时候,会去<strong>修改成员变量</strong></p>
<ul>
<li><code>mState.mStructureChanged</code></li>
<li><code>mDispatchItemChangedEvent</code></li>
<li><code>mDataSetHasChangedAfterLayout</code><br>这几个参数在执行<code>layout</code>的时候很重要,这几个值也只有在执行方法<Code>notifyDataSetChanged的时候才会被赋值为<code>true</code>. 当<code>mDataSetHasChangedAfterLayout</code>为<code>true</code>的时候,<Code>recycleview将不会执行简单动画和预加载动画.  </Code></Code></li>
</ul>
<p><code>notifyDataSetChanged</code>和<code>notifyItemChanged</code>的<strong>区别</strong>就是:</p>
<ul>
<li><code>notifyDataSetChanged</code>会立马将所有的viewHolder设置为更新状态和无效状态,并且删除了所有<code>mCachedViews</code>数组里面的数据</li>
<li><code>notifyItemChanged</code>会设置<code>mAdapterUpdateDuringMeasure</code>为true.然后在<code>onMeasure</code>阶段将变化的<code>viewHolder</code>设置为更新或者移除或者无用等等状态.实现原理就是会将操作保存到<code>mPendingUpdates</code>数组里面,然后在<code>onMeasure</code>阶段遍历数组进行对<code>ViewHolder</code>的flag修改.  </li>
<li><code>notifyDataSetChanged</code>不会有动画效果</li>
<li><code>notifyItemChanged</code>会有动画效果</li>
</ul>
</blockquote>
<p>在调用全局更新的时候不会用到<code>AdapterHelper.mPendingUpdates</code>数组.<br>现在继续看调用<code>notifyDataSetChanged</code>时触发的<code>requestLayout</code>.<br>进入<code>onMeasure</code>方法:  </p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Recycleview</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthSpec,<span class="keyword">int</span> heightSpec)</span></span>&#123;</span><br><span class="line">        <span class="comment">//这个参数在调用notifyDataSetChanged()时是false</span></span><br><span class="line">        <span class="comment">//调用其他的更新方法比如notifyItemChanged(int position)的时候会被赋值为true</span></span><br><span class="line">        <span class="keyword">if</span>(mAdapterUpdateDuringMeasure)&#123;</span><br><span class="line">            <span class="comment">//所以这里为false不会进来</span></span><br><span class="line">            <span class="comment">//我就不放代码了</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//会进这里</span></span><br><span class="line">            mLayout.onMeasure(mRecycler,mState,widthSpec,heightSpec)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>关于<code>notifyDatasetChanged</code>触发的<code>onMeasure</code>没有什么可以讲的,重点的是在通过<code>notifyItemChanged(int position)</code>触发的重新测量,这个下面讲,很重要.涉及到了<code>AdapterHelper.mPendingUpdates</code>数组的使用.  </p>
<p>进入<code>onLayout</code>方法.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Recycleview</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed,<span class="keyword">int</span> l,<span class="keyword">int</span> t,<span class="keyword">int</span> r,<span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">        dispatchLayout()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchLayout</span><span class="params">()</span></span>&#123;</span><br><span class="line">        dispatchLayout1()</span><br><span class="line">        dispatchLayout2()</span><br><span class="line">        dispatchLayout3()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchLayout1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        processAdapterUpdatesAndSetAnimationFlags();</span><br><span class="line">        mState.mInPreLayout = mState.mRunPredictiveAnimations;</span><br><span class="line">        <span class="keyword">if</span>(mState.mRunSimpleAnimations)&#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mState.mRunPredictiveAnimations)&#123;</span><br><span class="line">            mLayout.onLayoutChildren(mRecycler,mState)</span><br><span class="line">        &#125;</span><br><span class="line">        mState.mLayoutStep = State.STEP_LAYOUT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">processAdaterUpdatesAndSetAnimationFlags</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mDataSetHasChangedAfterLayout)&#123;</span><br><span class="line">            <span class="comment">//这里是一个重点,只有调用notifyDataSetChanged()方法的时候这个值才会被设置为true,调用notifyItemChanged()时这个值不会被修改为true.</span></span><br><span class="line">            mAdapterHelper.reset();<span class="comment">//清空mPendingUpdates和mPostponedList数组的数据</span></span><br><span class="line">            <span class="keyword">if</span>(mDispatchItemChangedEvent()&#123;</span><br><span class="line">            <span class="comment">//是否告诉Layout数据发生了改变,意思也就是开发者可以监听onItemsChanged方法来知道数据发生了改变</span></span><br><span class="line">                mLayout.onItemsChanged(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Recycleview是否设置了动画</span></span><br><span class="line">        <span class="comment">//由于这里走的是notifyDataSetChanged这条线,上面执行了reset操作,导致这里的mAdapterHelper的数组是空的</span></span><br><span class="line">        <span class="keyword">if</span>(predictiveItemAnimationsEnabled())&#123;</span><br><span class="line">        <span class="comment">//这方法其实就是在遍历AdapterHelper.mPendingUpdates数组,给viewHolder设置对应的flag值.</span></span><br><span class="line">            mAdapterHelper.preProcess();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="comment">//遍历AdapetHelper.mPendingUpdates数组,给对应的viewHolder设置对应的flag</span></span><br><span class="line">           mAdapterHelper.consumeUpdatesInOnePass();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//由于走的是全局更新所以mItemsAddedOrRemoved为false mItemsChanged也为false</span></span><br><span class="line">        <span class="keyword">boolean</span> animationTypeSupported = mItemsAddedOrRemoved || mItemsChanged;</span><br><span class="line">        <span class="comment">//mFirstLayoutComplete这个值只会在第一次完整的布局结束后才会赋值为true</span></span><br><span class="line">        mState.mRunSimpleAnimations = mFirstLayoutComplete</span><br><span class="line">                &amp;&amp; mItemAnimator != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (mDataSetHasChangedAfterLayout<span class="comment">//这个值我们看到了.他是在notifyDataSetChanged方法里面被赋值为了true</span></span><br><span class="line">                || animationTypeSupported</span><br><span class="line">                || mLayout.mRequestedSimpleAnimations)</span><br><span class="line">                &amp;&amp; (!mDataSetHasChangedAfterLayout</span><br><span class="line">                || mAdapter.hasStableIds());</span><br><span class="line">        mState.mRunPredictiveAnimations = mState.mRunSimpleAnimations</span><br><span class="line">                &amp;&amp; animationTypeSupported</span><br><span class="line">                &amp;&amp; !mDataSetHasChangedAfterLayout</span><br><span class="line">                &amp;&amp; predictiveItemAnimationsEnabled();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>由于这里探究的是<code>notifyDataSetChanged</code>方法,也就没有继续探究<code>mAdapterHelper.preprocess和mAdapterHepler.consumeUpdatesInOnepass</code>方法的必要了.因为进去了也是空的数组.为什么空,上面已经分析了. </p>
<p>上面用了很大的篇幅介绍了:<code>processAdapterUpdatesAndSetAnimationFlags()</code>方法,这个方法很重要:</p>
<ol>
<li>他遍历了数组<code>mPendingUpdates</code>也就是我们在执行更新操作<code>notify</code>时候存入的事件,遍历完的结果就是给对应的<code>ViewHolder</code>设置对应的<code>Flag</code>信息,并且这个时候我们也能在<code>LayoutManager</code>监听到<code>ViewHolder</code>的变化.</li>
<li>判断当前的<code>Layout</code>需不需要动画.需要动画的话会给<code>mState.mRunSimpleAnimations</code>和<code>mState.mRunPredictiveAnimations</code>赋值为<code>true</code></li>
</ol>
<p>分析完了<code>dispatchLayout1()</code>方法,你会发现这个方法就做了一件事情,预布局,全部都是为了动画.如果你没有动画的需求,<code>dispatchLayout1()</code>直接可以跳过了.并且在调用<code>notifyDataSetChanged</code>方法的情况下我们的<code>dispatchLayout1()</code>方法也没干什么事情,因为全局更新不需要动画.</p>
<p>这里探究过头了,<code>dispatchLayout1  displayLayout2  displayLayout3</code>不是我这里需要探究的.我现在需要探究的是,在调用<code>notifyDataSetChanged</code>的时候,他将所有的<code>ViewHolder</code>的<code>flag</code>值设置为了<code>ViewHolder.FLAG_UPDATE|ViewHolder.FLAG_INVALID</code>,现在我需要找到他用的地方.<br>进入<code>LinearLayoutManager</code>的<code>onLayoutChildren()</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinearLayoutManager</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onLayoutChildren</span><span class="params">()</span></span>&#123;</span><br><span class="line">        detachAndScrapAttachedViews();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>第一个用到的地方就在<code>detachAndScrapAttachedViews()</code>.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detachAndScrapAttachedViews</span><span class="params">(<span class="meta">@NonNull</span> Recycler recycler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> View v = getChildAt(i);</span><br><span class="line">        scrapOrRecycleView(recycler, i, v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scrapOrRecycleView</span><span class="params">(Recycler recycler, <span class="keyword">int</span> index, View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ViewHolder viewHolder = getChildViewHolderInt(view);</span><br><span class="line">    <span class="keyword">if</span> (viewHolder.isInvalid() &amp;&amp; !viewHolder.isRemoved()</span><br><span class="line">            &amp;&amp; !mRecyclerView.mAdapter.hasStableIds()) &#123;</span><br><span class="line">   <span class="comment">//情况1</span></span><br><span class="line">        removeViewAt(index);</span><br><span class="line">        recycler.recycleViewHolderInternal(viewHolder);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//情况2</span></span><br><span class="line">        detachViewAt(index);</span><br><span class="line">        recycler.scrapView(view);</span><br><span class="line">        mRecyclerView.mViewInfoStore.onViewDetached(viewHolder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>上面是原代码,下面我进行精简:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scrapOrRecycleView</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (viewHolder.isInvalid() &amp;&amp; !viewHolder.isRemoved()</span><br><span class="line">            &amp;&amp; !mRecyclerView.mAdapter.hasStableIds()) &#123;</span><br><span class="line">        Recycleview.removeViewAt(index);</span><br><span class="line">        <span class="keyword">if</span>(!holder.hasAnyOfTheFlags(INVALID | REMOVED | UPDATE))&#123;</span><br><span class="line">        <span class="comment">//只要不符合上面的任何一个情况,当前的ViewHolder都可以被缓存到mCachedView数组里面.</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            addViewHolderToRecycledViewPool();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Recycleview.detachViewFromParent(index)</span><br><span class="line">        <span class="keyword">if</span>(holder.hasAnyOfTheFlags(REMOVED | !UPDATE)&#123;</span><br><span class="line">            mAttachedScap.add(holder)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">             mChangedScrap.add(holder)</span><br><span class="line">        &#125;</span><br><span class="line">        mRecyclerView.mViewInfoStore.onViewDetached(viewHolder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>看到了精简的你会发现,只有当不是<code>INVALIDE REMOVE UPDATE</code>是可以被放进<code>mCachedViews</code>.否则当是<code>REMOVE INVALID</code>会被放进<code>mAttachedScrap</code>里面.如果是<code>UPDATE</code>会被放进<code>mChangedScrap</code>  </p>

        <h1 id="调用notifyItemChanged-int-position">
          <a href="#调用notifyItemChanged-int-position" class="heading-link"><i class="fas fa-link"></i></a><a href="#调用notifyItemChanged-int-position" class="headerlink" title="调用notifyItemChanged(int position)"></a>调用notifyItemChanged(int position)</h1>
      <p>这是专门更新某一个<code>ViewHolder</code>.<br>这么一个更新操作会被保存在<code>AdapterHelper.mPendingUpdates</code>数组里面:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">onItemRangeChanged</span><span class="params">(<span class="keyword">int</span> positionStart, <span class="keyword">int</span> itemCount, Object payload)</span> </span>&#123;</span><br><span class="line">    mPendingUpdates.add(obtainUpdateOp(UpdateOp.UPDATE, positionStart, itemCount, payload));</span><br><span class="line">    mExistingUpdateTypes |= UpdateOp.UPDATE;</span><br><span class="line">    <span class="keyword">return</span> mPendingUpdates.size() == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>构建了操作对象<code>UpdateOp</code>操作名字是<code>UPDATE</code>.关于操作有以下四种,对应着不同的更新方式:  </p>
<ol>
<li>ADD</li>
<li>REMOV</li>
<li>UPDATE</li>
<li>MOVE  </li>
</ol>
<p>这个操作被记录在<code>mPendingUpdates</code>数组里面.然后设置了<code>Recycleview.mAdapterUpdateDuringMeasure</code>为<code>true</code>.关于这个数组什么时候会被用到后面讲.</p>
<hr>

        <h1 id="关于Recycleview动画实现原理">
          <a href="#关于Recycleview动画实现原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#关于Recycleview动画实现原理" class="headerlink" title="关于Recycleview动画实现原理"></a>关于Recycleview动画实现原理</h1>
      <p><code>ViewHolder</code>的状态有以下几种,这也是动画的几种区别:</p>
<ol>
<li>PERSISTENT : 针对布局前和布局后都在手机界面上的<code>View</code>所做的动画.</li>
<li>REMOVED : 在布局前对用户可见,但是数据已经从数据源中删除.</li>
<li>ADDED : 新增数据到数据源,并且在布局后对用户可见.</li>
<li>DISAPPEARING : 数据一直都存在于数据原中,但是布局后从可见变成了不可见.</li>
<li>APPERAING : 数据一直在数据源中,但是布局后从不可见变成了可见.</li>
</ol>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/01/09/groovy%E9%97%AD%E5%8C%85/">groovy闭包</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-01-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-04-26</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>为什么会开始学习闭包,因为在看到这个代码的时候我总是看不懂是什么意思:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gradle.taskGraph.beforeTask &#123;</span><br><span class="line">    println(<span class="string">&quot;任务之前执行&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">gradle.taskGraph.afterTask &#123;Task task,TaskState state-&gt;</span><br><span class="line">    println(<span class="string">&quot;任务之后执行&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>这里你可以点开源码,比如这个afterTask:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class TaskExecutionGraph&#123;</span><br><span class="line">    void beforeTask(Closure var1);</span><br><span class="line">    void beforeTask(Action&lt;Task&gt; var1);</span><br><span class="line">    void afterTask(Closure var1);</span><br><span class="line">    void afterTask(Action&lt;Task&gt; var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>这里可以看到传入的参数是一个叫<code>Closure</code>的类,这个就是Groovy里面的闭包.<br>这里举个闭包的例子:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//lala.gradle</span><br><span class="line">class Person&#123;</span><br><span class="line">    String getName(Closure closure)&#123;</span><br><span class="line">        closure(&quot;cc&quot;,&quot;dd&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">def bibao = &#123;</span><br><span class="line">    x , y -&gt; </span><br><span class="line">        println(&quot;Hello Closure ,the param valus is: &quot;+x+&quot;,&quot;+y)</span><br><span class="line">&#125;</span><br><span class="line">new Persion().getName(bibao)</span><br><span class="line"></span><br><span class="line">// 运行后输出:</span><br><span class="line">Hello Closure ,the param valus is:cc,dd</span><br></pre></td></tr></table></div></figure>
<p>上面的也可以这么写:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Person&#123;</span><br><span class="line">    String getName(Closure closure)&#123;</span><br><span class="line">        closure(&quot;cc&quot;,&quot;dd&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">new Persion().getName&#123;x,y-&gt;</span><br><span class="line">    println(&quot;Hello Closure ,the param valus is: &quot;+x+&quot;,&quot;+y)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>看了上面这个例子你对闭包应该了解了,和kotlin里面的闭包差不多.  <span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_33725807/article/details/91386384">闭包</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<hr>
<p>再回到上面的代码:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gradle.taskGraph.afterTask &#123;Task task,TaskState state-&gt;</span><br><span class="line">    println(&quot;任务之后执行&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>我们在看到源码的时候,看到的是afterTask里面传的参数是Closure,也就是一个闭包,那我们怎么知道这个闭包到底该怎么写呢.这个时候就需要看官方文档了:<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://docs.gradle.org/current/javadoc/org/gradle/api/execution/TaskExecutionGraph.html#beforeTask-groovy.lang.Closure-">https://docs.gradle.org/current/javadoc/org/gradle/api/execution/TaskExecutionGraph.html#beforeTask-groovy.lang.Closure-</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>找到afterTask方法:<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3065f7f0e8e41b6acfeff018fb1c919~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"><br>可以看到官方文档写清楚了,他的参数有哪些.</p>
<hr>
<p>现在看另外一个方法: (这个方法是用来配置远程仓库的)</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">repositories</span><span class="params">(Closure var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>可以看到这个方法是属于project对象的.<br>打开官方文档找下这个<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://docs.gradle.org/current/javadoc/org/gradle/api/Project.html#getRepositories--">方法:</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dfc649f4b15c4096a5d3cb3587a797b7~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"></p>
<p>文档里面很清楚的讲了<code>RepositoryHandler</code>做为闭包的委托传递给闭包.  </p>
<p>这里出现了一个新的知识点<strong>做为闭包的委托传递给闭包</strong>.<br><strong>闭包委托</strong>:<br>groovy的闭包委托有thisObject,owner,delegate三个属性.当在闭包内调用方法时,由他们来确定使用哪个对象来处理.默认情况owner和delegeta是相等的.但是delegate是可以进行修改的.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//闭包委托</span></span><br><span class="line"><span class="function">def <span class="title">method1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    println <span class="string">&quot;Context this :$&#123;this.getClass()&#125; in root&quot;</span></span><br><span class="line">    println <span class="string">&quot;method1 in root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Delegate</span></span>&#123;</span><br><span class="line">    <span class="function">def <span class="title">method1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        println <span class="string">&quot;Delegate this : $&#123;this.getClass()&#125; in Delegate&quot;</span></span><br><span class="line">        println <span class="string">&quot;method1 in Delegate&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">def <span class="title">test</span><span class="params">(Closure&lt;Delegate&gt; closure)</span></span>&#123;</span><br><span class="line">            closure(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task helloDelegate &lt;&lt;&#123;</span><br><span class="line">    <span class="keyword">new</span> Delegate().test&#123;</span><br><span class="line">        println <span class="string">&quot;thisObject :$&#123;thisObject.getClass()&#125;&quot;</span></span><br><span class="line">        println <span class="string">&quot;owner:$&#123;owner.getClass()&#125;&quot;</span></span><br><span class="line">        println <span class="string">&quot;delegate:$&#123;delegate.getClass()&#125;&quot;</span></span><br><span class="line">        method1()</span><br><span class="line">        it.method1()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//输出</span></span><br><span class="line">thisObject :<span class="class"><span class="keyword">class</span> <span class="title">build_apnm7l2hrtoaa0bd51bpb5xcf</span></span></span><br><span class="line"><span class="class"><span class="title">owner</span>:<span class="title">class</span> <span class="title">build_apnm7l2hrta</span></span></span><br><span class="line"><span class="class"><span class="title">delegate</span>:<span class="title">class</span> <span class="title">build_apnm7</span></span></span><br><span class="line"><span class="class"><span class="title">Context</span> <span class="title">this</span> :<span class="title">class</span> <span class="title">build_apnm7l2hrtoaa0bd51bpb5xcf</span> <span class="title">in</span> <span class="title">root</span></span></span><br><span class="line"><span class="class"><span class="title">method1</span> <span class="title">in</span> <span class="title">root</span></span></span><br><span class="line"><span class="class"><span class="title">Delegate</span> <span class="title">this</span> : <span class="title">class</span> <span class="title">Delegate</span> <span class="title">in</span> <span class="title">Delegate</span></span></span><br><span class="line"><span class="class"><span class="title">method1</span> <span class="title">in</span> <span class="title">Delegate</span></span></span><br></pre></td></tr></table></div></figure>
<p>可以看到thisObject优先级是最高的.<br>在DSL中,比如gradle,一般会指定delegate为当前it,这样我们就可以在闭包中对该it进行配置和方法调用:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="function">String personName</span></span><br><span class="line"><span class="function">    <span class="keyword">int</span> personAge</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    def <span class="title">dumpPerson</span><span class="params">()</span></span>&#123;</span><br><span class="line">        println <span class="string">&quot;name is $&#123;personName&#125;, age is $&#123;personAge&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">def <span class="title">person</span><span class="params">(Closure&lt;Person&gt; closure)</span></span>&#123;</span><br><span class="line">    Person p = <span class="keyword">new</span> Person()</span><br><span class="line">    closure.delegate = p</span><br><span class="line">    <span class="comment">//委托模式优先</span></span><br><span class="line">    closure.setResolveStrategy(Closure.DELEGATE_FIRST)</span><br><span class="line">    closure(p)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task configClosure &lt;&lt; &#123;</span><br><span class="line">    person&#123;</span><br><span class="line">        personName=<span class="string">&quot;张三&quot;</span></span><br><span class="line">        personAge = <span class="number">20</span></span><br><span class="line">        dumpPerson()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>在回到上面讲的方法:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>官方文档讲了RepositoryHandler做为了闭包的委托传递给了闭包,所以在{}里面可以用到的方法就都是在RepositoryHandler对象申明的方法了.不信你可以打开RepositoryHandler类看下:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RepositoryHandler</span> <span class="keyword">extends</span> <span class="title">ArtifactRepositoryContainer</span> </span>&#123;</span><br><span class="line">    <span class="function">FlatDirectoryArtifactRepository <span class="title">flatDir</span><span class="params">(Map&lt;String, ?&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">FlatDirectoryArtifactRepository <span class="title">flatDir</span><span class="params">(Closure var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">FlatDirectoryArtifactRepository <span class="title">flatDir</span><span class="params">(Action&lt;? <span class="keyword">super</span> FlatDirectoryArtifactRepository&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ArtifactRepository <span class="title">gradlePluginPortal</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ArtifactRepository <span class="title">gradlePluginPortal</span><span class="params">(Action&lt;? <span class="keyword">super</span> ArtifactRepository&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function">MavenArtifactRepository <span class="title">jcenter</span><span class="params">(Action&lt;? <span class="keyword">super</span> MavenArtifactRepository&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function">MavenArtifactRepository <span class="title">jcenter</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MavenArtifactRepository <span class="title">mavenCentral</span><span class="params">(Map&lt;String, ?&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MavenArtifactRepository <span class="title">mavenCentral</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MavenArtifactRepository <span class="title">mavenCentral</span><span class="params">(Action&lt;? <span class="keyword">super</span> MavenArtifactRepository&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MavenArtifactRepository <span class="title">mavenLocal</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MavenArtifactRepository <span class="title">mavenLocal</span><span class="params">(Action&lt;? <span class="keyword">super</span> MavenArtifactRepository&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MavenArtifactRepository <span class="title">google</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MavenArtifactRepository <span class="title">google</span><span class="params">(Action&lt;? <span class="keyword">super</span> MavenArtifactRepository&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MavenArtifactRepository <span class="title">maven</span><span class="params">(Closure var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MavenArtifactRepository <span class="title">maven</span><span class="params">(Action&lt;? <span class="keyword">super</span> MavenArtifactRepository&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">IvyArtifactRepository <span class="title">ivy</span><span class="params">(Closure var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">IvyArtifactRepository <span class="title">ivy</span><span class="params">(Action&lt;? <span class="keyword">super</span> IvyArtifactRepository&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exclusiveContent</span><span class="params">(Action&lt;? <span class="keyword">super</span> ExclusiveContentRepository&gt; var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>是不是看到了我们熟知的方法:jcenter mavenCentral.所以上面的代码完整点可以这么写:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;RepositoryHandler-&gt;</span><br><span class="line">    RepositoryHandler.mavenCentral()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/12/29/JavaPoet%E5%AD%A6%E4%B9%A0/">JavaPoet学习</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2022-12-29</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-04-26</span></span></div></header><div class="post-body"><div class="post-excerpt"><blockquote>
<p>这是一个帮助我们动态生成代码的框架.</p>
</blockquote>
<p>这里先给一个最简单的案例:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        buildAjavaFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">buildAjavaFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        MethodSpec methodSpec = MethodSpec.methodBuilder(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">                .addModifiers(Modifier.PUBLIC,Modifier.STATIC)</span><br><span class="line">                .returns(<span class="keyword">void</span>.class)</span><br><span class="line">                .addParameter(Integer.class,<span class="string">&quot;loop&quot;</span>)</span><br><span class="line">                .addCode(<span class="string">&quot;System.out.print(&quot;</span>生成的代码<span class="string">&quot;);\n&quot;</span>)</span><br><span class="line">                .addCode(<span class="string">&quot;$T a = $L&quot;</span>,Tea.class,<span class="string">&quot;new Tea()&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        TypeSpec typeSpec = TypeSpec.classBuilder(<span class="string">&quot;TestCode&quot;</span>)</span><br><span class="line">                .addModifiers(Modifier.PUBLIC,Modifier.FINAL)</span><br><span class="line">                .addMethod(methodSpec)</span><br><span class="line">                .build();</span><br><span class="line">        JavaFile javaFile = JavaFile.builder(<span class="string">&quot;com.haha.hah&quot;</span>,typeSpec)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">// 将java文件内容写入文件中</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">&quot;./javapoet&quot;</span>);</span><br><span class="line">        javaFile.writeTo(file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>生成的代码:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haha.hah;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ddd.Tea;</span><br><span class="line"><span class="keyword">import</span> java.lang.Integer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCode</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(Integer loop)</span> </span>&#123;</span><br><span class="line">    System.out.print(<span class="string">&quot;生成的代码&quot;</span>);</span><br><span class="line">    Tea a = <span class="keyword">new</span> Tea()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>可以看到需要import的内容他也帮我们自动添加了.</p>
<p>更多详细的使用文档可以参考这个博客:  </p>
<ol>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/IO_Field/article/details/89355941">https://blog.csdn.net/IO_Field/article/details/89355941</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/chennai1101/article/details/103975423">https://blog.csdn.net/chennai1101/article/details/103975423</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ol>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf6a834efd32459097852862faeb9e3f~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/12/26/java%E4%B9%8Bapt%E5%AD%A6%E4%B9%A0%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">java之apt学习环境搭建</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2022-12-26</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-04-26</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>新建modue: java_apt</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ae97b173c604f08afaa6ce7b4b487b3~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png.jpg"> </p>
<p>在build.gradle添加下面内容:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation &#x27;com.google.auto.service:auto-service:1.0.1&#x27;</span><br><span class="line">annotationProcessor &#x27;com.google.auto.service:auto-service:1.0.1&#x27;</span><br></pre></td></tr></table></div></figure>

<p>新建类BaseProcessor继承AbstractProcessor</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.auto.service.AutoService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.*;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="meta">@AutoService(Processor.class)</span></span><br><span class="line"><span class="meta">@SupportedAnnotationTypes(&quot;sunrise.annotation.Hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment env)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;sadasdasdsad&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annoations, RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;sadasdasdsadasdasdasddsad&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后在最外层的build.gradle添加下面内容:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">annotationProcessor(project(&quot;:java_apt&quot;))</span><br></pre></td></tr></table></div></figure>
<p>这个时候build下我们的工程:会看到生成下面这些内容:</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54665977abe948359275ef5bb1c38398~tplv-k3u1fbpfcp-watermark.image" alt="captrue.png"></p>
<p>这就是使用这种方法的好处,他会自动帮你生成这些文件.</p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/3/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">libertyYu</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/librityYu/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="1169927533" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">100</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">27</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">18</div><div class="sidebar-ov-state-item__name">标签</div></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><script src="https://unpkg.com/mermaid@8.8.3/dist/mermaid.min.js"></script><var>me = require('mermaid')</var></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script></body></html>