<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta property="og:type" content="website">
<meta property="og:title" content="Liberty&#39;s Blog">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Liberty&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Liberty">
<meta name="twitter:card" content="summary"><title>Liberty's Blog</title><link ref="canonical" href="http://example.com/page/5/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/日记/"><span class="header-nav-menu-item__icon"><i class="fas fa-book"></i></span><span class="header-nav-menu-item__text">日记</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Liberty's Blog</div><div class="header-banner-info__subtitle"></div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/10/14/Handler%E6%BA%90%E7%A0%81/">Handler源码</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-10-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-10-14</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>​        ActivityThread在main里面调用Looper.prepareMainLooper() 将当前线程初始化为一个循环，并将其标记为应用的主程序的主循环。在调用prepareMainLooper方法的时候创建了Looper对象，在创建Looper的对象都会自动创建一个MessageQueue。<font color="red">由此可见 一个Looper对象着一个MessageQueue，并且标记了当前的线程</font></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> MessageQueue mQueue;</span><br><span class="line"><span class="keyword">final</span> Thread mThread;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">    mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);</span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>​        <strong>总结：在调用Looper.prepareMainLooper方法，用来将当前线程设置为一个循环，内部调用了prepare方法去创建了Looper对象，创建Looper对象的构造函数里创建了MessageQueue对象和标记了当前的线程是谁。</strong></p>
<p>​        我们想获取当前Looper对象的时候可以调用Looper.myLooper()他是一个静态方法，你可以在任意时刻获取，他得到的结果都是当前线程对应的Looper对象。<font color="red">注意：一个线程只能有一个Looper对象，而创建Looper的方法就是调用Looper.prepare方法。Looper的创建会创建对应的MessageQueue,和保存当前的线程是谁。这么一看我突然恍然大悟。在我们更新ui的时候，会检测当前线程和当前线程Looper里面保存的线程一不一至，比如我们在子线程去更新ui，那么就会出问题。每次调用requestLayout方法都会层层往上最终调用到ViewRootImpl的requestLayout()。在这里面第一件事情干的就是检查当前更新ui的线程和创建ViewRootImpl的线程是否是同一个。问题又来了，ViewRootImpl对象是什么时候创建。答：调用windowManager.addView的时候创建的。所有子view的最终父类否是ViewRootImpl。在ViewRootImpl的构造函数里面可以看到它保存了创建它自己的时候的线程对象。所以我们在子线程更新ui还有一个做法就是在子线程里面调用windManager.addView方法,从而达到ViewRootImpl的创建也在子线程完成，那么在requestLayout的线程检查里面就不会出现问题。这里还有一点要注意，windowManager.addView方法里面回去主动调用ViewRootImpl的requestLayout方法，requeslayout通过异步的方式发送了一个message消息实现ui的测量 布局绘制。这里就涉及到了消息机制，所以我们在子线程通过windowManger创建ui的时候一定要调用Looper.prepare()  和 Looper.loop() 方法，只有这样我们在子线程创建view  更新view才会成功。</font></p>
<p>​        在Handler的构造函数里面，会去获取当前线程对应的looper对象。获取当前looper对象的messaqueue消息队列</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/10/06/Gradle%E4%B8%8A%E4%BC%A0%E6%8F%92%E4%BB%B6%E5%88%B0%E4%BB%93%E5%BA%93/">Gradle上传插件到仓库</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-10-06</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-10-06</span></span></div></header><div class="post-body"><div class="post-excerpt"><blockquote>
<p>准备工作：首先新建一个插件模块 plugin_module</p>
</blockquote>
<p>把plugin_module里面的文件全部删了只留下src/main  和 build.gradle 文件。</p>
<ol>
<li>修改build.gradle文件内容</li>
</ol>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;groovy&#x27;</span>  <span class="comment">//必须</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation gradleApi() <span class="comment">//必须</span></span><br><span class="line">    implementation localGroovy() <span class="comment">//必须</span></span><br><span class="line">&#125;</span><br><span class="line">repositories &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ol start="2">
<li>写入我们自定义的插件MyDefaultTask.groovy</li>
</ol>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打包的数据 插件</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReleaseInfoPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; &#123;</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ol start="3">
<li><p>新建文件resources/META-INF/gradle-plugins</p>
<p>创建文件 releaseinfo.properties 。这里需要注意这个文件名字就是我们以后通过apply pligun:”这里需要写入的插件名字”。</p>
<p>文件内容:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation-class=ReleaseInfoPlugin // 插件类</span><br></pre></td></tr></table></div></figure></li>
</ol>
<p>至此准备工作做好了！</p>
<hr>

        <h2 id="上传到本地Maven">
          <a href="#上传到本地Maven" class="heading-link"><i class="fas fa-link"></i></a><a href="#上传到本地Maven" class="headerlink" title="上传到本地Maven"></a>上传到本地Maven</h2>
      
        <h4 id="插件上传：">
          <a href="#插件上传：" class="heading-link"><i class="fas fa-link"></i></a><a href="#插件上传：" class="headerlink" title="插件上传："></a>插件上传：</h4>
      <p>在我们的插件模块的build.gradle加入以下代码：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#x27;groovy&#x27;  //必须</span><br><span class="line">apply plugin: &#x27;maven-publish&#x27; // 上传maven的插件</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation gradleApi() //必须</span><br><span class="line">    implementation localGroovy() //必须</span><br><span class="line">&#125;</span><br><span class="line">repositories &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">publishing &#123;</span><br><span class="line">    publications &#123;</span><br><span class="line">        maven(MavenPublication) &#123;</span><br><span class="line">            groupId = com.librity.releaseplugin</span><br><span class="line">            artifactId = releaseInfo</span><br><span class="line">            version = 1.0</span><br><span class="line"></span><br><span class="line">            from components.java</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>同步完成功能，可以看到我们多了这些任务：</p>
<img src="/2021/10/06/Gradle%E4%B8%8A%E4%BC%A0%E6%8F%92%E4%BB%B6%E5%88%B0%E4%BB%93%E5%BA%93/tu1.png" style="zoom:50%;">

<p>我们点击publishMaven…ToMavenLocal</p>
<p>任务执行完毕后我们会在这看到我们的maven库：</p>
<img src="/2021/10/06/Gradle%E4%B8%8A%E4%BC%A0%E6%8F%92%E4%BB%B6%E5%88%B0%E4%BB%93%E5%BA%93/tu2.png" style="zoom:50%;">

<hr>

        <h4 id="插件使用">
          <a href="#插件使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#插件使用" class="headerlink" title="插件使用"></a>插件使用</h4>
      <p>在根目录的build.gradle写入：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">    mavenLocal() // 表示需要依赖本地的maven仓库</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">        // 这个就是我们刚才上传的插件 地址可以打开maven-metada0lical.xml看下都是怎么填的</span><br><span class="line">        classpath &#x27;com.librity.releaseplugin:releaseInfo:1.0&#x27;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>这些依赖写好后就可以在app的build.gradle里面进行使用了：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id &#x27;com.android.application&#x27;</span><br><span class="line">    id &#x27;kotlin-android&#x27;</span><br><span class="line">    id &#x27;releaseinfo&#x27; // 刚才我们定义的插件名字</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<hr>

        <h2 id="上传GithubMaven">
          <a href="#上传GithubMaven" class="heading-link"><i class="fas fa-link"></i></a><a href="#上传GithubMaven" class="headerlink" title="上传GithubMaven"></a>上传GithubMaven</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#x27;groovy&#x27;  //必须</span><br><span class="line">apply plugin: &#x27;maven-publish&#x27; //必须添加这个插件才能上传</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation gradleApi() //必须</span><br><span class="line">    implementation localGroovy() //必须</span><br><span class="line">&#125;</span><br><span class="line">repositories &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">publishing &#123;</span><br><span class="line">    publications &#123;</span><br><span class="line">        maven(MavenPublication) &#123;</span><br><span class="line">            groupId = GROUDID</span><br><span class="line">            artifactId = ARTIFACTID</span><br><span class="line">            version = versions</span><br><span class="line"></span><br><span class="line">            from components.java</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123;</span><br><span class="line">            def mavenLib = file(getProperty(&#x27;mavenPath&#x27;))</span><br><span class="line">            url = &quot;file://$&#123;mavenLib.absolutePath&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>在gradle.properties里面加上这几个参数：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mavenPath = ..</span><br><span class="line">GROUDID = com.librity.releaseplugin</span><br><span class="line">ARTIFACTID = releaseInfo</span><br><span class="line">versions = 1.0</span><br></pre></td></tr></table></div></figure>

<p>同步下工程：</p>
<img src="/2021/10/06/Gradle%E4%B8%8A%E4%BC%A0%E6%8F%92%E4%BB%B6%E5%88%B0%E4%BB%93%E5%BA%93/tu3.png" style="zoom:50%;">

<p>然后我们把我们的工程上传到github上面。</p>

        <h4 id="使用">
          <a href="#使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#使用" class="headerlink" title="使用"></a>使用</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">maven&#123;</span><br><span class="line">// 格式：&#x27;https://raw.githubusercontent.com/[username]/[工程名字]/[分支]</span><br><span class="line">    url &#x27;https://raw.githubusercontent.com/librityYu/ReleaseInfoTask/maven&#x27;</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">        // 我们的插件</span><br><span class="line">        classpath &#x27;com.librity.releaseplugin:releaseInfo:1.0&#x27;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>然后在我们要使用的module的build.gradle</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id &#x27;releaseinfo&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/10/05/%E6%89%93%E5%8C%85%E6%97%B6%E6%B7%BB%E5%8A%A0%E5%86%85%E5%AE%B9%E8%84%9A%E6%9C%AC%E6%8F%92%E4%BB%B6/">打包时添加内容脚本插件</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-10-05</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-10-06</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>####需求：为每次打包生成内容数据信息</p>
<p>Gradle自定义插件有三种方式：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/158588813">https://zhuanlan.zhihu.com/p/158588813</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><strong>1. 在build.gradle</strong></p>
<p>直接在app目录下的build.gradle文件中写</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt;</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(Project target)</span> </span>&#123;</span><br><span class="line">        println(<span class="string">&#x27;MyPlugin执行了&#x27;</span>)</span><br><span class="line">        target.task(<span class="string">&quot;mytask&quot;</span>)&#123;</span><br><span class="line">            doLast &#123;</span><br><span class="line">                println(<span class="string">&#x27;MyPlugin中的task执行了&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后在</p>
<p>app的build.gradle文件中引入插件：</p>
<blockquote>
<p>apply plugin: MyPlugin</p>
</blockquote>
<p>然后再控制台输入gradlew mytask</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; Configure project :app</span><br><span class="line">MyPlugin执行了</span><br><span class="line"></span><br><span class="line">&gt; Task :app:mytask</span><br><span class="line">MyPlugin中的task执行了</span><br></pre></td></tr></table></div></figure>

<p>使用这种方式可以很快的创建一个插件，缺点就是只能在当前的build.gradle使用，复用差。</p>
<p><strong>2. 在buildSrc文件夹下</strong></p>
<p>buildSrc是Gradle中的默认插件目录，编译的时候Gradle会自动识别这个目录，将其内的代码编译撑成插件。</p>
<p>在根目录新建一个文件叫buildSrc，然后在buildSrc文件新建build.gralde文件写入代码：</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apply(plugin = <span class="string">&quot;kotlin&quot;</span>)</span><br><span class="line">apply(plugin = <span class="string">&quot;java&quot;</span>)</span><br><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven(<span class="string">&quot;https://maven.aliyun.com/repository/gradle-plugin&quot;</span>)</span><br><span class="line">        maven(<span class="string">&quot;https://maven.aliyun.com/repository/central&quot;</span>)</span><br><span class="line">        google()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath(<span class="string">&quot;com.jfrog.bintray.gradle:gradle-bintray-plugin:1.8.4&quot;</span>)</span><br><span class="line">        classpath(<span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:1.5.20&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven(<span class="string">&quot;https://maven.aliyun.com/repository/gradle-plugin&quot;</span>)</span><br><span class="line">        maven(<span class="string">&quot;https://maven.aliyun.com/repository/central&quot;</span>)</span><br><span class="line">        google()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// 引入源代码</span></span><br><span class="line">    implementation(<span class="string">&quot;com.android.tools.build:gradle:4.2.2&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>build.gradle文件内容写完后我们同步下功能，就可以在buildSrc文件里面看到文件.gradle和build这两个文件。现在我们在buildSrc下面新建文件src/main/groovy  和 src/main/resources/META-INF/gradle-plugins。</p>
<p><img src="/2021/10/05/%E6%89%93%E5%8C%85%E6%97%B6%E6%B7%BB%E5%8A%A0%E5%86%85%E5%AE%B9%E8%84%9A%E6%9C%AC%E6%8F%92%E4%BB%B6/tu1.png" alt="img1"></p>
<p>然后在groovy文件加里新建我们的插件MyPlugin.groovy</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(Project target)</span> </span>&#123;</span><br><span class="line">        println(<span class="string">&#x27;buildSrc中MyPlugin执行了&#x27;</span>)</span><br><span class="line">        target.task(<span class="string">&quot;mytask&quot;</span>)&#123;</span><br><span class="line">            doLast &#123;</span><br><span class="line">                println(<span class="string">&#x27;buildSrc中MyPlugin中的task执行了&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>写完插件怎么让编译器知道这是我们的插件呢？</p>
<ul>
<li>在main目录下的resources/META-INF/gradle-plugins目录新建propertites文件</li>
<li>properties文件的名字就是我们在build.gradle里面通过apply引入时候要写的名字，通常都是使用报名。com.yu.releaseInfo。然后文件内容写：implementation-class= com.yu.releaseInfo.MyPlugin</li>
</ul>
<p>然后在app的build.gradle里面映入插件：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply plugin ：&#x27;com.yu.releaseInfo&#x27;</span><br></pre></td></tr></table></div></figure>

<p>最后在控制台进行测试：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; Configure project :app</span><br><span class="line">buildSrc中MyPlugin执行了</span><br><span class="line"></span><br><span class="line">&gt; Task :app:mytask</span><br><span class="line">buildSrc中MyPlugin中的task执行了</span><br></pre></td></tr></table></div></figure>

<p><strong>第三种上传maven</strong></p>
<p>上传maven这样所有人都可以使用咱么这个项目了。</p>
<p>可以参考我的另外一篇博客。  Gradle上传插件到仓库</p>
<hr>

        <h4 id="进行实战">
          <a href="#进行实战" class="heading-link"><i class="fas fa-link"></i></a><a href="#进行实战" class="headerlink" title="进行实战"></a>进行实战</h4>
      <p>这里我们使用第二种方式，在buildSrc里面写我们的插件。</p>
<p><font size="5">在groovy文件夹新建类 1. ReleaseInfoExtension.groovy</font></p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReleaseInfoExtension</span> &#123;</span></span><br><span class="line">    String versionCode</span><br><span class="line">    String versionName</span><br><span class="line">    String versionInfo</span><br><span class="line">    String fileName</span><br><span class="line">    String afterTask = <span class="string">&quot;assembleDebug&quot;</span></span><br><span class="line"></span><br><span class="line">    ReleaseInfoExtension() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    String toString() &#123;</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        versionCode = $&#123;versionCode&#125;</span></span><br><span class="line"><span class="string">        versionName = $&#123;versionName&#125;</span></span><br><span class="line"><span class="string">        versionInfo = $&#123;versionInfo&#125;</span></span><br><span class="line"><span class="string">        fileName = $&#123;fileName&#125;</span></span><br><span class="line"><span class="string">        afterTask = $&#123;afterTask&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>我们把我们的基础信息放在类里面。</p>
<p><font size="5">2. 新建插件类ReleaseInfoPlugin.groocy</font></p>
<p>这个类用来创建我们的扩展参数和扩展方法，代码如下</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.gradle.api.Plugin</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Project</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打包的数据 插件</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReleaseInfoPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; &#123;</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line">        <span class="comment">// 为工程添加扩展参数 releaseInfoYu 他的具体实现类是ReleaseInfoExtension</span></span><br><span class="line">        ReleaseInfoExtension  releaseInfoExtension = project.extensions.create(<span class="string">&#x27;releaseInfoYu&#x27;</span>, ReleaseInfoExtension)</span><br><span class="line">        <span class="comment">// 为工程创建额外的task 名字叫releaseInfoTask 具体实现类ReleaseInfoTask</span></span><br><span class="line">        ReleaseInfoTask  releaseInfoTask =  project.tasks.create(<span class="string">&#x27;releaseInfoTask&#x27;</span>, ReleaseInfoTask)</span><br><span class="line">        <span class="comment">// 这一步骤是为了把我们自定义的releaseInfoTask添加到打包的task的之后自动执行</span></span><br><span class="line">        project.afterEvaluate &#123;</span><br><span class="line">            project.tasks.findByName(releaseInfoExtension.afterTask).finalizedBy(releaseInfoTask)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后在resources/META-INF/gradle.plugins 下新建文件 releaseinfo.properties。内容：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation-class=ReleaseInfoPlugin</span><br></pre></td></tr></table></div></figure>

<p>同步下工程。</p>
<p><font size="5">3. 在app的build.gradle引入我们的插件</font></p>
<p>apply plugin :’releaseinfo’</p>
<p><font size="5">4. 配置打包信息</font></p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">releaseInfoYu &#123; re -&gt;</span><br><span class="line">    project.getExtensions().android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">        re.versionCode = variant.getVersionCode()</span><br><span class="line">        re.versionName = variant.getVersionName()</span><br><span class="line">    &#125;</span><br><span class="line">    versionInfo = <span class="string">&quot;第一次提交的版本数据&quot;</span></span><br><span class="line">    fileName = <span class="string">&quot;release.xml&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>注意我们首先要在app目录下新建一个空白文件release.xml</p>
</blockquote>
<p><font size="5">5. 完成写入xml的task任务</font></p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> groovy.xml.MarkupBuilder</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.DefaultTask</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.tasks.TaskAction</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReleaseInfoTask</span> <span class="keyword">extends</span> <span class="title">DefaultTask</span>&#123;</span></span><br><span class="line">    ReleaseInfoTask()&#123;</span><br><span class="line">        group = <span class="string">&quot;libertyYu&quot;</span></span><br><span class="line">        description  = <span class="string">&quot;update the release info&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TaskAction</span></span><br><span class="line">    <span class="keyword">void</span> doAction()&#123;</span><br><span class="line">        updateInfo()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> updateInfo()&#123;</span><br><span class="line">        String versionCodeMsg = project.extensions.releaseInfoYu.versionCode</span><br><span class="line">        String versionNameMsg = project.extensions.releaseInfoYu.versionName</span><br><span class="line">        String versionInfoMsg = project.extensions.releaseInfoYu.versionInfo</span><br><span class="line">        String fileName = project.extensions.releaseInfoYu.fileName</span><br><span class="line">        StringWriter stringWriter = <span class="keyword">new</span> StringWriter()</span><br><span class="line">        MarkupBuilder xmlBuilder = <span class="keyword">new</span> MarkupBuilder(stringWriter)</span><br><span class="line">        <span class="keyword">def</span> file = project.file(fileName)</span><br><span class="line">        <span class="keyword">if</span> (file == <span class="literal">null</span> &amp;&amp; !destFile.exists()) &#123;</span><br><span class="line">            file.createNewFile()</span><br><span class="line">        &#125;</span><br><span class="line">        Date currentTime = <span class="keyword">new</span> Date();</span><br><span class="line">        SimpleDateFormat formatter = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        String dateString = formatter.format(currentTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (file.text != <span class="literal">null</span> &amp;&amp; file.text.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//没有内容</span></span><br><span class="line">            xmlBuilder.releases &#123;</span><br><span class="line">                release &#123;</span><br><span class="line">                    versionCode(versionCodeMsg)</span><br><span class="line">                    versionName(versionNameMsg)</span><br><span class="line">                    versionInfo(versionInfoMsg)</span><br><span class="line">                    versionTime(dateString)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//直接写入</span></span><br><span class="line">            file.withWriter &#123; writer -&gt; writer.append(stringWriter.toString())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//已有其它版本内容</span></span><br><span class="line">            xmlBuilder.release &#123;</span><br><span class="line">                versionCode(versionCodeMsg)</span><br><span class="line">                versionName(versionNameMsg)</span><br><span class="line">                versionInfo(versionInfoMsg)</span><br><span class="line">                versionTime(dateString)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//插入到最后一行前面</span></span><br><span class="line">            <span class="keyword">def</span> lines = file.readLines()</span><br><span class="line">            <span class="keyword">def</span> lengths = lines.size() - <span class="number">1</span></span><br><span class="line">            file.withWriter &#123; writer -&gt;</span><br><span class="line">                lines.eachWithIndex &#123; line, index -&gt;</span><br><span class="line">                    <span class="keyword">if</span> (index != lengths) &#123;</span><br><span class="line">                        writer.append(line + <span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index == lengths) &#123;</span><br><span class="line">                        writer.append(<span class="string">&#x27;\r\r\n&#x27;</span> + stringWriter.toString() + <span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line">                        writer.append(lines.get(lengths))</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="测试">
          <a href="#测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#测试" class="headerlink" title="测试"></a>测试</h4>
      <p>执行我们的assembleDebug任务后可以在release.xml文件看到如下内容：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">release</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">versionCode</span>&gt;</span>2<span class="tag">&lt;/<span class="name">versionCode</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">versionName</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">versionName</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">versionInfo</span>&gt;</span>第一次提交的版本数据<span class="tag">&lt;/<span class="name">versionInfo</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">versionTime</span>&gt;</span>2021-10-06 08:44:43<span class="tag">&lt;/<span class="name">versionTime</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">release</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/09/30/Gradle%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0/">Gradle知识学习</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-09-30</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-09-30</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>Cheer Up!</p>

        <h2 id="Gradle生命周期">
          <a href="#Gradle生命周期" class="heading-link"><i class="fas fa-link"></i></a><a href="#Gradle生命周期" class="headerlink" title="Gradle生命周期"></a>Gradle生命周期</h2>
      <ol>
<li><p>初始化阶段</p>
</li>
<li><p>配置阶段</p>
</li>
<li><p>执行阶段</p>
</li>
</ol>

        <h3 id="1-初始化阶段">
          <a href="#1-初始化阶段" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-初始化阶段" class="headerlink" title="1. 初始化阶段"></a>1. 初始化阶段</h3>
      <p>Gradle根据setting.gradle文件的配置为项目创建Project实例。</p>

        <h3 id="2-配置阶段">
          <a href="#2-配置阶段" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-配置阶段" class="headerlink" title="2. 配置阶段"></a>2. 配置阶段</h3>
      <p>​    Gradle构造一个模型表示任务，并参与构建中来。增量式构建决定我们的task是否需要运行。配置阶段完成后。整个build的project以及内部的Task关系就确定了。这个阶段非常适合为项目或指定task设置所需要的配置数据。配置阶段的实质为解析每个被加入构建项目的build.gradle脚本，比如通过apply方法引入插件，为插件扩展属性进行配置等等。。。。</p>
<p>​    注意：项目的每一次构建的任何配置代码都可以被执行-即使你只运行gradle tasks。</p>

        <h3 id="3-执行阶段">
          <a href="#3-执行阶段" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-执行阶段" class="headerlink" title="3. 执行阶段"></a>3. 执行阶段</h3>
      <p>​    在执行阶段，所有的task按照配置阶段规定好的顺序，一次执行。我们通常会在根据任务执行的生命周期去动态在合适的位置插入我们自己的运行期间执行的代码断。</p>
<p>​    许多生命周期方法都被定义在了Gradle 和 Project方法里面。不要害怕使用生命周期钩子，它相反就是为了给开发者使用提供方便而设计出来的。</p>
<hr>

        <h2 id="生命周期监听方法">
          <a href="#生命周期监听方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#生命周期监听方法" class="headerlink" title="生命周期监听方法"></a>生命周期监听方法</h2>
      <p>​    如果我们想在Gradle特定的阶段去Hook指定的任务，那么我们需要对如何监听生命周期的回调有一些了解。</p>
<p>​    Gradle和Project对象提供了一些方法供我们使用：</p>
<p>​    生命周期监听的设置有两个方法：</p>
<pre><code> 1. 实现一个特定的监听接口
 2. 提供一个用于在收到通知时执行的闭包。
</code></pre>
<p><strong>Project</strong>提供的一些生命周期方法：</p>
<ul>
<li><p>afterEvaluate(closure) , atferEvaluate(action)</p>
</li>
<li><p>beforeEvaluate(closure) , beforeEvaluate(action)</p>
</li>
<li><p>*Gradle**提供的一些生命周期方法：</p>
</li>
<li><p>afterProject(closure) , afterProject(action)</p>
</li>
<li><p>beforeProject(closure) , beforeProject(action)</p>
</li>
<li><p>buildFinished(closure) , buildFinished(action)</p>
</li>
<li><p>projectsEvaluated(closure) , projectsEvaluated(action)</p>
</li>
<li><p>projectsLoaded(closure) , projectsLoaded(action)</p>
</li>
<li><p>settingsEvaluated(closure) , settingsEvaluated(action)</p>
</li>
<li><p>addBuildListener(buildListener)</p>
</li>
<li><p>addListener(listener)</p>
</li>
<li><p>addProjectEvaluationListener(listener)</p>
<p>可以看到每个方法都有两个不同参数，一个接收闭包，一个接收Action作为回调。注意，一些生命周期的方法只会在合适的位置上才会发生。</p>
</li>
</ul>

        <h4 id="beforeEvaluate">
          <a href="#beforeEvaluate" class="heading-link"><i class="fas fa-link"></i></a><a href="#beforeEvaluate" class="headerlink" title="beforeEvaluate"></a>beforeEvaluate</h4>
      <p>beforeEvalute() 在project开始配置前调用。这个方法很容易误用，你要是直接在子模块的build.gradle中使用肯定是不会被调用的。应为project都没配置好所以也就什么事情也不会发生。这个代码块的添加只能放在父工程的build.gradle中：</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.project.subprojects &#123; sub -&gt;</span><br><span class="line">    sub.beforeEvaluate &#123; project</span><br><span class="line">        println(<span class="string">&quot;### Evaluate before of &quot;</span>+project.path)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="afterEvaluate">
          <a href="#afterEvaluate" class="heading-link"><i class="fas fa-link"></i></a><a href="#afterEvaluate" class="headerlink" title="afterEvaluate"></a>afterEvaluate</h4>
      <p>afaterEvaluate() 是一般比较常见的一个配置，只要在project配置成功均会被调用，不论在父模块还是在子模块。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">project.afterEvaluate &#123; pro-&gt;</span><br><span class="line">    println(<span class="string">&quot;### Evaluate after of &quot;</span> + pro.path)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="afterProject">
          <a href="#afterProject" class="heading-link"><i class="fas fa-link"></i></a><a href="#afterProject" class="headerlink" title="afterProject"></a>afterProject</h4>
      <p>设置一个project配置完成后即执行的闭包或者action。</p>
<p>afterPeoject在配置参数失败后传入两个参数，前者当前project，后者显示失败信息。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.getGradle().afterProject&#123;project,projectState-&gt;</span><br><span class="line">    <span class="keyword">if</span>(projectState.failure)&#123;</span><br><span class="line">        println(<span class="string">&quot;Evaluate afterProject of &quot;</span>+ project + <span class="string">&quot;Falued&quot;</span>)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        println(<span class="string">&quot;Evaluate afterPeoject of &quot;</span>+ project + <span class="string">&quot;Successed&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="beforeProject">
          <a href="#beforeProject" class="heading-link"><i class="fas fa-link"></i></a><a href="#beforeProject" class="headerlink" title="beforeProject"></a>beforeProject</h4>
      <p>设置一个project配置前执行的闭包，子模块的该方法声明在root project中回调才会执行，root project的该方法声明在setting.gradle中才执行。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gradle.beforeProject &#123; p -&gt;</span><br><span class="line">    println(<span class="string">&quot;Evaluation beforeProject&quot;</span>+p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="buildFinished">
          <a href="#buildFinished" class="heading-link"><i class="fas fa-link"></i></a><a href="#buildFinished" class="headerlink" title="buildFinished"></a>buildFinished</h4>
      <p>构建结束时的回调，此时所有的任务都执行完毕，一个构建结果的对象BuildResult作为参数传递给闭包。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gradle.buildFinished &#123; r -&gt;</span><br><span class="line">    println(<span class="string">&quot;buildFinished &quot;</span>+r.failure)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="projectEvaluated">
          <a href="#projectEvaluated" class="heading-link"><i class="fas fa-link"></i></a><a href="#projectEvaluated" class="headerlink" title="projectEvaluated"></a>projectEvaluated</h4>
      <p>所有的peoject都配置完成后的回调，此时，所有的project都配置完毕，准备开始生成task图。gradle对象作为参数传递给闭包。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gradle.projectsEvaluated &#123;gradle -&gt;</span><br><span class="line">    println(<span class="string">&quot;projectsEvaluated&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="projectsLoaded">
          <a href="#projectsLoaded" class="heading-link"><i class="fas fa-link"></i></a><a href="#projectsLoaded" class="headerlink" title="projectsLoaded"></a>projectsLoaded</h4>
      <p>当setting中的所有project都创建好时执行闭包回调，gradle对象会作为参数传递给闭包。这个方法比较特殊，只有声明在适当的位置才会发生，如果这个声明周期挂接闭包声明在build.gradle文件，那么将不会发生这个事件。应为项目创建发生在初始阶段。放在setting.gradle中是可以执行的。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gradle.projectsLoaded &#123;gradle -&gt;</span><br><span class="line">    println(<span class="string">&quot;@@@@@@@ projectsLoaded&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="settingsEvaluated">
          <a href="#settingsEvaluated" class="heading-link"><i class="fas fa-link"></i></a><a href="#settingsEvaluated" class="headerlink" title="settingsEvaluated"></a>settingsEvaluated</h4>
      <p>当 settings.gradle 加载并配置完毕后执行闭包回调，setting对象已经配置好并且准备开始加载构建 project。这个回调在 build.gradle 中声明也是不起作用的，在 settings.gradle 中声明是可以的。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gradle.settingsEvaluated &#123;</span><br><span class="line">    println(<span class="string">&quot;@@@@@@@ settingsEvaluated&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<hr>
<p>前面说过设置监听还有两个方法，通过接口监听。</p>

        <h3 id="addProjectEvaluationListener">
          <a href="#addProjectEvaluationListener" class="heading-link"><i class="fas fa-link"></i></a><a href="#addProjectEvaluationListener" class="headerlink" title="addProjectEvaluationListener"></a>addProjectEvaluationListener</h3>
      <figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gradle.addProjectEvaluationListener(<span class="keyword">new</span> ProjectEvaluationListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> beforeEvaluate(Project project) &#123;</span><br><span class="line">        println <span class="string">&quot; add project evaluation lister beforeEvaluate,project path is: &quot;</span>+project</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> afterEvaluate(Project project, ProjectState state) &#123;</span><br><span class="line">        println <span class="string">&quot; add project evaluation lister afterProject,project path is:&quot;</span>+project</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></div></figure>


        <h3 id="addListener">
          <a href="#addListener" class="heading-link"><i class="fas fa-link"></i></a><a href="#addListener" class="headerlink" title="addListener"></a>addListener</h3>
      <p>添加一个实现来listener接口的对象到build</p>

        <h3 id="addBuildListener">
          <a href="#addBuildListener" class="heading-link"><i class="fas fa-link"></i></a><a href="#addBuildListener" class="headerlink" title="addBuildListener"></a>addBuildListener</h3>
      <p>添加一个BuildListener对象到Build</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">gradle.addBuildListener(<span class="keyword">new</span> BuildListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> buildStarted(Gradle gradle) &#123;</span><br><span class="line">        println(<span class="string">&quot;### buildStarted&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> settingsEvaluated(Settings settings) &#123;</span><br><span class="line">        println(<span class="string">&quot;### settingsEvaluated&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> projectsLoaded(Gradle gradle) &#123;</span><br><span class="line">        println(<span class="string">&quot;### projectsLoaded&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> projectsEvaluated(Gradle gradle) &#123;</span><br><span class="line">        println(<span class="string">&quot;### projectsEvaluated&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> buildFinished(BuildResult result) &#123;</span><br><span class="line">        println(<span class="string">&quot;### buildFinished&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></div></figure>


        <h3 id="Task执行图">
          <a href="#Task执行图" class="heading-link"><i class="fas fa-link"></i></a><a href="#Task执行图" class="headerlink" title="Task执行图"></a>Task执行图</h3>
      <p>在配置时，Gradle决定在执行阶段要运行的task顺序，他们依赖关系的内部结构被建模为一个有向无环图。我们称之为task执行图。它可以用TaskExecutionGraph来表示。可以通过gradle.taskGraph来获取。在TaskExecutationGraph中也可以设置一些Task生命周期回到。</p>
<ul>
<li>addTaskExecutationGraphListener(TaskExecutionGraphListener listener)</li>
<li>addTaskExecutionListener(TaskExecutionListener listener)</li>
<li>afterTask(Action action)，afterTask(Closure closure)</li>
<li>beforeTask(Action action)，beforeTask(Closure closure)</li>
<li>whenReady(Action action)，whenReady(Closure closure)</li>
</ul>

        <h4 id="addTaskExecutionGraphListener">
          <a href="#addTaskExecutionGraphListener" class="heading-link"><i class="fas fa-link"></i></a><a href="#addTaskExecutionGraphListener" class="headerlink" title="addTaskExecutionGraphListener"></a>addTaskExecutionGraphListener</h4>
      <p>添加 task 执行图的监听器，当执行图配置好会执行通知。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gradle.taskGraph.addTaskExecutionGraphListener(<span class="keyword">new</span> TaskExecutionGraphListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> graphPopulated(TaskExecutionGraph graph) &#123;</span><br><span class="line">        println(<span class="string">&quot;@@@ gradle.taskGraph.graphPopulated &quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></div></figure>


        <h4 id="addTaskExecutionListener">
          <a href="#addTaskExecutionListener" class="heading-link"><i class="fas fa-link"></i></a><a href="#addTaskExecutionListener" class="headerlink" title="addTaskExecutionListener"></a>addTaskExecutionListener</h4>
      <p>添加 task 执行监听器，当 task 执行前或者执行完毕会执行回调发出通知。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gradle.taskGraph.addTaskExecutionListener(<span class="keyword">new</span> TaskExecutionListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> beforeExecute(Task task) &#123;</span><br><span class="line">        println(<span class="string">&quot;@@@ gradle.taskGraph.beforeTask &quot;</span>+task)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> afterExecute(Task task, TaskState state) &#123;</span><br><span class="line">        println(<span class="string">&quot;@@@ gradle.taskGraph.afterTask &quot;</span>+task)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></div></figure>


        <h4 id="afterTask">
          <a href="#afterTask" class="heading-link"><i class="fas fa-link"></i></a><a href="#afterTask" class="headerlink" title="afterTask"></a>afterTask</h4>
      <figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gradle.taskGraph.afterTask &#123; task -&gt;</span><br><span class="line">    println(<span class="string">&quot;### gradle.taskGraph.afterTask &quot;</span>+task)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="beforeTask">
          <a href="#beforeTask" class="heading-link"><i class="fas fa-link"></i></a><a href="#beforeTask" class="headerlink" title="beforeTask"></a>beforeTask</h4>
      <figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gradle.taskGraph.beforeTask &#123; task -&gt;</span><br><span class="line">    println(<span class="string">&quot;### gradle.taskGraph.beforeTask &quot;</span>+task)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="whenReady">
          <a href="#whenReady" class="heading-link"><i class="fas fa-link"></i></a><a href="#whenReady" class="headerlink" title="whenReady"></a>whenReady</h4>
      <p>设置一个 task 执行图准备好后的闭包或者回调方法。<br>该 taskGrahp 作为参数传递给闭包。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gradle.taskGraph.whenReady &#123; taskGrahp -&gt;</span><br><span class="line">    println(<span class="string">&quot;@@@ gradle.taskGraph.whenReady &quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<hr>

        <h3 id="生命周期执行顺序">
          <a href="#生命周期执行顺序" class="heading-link"><i class="fas fa-link"></i></a><a href="#生命周期执行顺序" class="headerlink" title="生命周期执行顺序"></a>生命周期执行顺序</h3>
      <p>我们通过在生命周期回调中添加打印的方法来看下顺序：</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">task hello &#123;</span><br><span class="line">    doFirst &#123;</span><br><span class="line">        println <span class="string">&#x27;*** task hello doFirst&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    doLast &#123;</span><br><span class="line">        println <span class="string">&#x27;*** task hello doLast&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    println <span class="string">&#x27;*** config task hello&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>为了保证生命周期的各个回调方法都被执行，我们在 settings.gradle 中添加各个回调方法。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">gradle.addBuildListener(<span class="keyword">new</span> BuildListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> buildStarted(Gradle gradle) &#123;</span><br><span class="line">        println(<span class="string">&quot;### gradle.buildStarted&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> settingsEvaluated(Settings settings) &#123;</span><br><span class="line">        println(<span class="string">&quot;### gradle.settingsEvaluated&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> projectsLoaded(Gradle gradle) &#123;</span><br><span class="line">        println(<span class="string">&quot;### gradle.projectsLoaded&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> projectsEvaluated(Gradle gradle) &#123;</span><br><span class="line">        println(<span class="string">&quot;### gradle.projectsEvaluated&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> buildFinished(BuildResult result) &#123;</span><br><span class="line">        println(<span class="string">&quot;### gradle.buildFinished&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">gradle.afterProject &#123; project,projectState -&gt;</span><br><span class="line">    <span class="keyword">if</span>(projectState.failure)&#123;</span><br><span class="line">        println <span class="string">&quot;### gradld.afterProject &quot;</span>+project+<span class="string">&quot; FAILED&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        println <span class="string">&quot;### gradle.afterProject &quot;</span>+project+<span class="string">&quot; succeeded&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradle.beforeProject &#123; p -&gt;</span><br><span class="line">    println(<span class="string">&quot;### gradle.beforeProject &quot;</span>+p)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradle.allprojects(<span class="keyword">new</span> Action&lt;Project&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> execute(Project project) &#123;</span><br><span class="line">        project.beforeEvaluate &#123; project</span><br><span class="line">            println <span class="string">&quot;### project.beforeEvaluate &quot;</span>+project</span><br><span class="line">        &#125;</span><br><span class="line">        project.afterEvaluate &#123; pro -&gt;</span><br><span class="line">            println(<span class="string">&quot;### project.afterEvaluate &quot;</span> + pro)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gradle.taskGraph.addTaskExecutionListener(<span class="keyword">new</span> TaskExecutionListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> beforeExecute(Task task) &#123;</span><br><span class="line">        <span class="keyword">if</span> (task.name.equals(<span class="string">&quot;hello&quot;</span>))&#123;</span><br><span class="line">            println(<span class="string">&quot;@@@ gradle.taskGraph.beforeTask &quot;</span>+task)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> afterExecute(Task task, TaskState state) &#123;</span><br><span class="line">        <span class="keyword">if</span> (task.name.equals(<span class="string">&quot;hello&quot;</span>))&#123;</span><br><span class="line">            println(<span class="string">&quot;@@@ gradle.taskGraph.afterTask &quot;</span>+task)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">gradle.taskGraph.addTaskExecutionGraphListener(<span class="keyword">new</span> TaskExecutionGraphListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> graphPopulated(TaskExecutionGraph graph) &#123;</span><br><span class="line">        println(<span class="string">&quot;@@@ gradle.taskGraph.graphPopulated &quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">gradle.taskGraph.whenReady &#123; taskGrahp -&gt;</span><br><span class="line">    println(<span class="string">&quot;@@@ gradle.taskGraph.whenReady &quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>执行 task info</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">./gradlew hello</span><br><span class="line">### gradle.settingsEvaluated</span><br><span class="line">### gradle.projectsLoaded</span><br><span class="line"></span><br><span class="line">&gt; Configure <span class="attr">project :</span> </span><br><span class="line">### gradle.beforeProject root project <span class="string">&#x27;TestSomething&#x27;</span></span><br><span class="line">### project.beforeEvaluate root project <span class="string">&#x27;TestSomething&#x27;</span></span><br><span class="line">### gradle.afterProject root project <span class="string">&#x27;TestSomething&#x27;</span> succeeded</span><br><span class="line">### project.afterEvaluate root project <span class="string">&#x27;TestSomething&#x27;</span></span><br><span class="line"></span><br><span class="line">&gt; Configure <span class="attr">project :</span>app </span><br><span class="line">### gradle.beforeProject project <span class="string">&#x27;:app&#x27;</span></span><br><span class="line">### project.beforeEvaluate project <span class="string">&#x27;:app&#x27;</span></span><br><span class="line">*** config task hello</span><br><span class="line">### gradle.afterProject project <span class="string">&#x27;:app&#x27;</span> succeeded</span><br><span class="line">### project.afterEvaluate project <span class="string">&#x27;:app&#x27;</span></span><br><span class="line"></span><br><span class="line">&gt; Configure <span class="attr">project :</span>common </span><br><span class="line">### gradle.beforeProject project <span class="string">&#x27;:common&#x27;</span></span><br><span class="line">### project.beforeEvaluate project <span class="string">&#x27;:common&#x27;</span></span><br><span class="line">### gradle.afterProject project <span class="string">&#x27;:common&#x27;</span> succeeded</span><br><span class="line">### project.afterEvaluate project <span class="string">&#x27;:common&#x27;</span></span><br><span class="line"></span><br><span class="line">### gradle.projectsEvaluated</span><br><span class="line">@@@ gradle.taskGraph.graphPopulated </span><br><span class="line">@@@ gradle.taskGraph.whenReady </span><br><span class="line"></span><br><span class="line">&gt; <span class="attr">Task :</span><span class="attr">app:</span>hello </span><br><span class="line">@@@ gradle.taskGraph.beforeTask task <span class="string">&#x27;:app:hello&#x27;</span></span><br><span class="line">*** task hello doFirst</span><br><span class="line">*** task hello doLast</span><br><span class="line">@@@ gradle.taskGraph.afterTask task <span class="string">&#x27;:app:hello&#x27;</span></span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL <span class="keyword">in</span> <span class="number">1</span>s</span><br><span class="line"><span class="number">1</span> actionable <span class="attr">task:</span> <span class="number">1</span> execu</span><br></pre></td></tr></table></div></figure>

<p>因此，生命周期回调的执行顺序是：</p>
<ul>
<li>gradle.settingsEvaluated-&gt;<br>gradle.projectsLoaded-&gt;<br>gradle.beforeProject-&gt;<br>project.beforeEvaluate-&gt;<br>gradle.afterProject-&gt;<br>project.afterEvaluate-&gt;<br>gradle.projectsEvaluated-&gt;<br>gradle.taskGraph.graphPopulated-&gt;<br>gradle.taskGraph.whenReady-&gt;<br>gradle.buildFinished</li>
</ul>
<p>非常好的博客：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.heqiangfly.com/2016/03/18/development-tool-gradle-lifecycle/">https://www.heqiangfly.com/2016/03/18/development-tool-gradle-lifecycle/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/09/27/Gralde%E6%BA%90%E7%A0%81%E7%90%86%E8%A7%A3/">Gralde源码理解</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-09-27</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2022-01-20</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="1-找到源码所在位置：">
          <a href="#1-找到源码所在位置：" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-找到源码所在位置：" class="headerlink" title="1. 找到源码所在位置："></a>1. 找到源码所在位置：</h1>
      <p><strong>路径：D:\SoftWare\AndroidStudio\Gradle\caches\modules-2\files-2.1\com.android.tools.build\gradle\3.5.3\d691064e7d03aae18e3d13b03c76c3fef9b2c252\gradle-3.5.3-sources.jar</strong></p>
<blockquote>
<p>在gradle/3.5.3的目录下会有两个目录 一个存放的是class文件 一个存放的java文件。</p>
</blockquote>
<p><img src="/2021/09/27/Gralde%E6%BA%90%E7%A0%81%E7%90%86%E8%A7%A3/%E5%9B%BE2.png" alt="img1"></p>
<p><img src="/2021/09/27/Gralde%E6%BA%90%E7%A0%81%E7%90%86%E8%A7%A3/%E5%9B%BE1.png" alt="img1"></p>
<blockquote>
<p>这里我结合了别人的博客，让我更加快速的学习：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://juejin.cn/post/6963527524609425415#heading-0">https://juejin.cn/post/6963527524609425415#heading-0</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p>as提供了一个processDebugManifest的任务供我们使用，那他的源码在哪里呢：</p>
<p>我目前跟到最接近的地方是：ProcessApplicationManifest.java文件的：</p>
<p>​        可以看到在创建CreationAction的时候他们根据VariantScope动态拼接了我们的task任务名字，已经定义死的名字是process  和 Manifest。然后根据我们打的时release包还是debug包，拼接出完整的名字。也就是我目前想找的 processDebugManifest任务。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CreationAction</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="meta">@NonNull</span> VariantScope scope,</span></span></span><br><span class="line"><span class="params"><span class="function">                // TODO : remove <span class="keyword">this</span> variable and find ways to access it from scope.</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">boolean</span> isAdvancedProfilingOn)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(</span><br><span class="line">                    scope,</span><br><span class="line">                    scope.getTaskName(<span class="string">&quot;process&quot;</span>, <span class="string">&quot;Manifest&quot;</span>),</span><br><span class="line">                    ProcessApplicationManifest.class);</span><br><span class="line">            <span class="keyword">this</span>.variantScope = scope;</span><br><span class="line">            <span class="keyword">this</span>.isAdvancedProfilingOn = isAdvancedProfilingOn;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></div></figure>

<p>VariantManager.java -&gt;  createAndroidTasks()   -&gt;   createTasksForVariantData()</p>
<p>ApplicationTaskManager.java 执行； createMergeApkManifestsTask  -&gt;</p>
<p>TaskManager.java  执行了  createMergeApkManifestsTask -&gt;  createMergeManifestTask()</p>
<p>首先在BasePlugin.java的apply方法 这是一个入口函数：执行basePluginApply 这个函数很重要，它去创建了我们的全部的任务。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(<span class="meta">@NonNull</span> Project project)</span> </span>&#123;</span><br><span class="line">       CrashReporting.runAction(</span><br><span class="line">               () -&gt; &#123;</span><br><span class="line">                   basePluginApply(project);</span><br><span class="line">                   pluginSpecificApply(project);</span><br><span class="line">               &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>

<p>在basePluginApply里面执行了：createTasks方法，创建全部任务：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">basePluginApply</span><span class="params">(<span class="meta">@NonNull</span> Project project)</span> </span>&#123;</span><br><span class="line">            threadRecorder.record(</span><br><span class="line">                    ExecutionType.BASE_PLUGIN_PROJECT_CONFIGURE,</span><br><span class="line">                    project.getPath(),</span><br><span class="line">                    <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">this</span>::configureProject);</span><br><span class="line"></span><br><span class="line">            threadRecorder.record(</span><br><span class="line">                    ExecutionType.BASE_PLUGIN_PROJECT_BASE_EXTENSION_CREATION,</span><br><span class="line">                    project.getPath(),</span><br><span class="line">                    <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">this</span>::configureExtension);</span><br><span class="line"></span><br><span class="line">            threadRecorder.record(</span><br><span class="line">                    ExecutionType.BASE_PLUGIN_PROJECT_TASKS_CREATION,</span><br><span class="line">                    project.getPath(),</span><br><span class="line">                    <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">this</span>::createTasks);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    threadRecorder.record(</span><br><span class="line">            ExecutionType.TASK_MANAGER_CREATE_TASKS,</span><br><span class="line">            project.getPath(),</span><br><span class="line">            <span class="keyword">null</span>,</span><br><span class="line">            () -&gt; taskManager.createTasksBeforeEvaluate());</span><br><span class="line"></span><br><span class="line">    project.afterEvaluate(</span><br><span class="line">            CrashReporting.afterEvaluate(</span><br><span class="line">                    p -&gt; &#123;</span><br><span class="line">                        sourceSetManager.runBuildableArtifactsActions();</span><br><span class="line"></span><br><span class="line">                        threadRecorder.record(</span><br><span class="line">                                ExecutionType.BASE_PLUGIN_CREATE_ANDROID_TASKS,</span><br><span class="line">                                project.getPath(),</span><br><span class="line">                                <span class="keyword">null</span>,</span><br><span class="line">                                <span class="keyword">this</span>::createAndroidTasks);</span><br><span class="line">                    &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>从 <strong>createTasks()</strong> 可以看到，<strong>createAndroidTasks()</strong> 是在afterEvalutate() 中执行的。</p>
<p>**createAndroidTasks()**方法有点长，我这里只关心一行代码 <strong>VariantManager.createAndroidTasks()</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">createAndroidTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;VariantScope&gt; variantScopes = variantManager.createAndroidTasks();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VariantManager</span></span><br><span class="line"><span class="comment">/** Variant/Task creation entry point. */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;VariantScope&gt; <span class="title">createAndroidTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    variantFactory.validateModel(<span class="keyword">this</span>);</span><br><span class="line">    variantFactory.preVariantWork(project);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (variantScopes.isEmpty()) &#123;</span><br><span class="line">        populateVariantDataList(); <span class="comment">// 在这里给variantScopes塞数据</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create top level test tasks.</span></span><br><span class="line">    taskManager.createTopLevelTestTasks(!productFlavors.isEmpty());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> VariantScope variantScope : variantScopes) &#123;</span><br><span class="line">        createTasksForVariantData(variantScope);<span class="comment">// 上一步塞完了数据之后，这里去创建每一个task</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    taskManager.createSourceSetArtifactReportTask(globalScope);</span><br><span class="line"></span><br><span class="line">    taskManager.createReportTasks(variantScopes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> variantScopes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<hr>
<p>为应用生成不同的包名：</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://tools.android.com/tech-docs/new-build-system/applicationid-vs-packagename</span></span><br><span class="line">productFlavors &#123;</span><br><span class="line">        pro &#123;</span><br><span class="line">            applicationId = <span class="string">&quot;com.example.my.pkg.pro&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        free &#123;</span><br><span class="line">            applicationId = <span class="string">&quot;com.example.my.pkg.free&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            applicationIdSuffix <span class="string">&quot;.debug&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>





<hr>

        <h3 id="Android默认的Proect为DefaultProject-java，下面我们来分析下：">
          <a href="#Android默认的Proect为DefaultProject-java，下面我们来分析下：" class="heading-link"><i class="fas fa-link"></i></a><a href="#Android默认的Proect为DefaultProject-java，下面我们来分析下：" class="headerlink" title="Android默认的Proect为DefaultProject.java，下面我们来分析下："></a>Android默认的Proect为DefaultProject.java，下面我们来分析下：</h3>
      <p>我们在创建android工程的时候，为什么每次主应用第一行写的都是 <font color="red" size="3">apply plugin:com.android.application</font>呢？</p>
<p><strong>现在我们来分析下：</strong></p>
<p>apply plugin 代表我们要为这个工程引入插件这个插件的具体指向叫com.android.application，打开gradle-4.2.2-sources.jar<font color="blue">(注意这个jar包是android的gradle插件包：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/tools/gradle-api">https://developer.android.google.cn/reference/tools/gradle-api</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>  这个链接列举了现在所有版本的android的gradle插件包版本)</font>我们在META-INF/gradle-plugins里面可以找到文件com.android.application.properties文件:</p>
<img src="/2021/09/27/Gralde%E6%BA%90%E7%A0%81%E7%90%86%E8%A7%A3/tu1.png" alt="img1" style="zoom:50%;">

<p>打开这个文件内容写着：implementation-class=com.android.build.gradle.AppPlugin。可以知道插件的实现类是AppPlugin。现在也就知道了通过apply plugin:com.android.application 实际是导入了AppPlugin这个插件。在这个插件里面干了很多事情，比如创建了我们的扩展参数 android。。。。</p>
<p><strong>现在来分析下这个扩展参数 android 是怎么被创建出来的</strong></p>
<p>Android必须添加的插件是AppPlugin.java,在createExtension里面创建了扩展参数android,这也是我们android很重的一个配置参数。</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> BaseExtension createExtension(</span><br><span class="line">           <span class="meta">@NonNull</span> DslServices dslServices,</span><br><span class="line">           <span class="meta">@NonNull</span> GlobalScope globalScope,</span><br><span class="line">           <span class="meta">@NonNull</span></span><br><span class="line">                   DslContainerProvider&lt;DefaultConfig, BuildType, ProductFlavor, SigningConfig&gt;</span><br><span class="line">                           dslContainers,</span><br><span class="line">           <span class="meta">@NonNull</span> NamedDomainObjectContainer&lt;BaseVariantOutput&gt; buildOutputs,</span><br><span class="line">           <span class="meta">@NonNull</span> ExtraModelInfo extraModelInfo) &#123;</span><br><span class="line">       <span class="keyword">if</span> (globalScope.getProjectOptions().get(BooleanOption.USE_NEW_DSL_INTERFACES)) &#123;</span><br><span class="line">           <span class="keyword">return</span> (BaseExtension)</span><br><span class="line">                   project.getExtensions()</span><br><span class="line">                           .create(</span><br><span class="line">                                   ApplicationExtension.<span class="keyword">class</span>,</span><br><span class="line">                                   <span class="string">&quot;android&quot;</span>,</span><br><span class="line">                                   BaseAppModuleExtension.<span class="keyword">class</span>,</span><br><span class="line">                                   dslServices,</span><br><span class="line">                                   globalScope,</span><br><span class="line">                                   buildOutputs,</span><br><span class="line">                                   dslContainers.getSourceSetManager(),</span><br><span class="line">                                   extraModelInfo,</span><br><span class="line">                                   <span class="keyword">new</span> ApplicationExtensionImpl(dslServices, dslContainers));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> project.getExtensions()</span><br><span class="line">               .create(</span><br><span class="line">                       <span class="string">&quot;android&quot;</span>,</span><br><span class="line">                       BaseAppModuleExtension.<span class="keyword">class</span>,</span><br><span class="line">                       dslServices,</span><br><span class="line">                       globalScope,</span><br><span class="line">                       buildOutputs,</span><br><span class="line">                       dslContainers.getSourceSetManager(),</span><br><span class="line">                       extraModelInfo,</span><br><span class="line">                       <span class="keyword">new</span> ApplicationExtensionImpl(dslServices, dslContainers));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>问题来了，project.getExtensions().create()这个方法到底是如何实现创建我们的扩展参数的？</strong></p>
<p><strong>现在咱们就来探究下~</strong></p>
<hr>
<p>由于Project是一个接口，那么首先我们得搞清楚这个Projectd的具体实现类是谁，调用下面这个任务我们就可以知道了：</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">task getProjectClassType&#123;</span><br><span class="line">	println(project.<span class="keyword">class</span>)</span><br><span class="line">    <span class="comment">// 输出结果class org.gradle.api.internal.project.DefaultProject_Decorated</span></span><br><span class="line">    <span class="comment">// 也就是DefaultProject.java</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>知道了Project其实就是DefaultProject.java，现在就跟到DefaultProject里面查看getExtensions()方法：</p>
<p><strong>DefalultProject.java</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ExtensionContainerInternal <span class="title">getExtensions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (ExtensionContainerInternal) getConvention();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>这个ExtensionContainerInternal是一个接口，那么我们如何知道他的具体实现类呢：</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">task getConversionClassType&#123;</span><br><span class="line">    println(project.getConvention())</span><br><span class="line">    <span class="comment">// 输出结果org.gradle.internal.extensibility.DefaultConvention</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>通过上面代码我们知道了调用getConvention()实现返回的是DefaultConvention.java类。</p>
<p>通过以上步骤我们清楚了调用project.getConvention()实际是获取到对象DefaultConvention.java类。</p>
<p>现在进入DefaultConvention查看create的实现过程：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当android.experimental.newDslInterfaces这个值获取为true的时候才会调用这个create</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; publicType, String name, Class&lt;? extends T&gt; instanceType, Object... constructionArguments)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> create(typeOf(publicType), name, instanceType, constructionArguments);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// instanceType ： 具体生成的实例对象  </span></span><br><span class="line"><span class="comment">// constructionArguments : 创建这个实体对象所需要的参数信息</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(TypeOf&lt;T&gt; publicType, String name, Class&lt;? extends T&gt; instanceType, Object... constructionArguments)</span> </span>&#123;</span><br><span class="line">    T instance = instantiate(instanceType, name, constructionArguments);</span><br><span class="line">    add(publicType, name, instance);</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 具体实例对象的方法 instanceType就是我们最终生成的实例对象 constructionArguments是实例这个</span></span><br><span class="line"><span class="comment">// 对象需要的参数信息 name 扩展参数名称 也就是我们在build.gradle写的时候要用的名字</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">instantiate</span><span class="params">(Class&lt;? extends T&gt; instanceType, String name, Object[] constructionArguments)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instanceGenerator.newInstanceWithDisplayName(instanceType, Describables.withTypeAndName(<span class="string">&quot;extension&quot;</span>, name), constructionArguments);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>通过这几部的创建过程可以分析出在调用project.getExtensions().create()里面传递的参数含义：</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">project.getExtensions()</span><br><span class="line">                .create(</span><br><span class="line">                        <span class="string">&quot;android&quot;</span>,</span><br><span class="line">                        BaseAppModuleExtension.<span class="keyword">class</span>,</span><br><span class="line">                        dslServices,</span><br><span class="line">                        globalScope,</span><br><span class="line">                        buildOutputs,</span><br><span class="line">                        dslContainers.getSourceSetManager(),</span><br><span class="line">                        extraModelInfo,</span><br><span class="line">                        <span class="keyword">new</span> ApplicationExtensionImpl(dslServices, dslContainers));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>“android” :  我们在build.gradle里面具体使用的插件名称</li>
<li>BaseAppModuleExtension.class : 插件具体实例对象</li>
<li>dslService，globalScope，buildOutputs，dslContainers.getSourceSetManager(),extraModelInfo。。: 创建实例对象他所需要的参数</li>
</ul>
<p><strong>通过分析得出：build.gradle里面的android{}  他的具体实例对象是BaseAppModuleExtension，所以我们知道哪些参数可以让我们使用时候就直接到BaseAppModuleExtension这个类取找。</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">open class <span class="title">BaseAppModuleExtension</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    dslServices: DslServices,</span></span></span><br><span class="line"><span class="params"><span class="function">    globalScope: GlobalScope,</span></span></span><br><span class="line"><span class="params"><span class="function">    buildOutputs: NamedDomainObjectContainer&lt;BaseVariantOutput&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    sourceSetManager: SourceSetManager,</span></span></span><br><span class="line"><span class="params"><span class="function">    extraModelInfo: ExtraModelInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span> val publicExtensionImpl: ApplicationExtensionImpl</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> : <span class="title">AppExtension</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    dslServices,</span></span></span><br><span class="line"><span class="params"><span class="function">    globalScope,</span></span></span><br><span class="line"><span class="params"><span class="function">    buildOutputs,</span></span></span><br><span class="line"><span class="params"><span class="function">    sourceSetManager,</span></span></span><br><span class="line"><span class="params"><span class="function">    extraModelInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">true</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span>, InternalApplicationExtension by publicExtensionImpl </span>&#123;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>像applicationId , versionCode , versionName , minSdkVersion , targetSdkVersion , maxSdkVersion 等等这些值都保存在类ProductFlavor.kt</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">InternalBaseVariant</span>: <span class="type">BaseVariant &#123;</span></span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getMergedFlavor</span><span class="params">()</span></span>: MergedFlavor</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">MergedFlavor</span>: <span class="type">GradleToolingModelProductFlavor &#123;</span></span></span><br><span class="line">        <span class="keyword">override</span> <span class="keyword">val</span> testInstrumentationRunnerArguments: MutableMap&lt;String, String&gt;</span><br><span class="line">        <span class="keyword">override</span> <span class="keyword">val</span> manifestPlaceholders: MutableMap&lt;String, Any&gt;</span><br><span class="line">        <span class="keyword">override</span> <span class="keyword">val</span> resourceConfigurations: MutableCollection&lt;String&gt;</span><br><span class="line">        <span class="keyword">override</span> <span class="keyword">val</span> proguardFiles: MutableList&lt;File&gt;</span><br><span class="line">        <span class="keyword">override</span> <span class="keyword">val</span> consumerProguardFiles: MutableList&lt;File&gt;</span><br><span class="line">        <span class="keyword">override</span> <span class="keyword">val</span> testProguardFiles: MutableList&lt;File&gt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AndroidArtifactVariantImpl</span><br></pre></td></tr></table></div></figure>

<p>AppPlugin里面先执行了configureExtension()方法，createVariantFactory这个方法去创建了我们可以使用的参数信息。createExtension 方法去创建了android这个扩展属性</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">configuratorService.recordBlock(</span><br><span class="line">        ExecutionType.BASE_PLUGIN_PROJECT_BASE_EXTENSION_CREATION,</span><br><span class="line">        project.getPath(),</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">this</span>::configureExtension);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DslServices dslServices = globalScope.getDslServices();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> NamedDomainObjectContainer&lt;BaseVariantOutput&gt; buildOutputs =</span><br><span class="line">                project.container(BaseVariantOutput.class);</span><br><span class="line"></span><br><span class="line">        project.getExtensions().add(<span class="string">&quot;buildOutputs&quot;</span>, buildOutputs);</span><br><span class="line"></span><br><span class="line">        variantFactory = createVariantFactory(projectServices, globalScope);</span><br><span class="line"></span><br><span class="line">        variantInputModel =</span><br><span class="line">                <span class="keyword">new</span> LegacyVariantInputManager(</span><br><span class="line">                        dslServices,</span><br><span class="line">                        variantFactory.getVariantType(),</span><br><span class="line">                        <span class="keyword">new</span> SourceSetManager(</span><br><span class="line">                                project,</span><br><span class="line">                                isPackagePublished(),</span><br><span class="line">                                dslServices,</span><br><span class="line">                                <span class="keyword">new</span> DelayedActionsExecutor()));</span><br><span class="line"></span><br><span class="line">        extension =</span><br><span class="line">                createExtension(</span><br><span class="line">                        dslServices, globalScope, variantInputModel, buildOutputs, extraModelInfo);</span><br><span class="line"></span><br><span class="line">        globalScope.setExtension(extension);</span><br><span class="line"></span><br><span class="line">        VariantApiOperationsRegistrar&lt;VariantBuilderT, VariantT&gt; variantApiOperations =</span><br><span class="line">                <span class="keyword">new</span> VariantApiOperationsRegistrar&lt;&gt;();</span><br><span class="line">        androidComponentsExtension = createComponentExtension(dslServices, variantApiOperations);</span><br><span class="line"></span><br><span class="line">        variantManager =</span><br><span class="line">                <span class="keyword">new</span> VariantManager(</span><br><span class="line">                        globalScope,</span><br><span class="line">                        project,</span><br><span class="line">                        projectServices.getProjectOptions(),</span><br><span class="line">                        extension,</span><br><span class="line">                        variantApiOperations,</span><br><span class="line">                        variantFactory,</span><br><span class="line">                        variantInputModel,</span><br><span class="line">                        projectServices);</span><br><span class="line"></span><br><span class="line">        registerModels(</span><br><span class="line">                registry,</span><br><span class="line">                globalScope,</span><br><span class="line">                variantInputModel,</span><br><span class="line">                extension,</span><br><span class="line">                extraModelInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create default Objects, signingConfig first as its used by the BuildTypes.</span></span><br><span class="line">        variantFactory.createDefaultComponents(variantInputModel);</span><br><span class="line"></span><br><span class="line">        createAndroidTestUtilConfiguration();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>上面介绍了我们android的具体实现类是BaseAppModuleExtension，它继承自AppExtension，他又是继承自AbstractAppExtension，这个类很关键，看下代码：</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAppExtension</span></span>(</span><br><span class="line">    dslServices: DslServices,</span><br><span class="line">    globalScope: GlobalScope,</span><br><span class="line">    buildOutputs: NamedDomainObjectContainer&lt;BaseVariantOutput&gt;,</span><br><span class="line">    sourceSetManager: SourceSetManager,</span><br><span class="line">    extraModelInfo: ExtraModelInfo,</span><br><span class="line">    isBaseModule: <span class="built_in">Boolean</span></span><br><span class="line">) : TestedExtension(</span><br><span class="line">    dslServices,</span><br><span class="line">    globalScope,</span><br><span class="line">    buildOutputs,</span><br><span class="line">    sourceSetManager,</span><br><span class="line">    extraModelInfo,</span><br><span class="line">    isBaseModule</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">val</span> applicationVariants: DomainObjectSet&lt;ApplicationVariant&gt; =</span><br><span class="line">        dslServices.domainObjectSet(ApplicationVariant::<span class="keyword">class</span>.java)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">addVariant</span><span class="params">(variant: <span class="type">BaseVariant</span>)</span></span> &#123;</span><br><span class="line">        applicationVariants.add(variant <span class="keyword">as</span> ApplicationVariant)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>这里有一个很重要的参数：applicationVariants。我们在android里面的配置数据可以通过他来获取，比如版本号:</p>
<figure class="highlight groovy"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android.applicationVariants.all&#123;variant-&gt;</span><br><span class="line">	variant.outputs.all&#123;</span><br><span class="line">		println(variant.buildType.name)</span><br><span class="line">		println(variant.versionName)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>为什么可以获取到这些，可以看类ApplicationVariant，在它的父类都声明了这些属性的获取。</p>

        <h2 id="Variant">
          <a href="#Variant" class="heading-link"><i class="fas fa-link"></i></a><a href="#Variant" class="headerlink" title="Variant"></a>Variant</h2>
      <p>&nbsp;&nbsp;&nbsp;在Gradle里面有一个很重要的东西Variant(变体)。在AppPlugin你可以获取的变体是applicationVariants。在LibraryPlugin里面你可以获取的变体是libraryVariants。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val libraryVariants: <span class="function">DefaultDomainObjectSet&lt;LibraryVariant&gt;</span></span><br><span class="line"><span class="function">        <span class="title">get</span><span class="params">()</span> </span>= libraryVariantList as DefaultDomainObjectSet&lt;LibraryVariant&gt;</span><br><span class="line">val applicationVariants: DomainObjectSet&lt;ApplicationVariant&gt; =</span><br><span class="line">        dslServices.domainObjectSet(ApplicationVariant::class.java)</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>&nbsp;&nbsp;&nbsp;&nbsp;他们的类型还不通一个是LibraryVariant  一个是 ApplicationVariant;</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationVariant</span> <span class="keyword">extends</span> <span class="title">ApkVariant</span>, <span class="title">TestedVariant</span> </span>&#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LibraryVariant</span> <span class="keyword">extends</span> <span class="title">BaseVariant</span>, <span class="title">TestedVariant</span>, <span class="title">InternalBaseVariant</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function">Zip <span class="title">getPackageLibrary</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    @Nullable</span></span><br><span class="line"><span class="comment">    TaskProvider&lt;Zip&gt; getPackageLibraryProvider();</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></div></figure>


        <h1 id="Project">
          <a href="#Project" class="heading-link"><i class="fas fa-link"></i></a><a href="#Project" class="headerlink" title="Project"></a>Project</h1>
      
        <h2 id="TaskContainer">
          <a href="#TaskContainer" class="heading-link"><i class="fas fa-link"></i></a><a href="#TaskContainer" class="headerlink" title="TaskContainer"></a>TaskContainer</h2>
      <p>这是我们任何的仓库，所有的任务可以通过这个类扎到</p>

        <h2 id="ConfigurationContainer">
          <a href="#ConfigurationContainer" class="heading-link"><i class="fas fa-link"></i></a><a href="#ConfigurationContainer" class="headerlink" title="ConfigurationContainer"></a>ConfigurationContainer</h2>
      <p>他是管理我们dependency依赖</p>

        <h2 id="PluginAware">
          <a href="#PluginAware" class="heading-link"><i class="fas fa-link"></i></a><a href="#PluginAware" class="headerlink" title="PluginAware"></a>PluginAware</h2>
      <p>我们的project是继承他的，可以使用他的所有属性，比如最多的apply</p>

        <h1 id="Transform">
          <a href="#Transform" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h1>
      <p>每一个Transform的输出都是下一个transform的输入。并且还有一个很重要的一点，每一个自定义的Transform一定是在所有Transform之前执行，然后在得到所有java文件编译成class文件之后才执行。也因为这一点我们才可以进行插桩啥的。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/09/24/dex%E6%96%87%E4%BB%B6%E4%BA%86%E8%A7%A3/">dex文件了解</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-09-24</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-09-24</span></span></div></header><div class="post-body"><div class="post-excerpt"><p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000017059132?utm_source=sf-similar-article">浅谈 Android Dex 文件 - SegmentFault 思否</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>         </p>
<p>​        Dex文件是专门为Dalvik设计的一种压缩格式。JVM是JAVA虚拟机，用来运行JAVA字节码程序。Dalvik是Google设计用于Android平台的运行环境，现在已经逐渐被ART所替代。我们的Dalvik虚拟机并不支持直接运行JAVA字节码，所以需要对class文件进行翻译，重构，解释，压缩处理。处理完成的产物就是dex文件。</p>
<p>​         在<strong>AndroidSDK/build-tools/任意文件夹</strong> 里面点进去可以看到dx.jar 这个文件就是用来生成dex文件的。</p>
<p>从.java -&gt; .class</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String helloString = <span class="string">&quot;hello! youzan&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Hello hello = <span class="keyword">new</span> Hello();</span><br><span class="line">        hello.fun(hello.helloString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fun</span><span class="params">(String a)</span> </span>&#123;</span><br><span class="line">        System.out.println(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Hello.java</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>会得到文件 Hello.class</p>
</blockquote>
<p>从 .class -&gt; .dex</p>
<p>将Hello.class文件放到 AndroidSDK/build-tools/任意文件夹 里面 执行</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dx --dex --output=Hello.dex Hello.class</span><br></pre></td></tr></table></div></figure>

<p>执行完成后会在 当前文件生成 Hello.dex文件。</p>
<p>然后我们就可以通过010editor软件打开这个文件查看详情信息：</p>
<p><img src="/2021/09/24/dex%E6%96%87%E4%BB%B6%E4%BA%86%E8%A7%A3/%E6%96%87%E4%BB%B6%E8%AF%A6%E6%83%85.png" alt="img1"></p>
<p>每一部分的具体含义 可以参考博客讲的非常详细：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000017059132?utm_source=sf-similar-article">浅谈 Android Dex 文件 - SegmentFault 思否</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/09/18/androguard/">androguard</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-09-18</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-09-27</span></span></div></header><div class="post-body"><div class="post-excerpt"><p><strong>XREFS</strong>:</p>
<ul>
<li>xref_from：当前对象正在被其他对象调用</li>
<li>xref_to：当前对象在掉用其他对象</li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/09/18/Python/">Python</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-09-18</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-09-18</span></span></div></header><div class="post-body"><div class="post-excerpt"><p><strong>字符串前面放一个  r  的含义</strong>:</p>
<p>表示不转义，使用真是字符：比如：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s1 = <span class="string">r&#x27;test\tddd&#x27;</span></span><br><span class="line">s2 = <span class="string">&#x27;test\tddd&#x27;</span></span><br><span class="line"><span class="built_in">print</span> (s1) // test\tddd</span><br><span class="line"><span class="built_in">print</span> (s2) // test ddd</span><br></pre></td></tr></table></div></figure>

<p><strong>listdir(path)的path</strong>：</p>
<p>path：为<strong>文件夹</strong>的路径而不是<strong>文件</strong>的路径</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/09/08/Recycleview%E7%9A%84%E7%BB%98%E5%88%B6%E8%BF%87%E7%A8%8B/">Recycleview的绘制过程</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-09-08</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-11-12</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>掉用Recycleview的setAdapter的时候会去执行recycleview的requestlayout：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAdapter</span><span class="params">(<span class="meta">@Nullable</span> Adapter adapter)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// bail out if layout is frozen</span></span><br><span class="line">    setLayoutFrozen(<span class="keyword">false</span>);</span><br><span class="line">    setAdapterInternal(adapter, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    processDataSetCompletelyChanged(<span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 执行了requestlayout</span></span><br><span class="line">    requestLayout();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<p>然后在(Recycleview)onLayout里面执行了dispatchLayout:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    TraceCompat.beginSection(TRACE_ON_LAYOUT_TAG);</span><br><span class="line">    <span class="comment">// 执行了dispatchLayout</span></span><br><span class="line">    dispatchLayout();</span><br><span class="line">    TraceCompat.endSection();</span><br><span class="line">    mFirstLayoutComplete = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>接着调用dispatchLayout()，这里面可以看到很关键的三个方法：dispatchLayoutStep1()   dispatchLayoutStep2()   dispatchLayout3()。  最主要是在dispatchLayoutStep2()里面，有一个while循环，在whill循环里面我们通过判断当前itempostion的值是否小于我们在adapter里面设置的getItemCount()的值，来动态addView子view进去。现在我们来看下dispatchLayoutStep2()方法。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mAdapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// leave the state in START</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mLayout == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mState.mIsMeasuring = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mState.mLayoutStep == State.STEP_START) &#123;</span><br><span class="line">        dispatchLayoutStep1();</span><br><span class="line">        mLayout.setExactMeasureSpecsFrom(<span class="keyword">this</span>);</span><br><span class="line">        dispatchLayoutStep2();<span class="comment">// 里面有一个while循环，通过给定的adapter的getItemCount值，判断添加几个进去。</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mAdapterHelper.hasUpdates() || mLayout.getWidth() != getWidth()</span><br><span class="line">            || mLayout.getHeight() != getHeight()) &#123;</span><br><span class="line">        mLayout.setExactMeasureSpecsFrom(<span class="keyword">this</span>);</span><br><span class="line">        dispatchLayoutStep2();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mLayout.setExactMeasureSpecsFrom(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    dispatchLayoutStep3();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>来看下dispatchLayout2()</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchLayoutStep2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ----</span><br><span class="line">    mState.mItemCount = mAdapter.getItemCount();</span><br><span class="line">    mState.mDeletedInvisibleItemCountSincePreviousLayout = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: Run layout</span></span><br><span class="line">    mState.mInPreLayout = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 进行循环遍历addVie</span></span><br><span class="line">    mLayout.onLayoutChildren(mRecycler, mState);</span><br><span class="line"></span><br><span class="line">    mState.mStructureChanged = <span class="keyword">false</span>;</span><br><span class="line">    mPendingSavedState = <span class="keyword">null</span>;</span><br><span class="line">   ------</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>







<p>viewpager2每次调用setCurrentItem(position)的时候会触发requestlayout,requestlayout都是层层往上回归调用的，知道调用到viewRoomtImpl的requestlayout方法，然后调用到viewrootimpl的perfromTraversals方法。他又是由viewRootImpl的doTraversal调用。doTraversal是在一个runable里面调用的。</p>
<p>Recycleview的suppressLayout里面将mLayoutSuppressed</p>
<ul>
<li><p>mLayoutSuppressed：是否阻止recycleview的layout</p>
</li>
<li><p>mLayoutWasDefered：如果对 requestLayout 的调用被拦截并阻止正常执行，并且我们计划稍后继续正常执行，则为 True。 </p>
</li>
<li><p>mInterceptRequestLayoutDepth：当前调用startInterceptRequestLayout()的嵌套深度(调用startInterceptRequestLayout()的次数-调用stopInterceptRequestLayout的次数(boolean))。这用于指示我们是否应该推迟由RecyclerView子节点的布局请求引起的布局操作。</p>
</li>
</ul>
<p>Recycleview里面有一个教 mState：State 的变量，用来保存当前recycleliew当前所处于的状态，分别为：</p>
<ul>
<li>STEP_STARP= 1</li>
<li>STEP_LAYOUT = 1&lt;&lt;1</li>
<li>STEP_ANIMATIONS = 1</li>
</ul>
<p>默认情况下mState.mLayoutStep的初始值为STEP_START。</p>
<p>mState.mLayoutStep的值有三个地方进行赋值，分别为：</p>
<ul>
<li>Recycleview的dispatchLayoutStep1() 将其赋值为State.STEP_Layout</li>
<li>Recycleview的dispatchLayoutStep2() 将其赋值为State.Step.STEP_ANIMATIONS</li>
<li>Recycleview的dispatchLayout3() 将其赋值为State.STEP_START</li>
</ul>
<p>来看下Recycleview的onMeasure方法:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthSpec,<span class="keyword">int</span> heightSpec)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(mLayout.isAutoMeasureEnabled())&#123;</span><br><span class="line">        <span class="keyword">if</span>(mState.mLayoutStep == Step.STEP_START)&#123;</span><br><span class="line">            dispatchLayoutStep1();</span><br><span class="line">        &#125;</span><br><span class="line">        mState.mIsMeaturing = <span class="keyword">true</span>;</span><br><span class="line">        dispatchLayoutStep2();</span><br><span class="line">        <span class="keyword">if</span>(mLayout.shouldMeasureTwice())&#123;</span><br><span class="line">            mState.mIsMeasuring = <span class="keyword">true</span>;</span><br><span class="line">            dispatchLayoutStep2();</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    startInterceptRequestLayout(mRecycler,mState,widthSpec,heightSpec);</span><br><span class="line">    stopInterceptRequestLayout(<span class="keyword">false</span>);</span><br><span class="line">    mState.mInPreLayout = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>来看下onLayout方法：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed,<span class="keyword">int</span> l,<span class="keyword">int</span> t,<span class="keyword">int</span> r,<span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    dispatchLayout();</span><br><span class="line">    mFirstLayoutComplete = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>









<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Recycler&#123;</span><br><span class="line">   <span class="keyword">final</span> ArrayList&lt;ViewHolder&gt; mAttachedScrap = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        ArrayList&lt;ViewHolder&gt; mChangedScrap = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;ViewHolder&gt; mCachedViews = <span class="keyword">new</span> ArrayList&lt;ViewHolder&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ViewHolder&gt;</span><br><span class="line">                mUnmodifiableAttachedScrap = Collections.unmodifiableList(mAttachedScrap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<p>在onResume里面调用到Recycleview的onAttachToWindow方法，将参数mIsAttaches设置为了true。</p>
<p>然后Recycleview在onAttachToWindow里面里面调用了mLayout.dispatchAttachedToWindow()。</p>
<p>RecyckeView的布局分为三个步骤</p>
<ul>
<li>dispatchLayoutStep1</li>
<li>dispatchLayoutStep2</li>
<li>dispatchLayoutStep3</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mState.mIsMeasuring = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mState.mLayoutStep == State.STEP_START) &#123;</span><br><span class="line">        <span class="comment">// 解释在下面</span></span><br><span class="line">        dispatchLayoutStep1();</span><br><span class="line">        mLayout.setExactMeasureSpecsFrom(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        dispatchLayoutStep2();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mAdapterHelper.hasUpdates() || mLayout.getWidth() != getWidth()</span><br><span class="line">            || mLayout.getHeight() != getHeight()) &#123;</span><br><span class="line">        mLayout.setExactMeasureSpecsFrom(<span class="keyword">this</span>);</span><br><span class="line">        dispatchLayoutStep2();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mLayout.setExactMeasureSpecsFrom(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    dispatchLayoutStep3();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchLayoutStep1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// mLayoutStep的默认值是State.STEP_START</span></span><br><span class="line">    <span class="comment">// 判断当前状态mLayoutStep和设置进去的State值是否相等，如果不等就抛出异常，你在不对的状态去干了某个状态的事情</span></span><br><span class="line">    <span class="comment">// 比如在dispatchLayoutStep1()这个方法结束后里将mLayoutStep的值设置为State.STEP_LAYOUT</span></span><br><span class="line">    mState.assertLayoutStep(State.STEP_START);</span><br><span class="line">    <span class="comment">// 判断当前的滑动状况，如果还在滑动中那么将会设置state.mRemainingScrollHorizontal=还需滑动的距离</span></span><br><span class="line">    <span class="comment">// 如果滑动状况是SCROLL_STATE_IDLE空闲状态，那么剩余滑动距离就设置为0</span></span><br><span class="line">    fillRemainingScrollValues(mState);</span><br><span class="line">    <span class="comment">// 当前recycleview设置为不是正在测量状态</span></span><br><span class="line">    mState.mIsMeasuring = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 开启分发布局 将mInterceptRequestLayoutDepth++</span></span><br><span class="line">    <span class="comment">// 然后判断mInterceptRequestLayoutDept == 1 &amp;&amp; !mLayoutSuppressed</span></span><br><span class="line">    <span class="comment">//Suppressed(布局镇压) 如果没有被镇压那么就会设置 mLayoutWasDefered = false</span></span><br><span class="line">    <span class="comment">// Defered(延期)</span></span><br><span class="line">    startInterceptRequestLayout();</span><br><span class="line">    mViewInfoStore.clear();</span><br><span class="line">    <span class="comment">// 就干了一件事情mLayoutOrScrollCounter++</span></span><br><span class="line">    <span class="comment">// 布局或者滚动的计数器。他会在布局和滚动的时候才会增加</span></span><br><span class="line">    onEnterLayoutOrScroll();</span><br><span class="line">    processAdapterUpdatesAndSetAnimationFlags();</span><br><span class="line">    saveFocusInfo();</span><br><span class="line">    mState.mTrackOldChangeHolders = mState.mRunSimpleAnimations &amp;&amp; mItemsChanged;</span><br><span class="line">    mItemsAddedOrRemoved = mItemsChanged = <span class="keyword">false</span>;</span><br><span class="line">    mState.mInPreLayout = mState.mRunPredictiveAnimations;</span><br><span class="line">    mState.mItemCount = mAdapter.getItemCount();</span><br><span class="line">    <span class="comment">//找到最小最大子布局位置</span></span><br><span class="line">    findMinMaxChildLayoutPositions(mMinMaxLayoutPositions);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mRunSimpleAnimations的值默认为false</span></span><br><span class="line">    <span class="keyword">if</span> (mState.mRunSimpleAnimations) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mRunPredictiveAnimations默认为false</span></span><br><span class="line">    <span class="keyword">if</span> (mState.mRunPredictiveAnimations) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        clearOldPositions();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将mLayoutOrScrollCounter--  计数器减</span></span><br><span class="line">    onExitLayoutOrScroll();</span><br><span class="line">    <span class="comment">// 将mLayoutWasDefered = fasle</span></span><br><span class="line">    <span class="comment">// mInterceptRequestLayoutDepth--</span></span><br><span class="line">    stopInterceptRequestLayout(<span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 将当前布局状态设置为 State.STEP_LAYOUT</span></span><br><span class="line">    mState.mLayoutStep = State.STEP_LAYOUT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchLayoutStep2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 开启分发布局 将mInterceptRequestLayoutDepth++</span></span><br><span class="line">    <span class="comment">// 然后判断mInterceptRequestLayoutDept == 1 &amp;&amp; !mLayoutSuppressed</span></span><br><span class="line">    <span class="comment">// Suppressed(布局镇压) 如果没有被镇压那么就会设置 mLayoutWasDefered = false</span></span><br><span class="line">    <span class="comment">// Defered(延期)</span></span><br><span class="line">    startInterceptRequestLayout();</span><br><span class="line">    <span class="comment">// 就干了一件事情mLayoutOrScrollCounter++</span></span><br><span class="line">    <span class="comment">// 布局或者滚动的计数器。他会在布局和滚动的时候才会增加</span></span><br><span class="line">    onEnterLayoutOrScroll();</span><br><span class="line">    <span class="comment">// 判断当前状态对不对</span></span><br><span class="line">    mState.assertLayoutStep(State.STEP_LAYOUT | State.STEP_ANIMATIONS);</span><br><span class="line">    <span class="comment">// 跳过预处理，一次性应用所有更新。</span></span><br><span class="line">    mAdapterHelper.consumeUpdatesInOnePass();</span><br><span class="line">    mState.mItemCount = mAdapter.getItemCount();</span><br><span class="line">    <span class="comment">//删除了PreviousLayout后的不可见项目计数</span></span><br><span class="line">    mState.mDeletedInvisibleItemCountSincePreviousLayout = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: Run layout</span></span><br><span class="line">    <span class="comment">// 设置状态是不是准备在layout = false</span></span><br><span class="line">    mState.mInPreLayout = <span class="keyword">false</span>;</span><br><span class="line">    mLayout.onLayoutChildren(mRecycler, mState);</span><br><span class="line"></span><br><span class="line">    mState.mStructureChanged = <span class="keyword">false</span>;</span><br><span class="line">    mPendingSavedState = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    mState.mRunSimpleAnimations = mState.mRunSimpleAnimations &amp;&amp; mItemAnimator != <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 下一步状态设置为动画</span></span><br><span class="line">    mState.mLayoutStep = State.STEP_ANIMATIONS;</span><br><span class="line">    <span class="comment">// 将mLayoutOrScrollCounter--  计数器减</span></span><br><span class="line">    onExitLayoutOrScroll();</span><br><span class="line">    <span class="comment">// 将mLayoutWasDefered = fasle</span></span><br><span class="line">    <span class="comment">// mInterceptRequestLayoutDepth--</span></span><br><span class="line">    stopInterceptRequestLayout(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchLayoutStep3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mState.assertLayoutStep(State.STEP_ANIMATIONS);</span><br><span class="line">    startInterceptRequestLayout();</span><br><span class="line">    onEnterLayoutOrScroll();</span><br><span class="line">    <span class="comment">// 设置下一步的布局状态为START</span></span><br><span class="line">    mState.mLayoutStep = State.STEP_START;</span><br><span class="line">    <span class="comment">// 默认为false</span></span><br><span class="line">    <span class="keyword">if</span> (mState.mRunSimpleAnimations) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mLayout.removeAndRecycleScrapInt(mRecycler);</span><br><span class="line">    mState.mPreviousLayoutItemCount = mState.mItemCount;</span><br><span class="line">    mDataSetHasChangedAfterLayout = <span class="keyword">false</span>;</span><br><span class="line">    mDispatchItemsChangedEvent = <span class="keyword">false</span>;</span><br><span class="line">    mState.mRunSimpleAnimations = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    mState.mRunPredictiveAnimations = <span class="keyword">false</span>;</span><br><span class="line">    mLayout.mRequestedSimpleAnimations = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mRecycler.mChangedScrap != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mRecycler.mChangedScrap.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mLayout.mPrefetchMaxObservedInInitialPrefetch) &#123;</span><br><span class="line">        mLayout.mPrefetchMaxCountObserved = <span class="number">0</span>;</span><br><span class="line">        mLayout.mPrefetchMaxObservedInInitialPrefetch = <span class="keyword">false</span>;</span><br><span class="line">        mRecycler.updateViewCacheSize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mLayout.onLayoutCompleted(mState);</span><br><span class="line">    onExitLayoutOrScroll();</span><br><span class="line">    stopInterceptRequestLayout(<span class="keyword">false</span>);</span><br><span class="line">    mViewInfoStore.clear();</span><br><span class="line">    <span class="keyword">if</span> (didChildRangeChange(mMinMaxLayoutPositions[<span class="number">0</span>], mMinMaxLayoutPositions[<span class="number">1</span>])) &#123;</span><br><span class="line">        dispatchOnScrolled(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    recoverFocusFromState();</span><br><span class="line">    resetFocusInfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>分析完成可以看到Recycleview的页面展示是在disPatchLayoutStep2()里面的mLayout.onLayoutChildren(mRecycler,mState)。</p>
<p>看下LinearLayoutManager：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LinearLayoutManager.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLayoutChildren</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state)</span> </span>&#123;</span><br><span class="line"><span class="comment">//1)通过检查子节点和其他变量，找到一个锚点坐标和一个锚点项目位置。</span></span><br><span class="line"><span class="comment">//2)向开始填充，从底部堆叠</span></span><br><span class="line"><span class="comment">//3)向结束填充，从顶部堆叠</span></span><br><span class="line"><span class="comment">//4)滚动来满足像从底部堆叠这样的要求。创建布局状态</span></span><br><span class="line">    </span><br><span class="line"> <span class="comment">//fill的返回值是这次填充recycleviewh</span></span><br><span class="line">        <span class="keyword">if</span> (mPendingSavedState != <span class="keyword">null</span> || mPendingScrollPosition != RecyclerView.NO_POSITION) &#123;</span><br><span class="line">            <span class="keyword">if</span> (state.getItemCount() == <span class="number">0</span>) &#123;</span><br><span class="line">                removeAndRecycleAllViews(recycler);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mPendingSavedState != <span class="keyword">null</span> &amp;&amp; mPendingSavedState.hasValidAnchor()) &#123;</span><br><span class="line">            mPendingScrollPosition = mPendingSavedState.mAnchorPosition;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建对象LayoutState</span></span><br><span class="line">        ensureLayoutState();</span><br><span class="line">        <span class="comment">// 某些情况下，我们可能不想回收子布局(例如布局)</span></span><br><span class="line">        mLayoutState.mRecycle = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 如果是垂直布局：mShouldReverseLayout = false</span></span><br><span class="line">    	<span class="comment">// 否则 mShouldReverseLayout = true</span></span><br><span class="line">        resolveShouldLayoutReverse();</span><br><span class="line">     	<span class="comment">// 获取需要焦点的孩子view</span></span><br><span class="line">        <span class="keyword">final</span> View focused = getFocusedChild();</span><br><span class="line">     	<span class="comment">// 第一次布局的时候这里进不去 mPendingScrollPosition默认值就是NO_POSITION</span></span><br><span class="line">        <span class="keyword">if</span> (!mAnchorInfo.mValid || mPendingScrollPosition != RecyclerView.NO_POSITION</span><br><span class="line">                || mPendingSavedState != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mAnchorInfo.reset();</span><br><span class="line">            mAnchorInfo.mLayoutFromEnd = mShouldReverseLayout ^ mStackFromEnd;</span><br><span class="line">            updateAnchorInfoForLayout(recycler, state, mAnchorInfo);</span><br><span class="line">            mAnchorInfo.mValid = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// 第一次布局的时候focused是null</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (focused != <span class="keyword">null</span> &amp;&amp; (mOrientationHelper.getDecoratedStart(focused)</span><br><span class="line">                        &gt;= mOrientationHelper.getEndAfterPadding()</span><br><span class="line">                || mOrientationHelper.getDecoratedEnd(focused)</span><br><span class="line">                &lt;= mOrientationHelper.getStartAfterPadding())) &#123;</span><br><span class="line">           mAnchorInfo.assignFromViewAndKeepVisibleRect(focused, getPosition(focused));</span><br><span class="line">        &#125;</span><br><span class="line">     	<span class="comment">// 判断是上滑动还是下滑动</span></span><br><span class="line">        mLayoutState.mLayoutDirection = mLayoutState.mLastScrollDelta &gt;= <span class="number">0</span></span><br><span class="line">                ? LayoutState.LAYOUT_END : LayoutState.LAYOUT_START;</span><br><span class="line">        mReusableIntPair[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        mReusableIntPair[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">     	<span class="comment">// 计算剩余需要滑动的距离</span></span><br><span class="line">        calculateExtraLayoutSpace(state, mReusableIntPair);</span><br><span class="line">        <span class="keyword">int</span> extraForStart = Math.max(<span class="number">0</span>, mReusableIntPair[<span class="number">0</span>])</span><br><span class="line">                + mOrientationHelper.getStartAfterPadding();</span><br><span class="line">        <span class="keyword">int</span> extraForEnd = Math.max(<span class="number">0</span>, mReusableIntPair[<span class="number">1</span>])</span><br><span class="line">                + mOrientationHelper.getEndPadding();</span><br><span class="line">        <span class="keyword">if</span> (state.isPreLayout() &amp;&amp; mPendingScrollPosition != RecyclerView.NO_POSITION</span><br><span class="line">                &amp;&amp; mPendingScrollPositionOffset != INVALID_OFFSET) &#123;</span><br><span class="line">            <span class="keyword">final</span> View existing = findViewByPosition(mPendingScrollPosition);</span><br><span class="line">            <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> current;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> upcomingOffset;</span><br><span class="line">                <span class="keyword">if</span> (mShouldReverseLayout) &#123;</span><br><span class="line">                    current = mOrientationHelper.getEndAfterPadding()</span><br><span class="line">                            - mOrientationHelper.getDecoratedEnd(existing);</span><br><span class="line">                    upcomingOffset = current - mPendingScrollPositionOffset;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    current = mOrientationHelper.getDecoratedStart(existing)</span><br><span class="line">                            - mOrientationHelper.getStartAfterPadding();</span><br><span class="line">                    upcomingOffset = mPendingScrollPositionOffset - current;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (upcomingOffset &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    extraForStart += upcomingOffset;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    extraForEnd -= upcomingOffset;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> startOffset;</span><br><span class="line">        <span class="keyword">int</span> endOffset;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> firstLayoutDirection;</span><br><span class="line">        <span class="keyword">if</span> (mAnchorInfo.mLayoutFromEnd) &#123;</span><br><span class="line">            firstLayoutDirection = mShouldReverseLayout ? LayoutState.ITEM_DIRECTION_TAIL</span><br><span class="line">                    : LayoutState.ITEM_DIRECTION_HEAD;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            firstLayoutDirection = mShouldReverseLayout ? LayoutState.ITEM_DIRECTION_HEAD</span><br><span class="line">                    : LayoutState.ITEM_DIRECTION_TAIL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        onAnchorReady(recycler, state, mAnchorInfo, firstLayoutDirection);</span><br><span class="line">        detachAndScrapAttachedViews(recycler);</span><br><span class="line">        mLayoutState.mInfinite = resolveIsInfinite();</span><br><span class="line">        mLayoutState.mIsPreLayout = state.isPreLayout();</span><br><span class="line">        <span class="comment">// noRecycleSpace not needed: recycling doesn&#x27;t happen in below&#x27;s fill</span></span><br><span class="line">        <span class="comment">// invocations because mScrollingOffset is set to SCROLLING_OFFSET_NaN</span></span><br><span class="line">        mLayoutState.mNoRecycleSpace = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (mAnchorInfo.mLayoutFromEnd) &#123;</span><br><span class="line">            <span class="comment">// fill towards start</span></span><br><span class="line">            updateLayoutStateToFillStart(mAnchorInfo);</span><br><span class="line">            mLayoutState.mExtraFillSpace = extraForStart;</span><br><span class="line">            fill(recycler, mLayoutState, state, <span class="keyword">false</span>);</span><br><span class="line">            startOffset = mLayoutState.mOffset;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> firstElement = mLayoutState.mCurrentPosition;</span><br><span class="line">            <span class="keyword">if</span> (mLayoutState.mAvailable &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                extraForEnd += mLayoutState.mAvailable;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// fill towards end</span></span><br><span class="line">            updateLayoutStateToFillEnd(mAnchorInfo);</span><br><span class="line">            mLayoutState.mExtraFillSpace = extraForEnd;</span><br><span class="line">            mLayoutState.mCurrentPosition += mLayoutState.mItemDirection;</span><br><span class="line">            fill(recycler, mLayoutState, state, <span class="keyword">false</span>);</span><br><span class="line">            endOffset = mLayoutState.mOffset;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mLayoutState.mAvailable &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// end could not consume all. add more items towards start</span></span><br><span class="line">                extraForStart = mLayoutState.mAvailable;</span><br><span class="line">                updateLayoutStateToFillStart(firstElement, startOffset);</span><br><span class="line">                mLayoutState.mExtraFillSpace = extraForStart;</span><br><span class="line">                fill(recycler, mLayoutState, state, <span class="keyword">false</span>);</span><br><span class="line">                startOffset = mLayoutState.mOffset;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            updateLayoutStateToFillEnd(mAnchorInfo);</span><br><span class="line">            mLayoutState.mExtraFillSpace = extraForEnd;</span><br><span class="line">            <span class="comment">// 从我们AnchorInfo.mPosition位置往下布局</span></span><br><span class="line">            fill(recycler, mLayoutState, state, <span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 布局已知的item所消耗的距离，高度。</span></span><br><span class="line">            endOffset = mLayoutState.mOffset;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> lastElement = mLayoutState.mCurrentPosition;</span><br><span class="line">            <span class="keyword">if</span> (mLayoutState.mAvailable &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                extraForStart += mLayoutState.mAvailable;</span><br><span class="line">            &#125;</span><br><span class="line">            updateLayoutStateToFillStart(mAnchorInfo);</span><br><span class="line">            mLayoutState.mExtraFillSpace = extraForStart;</span><br><span class="line">            mLayoutState.mCurrentPosition += mLayoutState.mItemDirection;</span><br><span class="line">            <span class="comment">//从我们AnchorInfo.mPosition位置往上布局</span></span><br><span class="line">            fill(recycler, mLayoutState, state, <span class="keyword">false</span>);</span><br><span class="line">            startOffset = mLayoutState.mOffset;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mLayoutState.mAvailable &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                extraForEnd = mLayoutState.mAvailable;</span><br><span class="line">                updateLayoutStateToFillEnd(lastElement, endOffset);</span><br><span class="line">                mLayoutState.mExtraFillSpace = extraForEnd;</span><br><span class="line">                fill(recycler, mLayoutState, state, <span class="keyword">false</span>);</span><br><span class="line">                endOffset = mLayoutState.mOffset;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getChildCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mShouldReverseLayout ^ mStackFromEnd) &#123;</span><br><span class="line">                <span class="keyword">int</span> fixOffset = fixLayoutEndGap(endOffset, recycler, state, <span class="keyword">true</span>);</span><br><span class="line">                startOffset += fixOffset;</span><br><span class="line">                endOffset += fixOffset;</span><br><span class="line">                fixOffset = fixLayoutStartGap(startOffset, recycler, state, <span class="keyword">false</span>);</span><br><span class="line">                startOffset += fixOffset;</span><br><span class="line">                endOffset += fixOffset;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> fixOffset = fixLayoutStartGap(startOffset, recycler, state, <span class="keyword">true</span>);</span><br><span class="line">                startOffset += fixOffset;</span><br><span class="line">                endOffset += fixOffset;</span><br><span class="line">                fixOffset = fixLayoutEndGap(endOffset, recycler, state, <span class="keyword">false</span>);</span><br><span class="line">                startOffset += fixOffset;</span><br><span class="line">                endOffset += fixOffset;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        layoutForPredictiveAnimations(recycler, state, startOffset, endOffset);</span><br><span class="line">        <span class="keyword">if</span> (!state.isPreLayout()) &#123;</span><br><span class="line">            mOrientationHelper.onLayoutComplete();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mAnchorInfo.reset();</span><br><span class="line">        &#125;</span><br><span class="line">        mLastStackFromEnd = mStackFromEnd;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            validateChildOrder();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="detachAndScrapAttachedViews">
          <a href="#detachAndScrapAttachedViews" class="heading-link"><i class="fas fa-link"></i></a><a href="#detachAndScrapAttachedViews" class="headerlink" title="detachAndScrapAttachedViews"></a>detachAndScrapAttachedViews</h1>
      <p>通过直接的翻译：移除和添加view。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在代码里面我们发现recycleview使用了viewGrouo.detachViewFromParent()和attachViewToParent()。为什么要用这两个方法，因为这比起addView和removeView来说是轻量级的。它不会触发requestLayout方法。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;执行detachAndScrapAttachedViews方法，他将recycleview所有的view都执行了detach操作，从recycleview里面移除。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果这个viewHolder含有移除标志位 INVALID(无效) 或者 不含更新 或者 可以重用更新的</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;符合以上条件：这个viewHolder将会被添加到<code>mAttachedScrap</code>这个数组里面。否则添加到<code>mChangedScrap</code>数组里面。</p>
<ul>
<li>报废或回收视图</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scrapOrRecycleView</span><span class="params">(Recycler recycler, <span class="keyword">int</span> index, View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ViewHolder viewHolder = getChildViewHolderInt(view);</span><br><span class="line">    <span class="keyword">if</span> (viewHolder.shouldIgnore()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;ignoring view &quot;</span> + viewHolder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (viewHolder.isInvalid() &amp;&amp; !viewHolder.isRemoved()</span><br><span class="line">            &amp;&amp; !mRecyclerView.mAdapter.hasStableIds()) &#123;</span><br><span class="line">        removeViewAt(index);</span><br><span class="line">        recycler.recycleViewHolderInternal(viewHolder);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        detachViewAt(index);</span><br><span class="line">        recycler.scrapView(view);</span><br><span class="line">        mRecyclerView.mViewInfoStore.onViewDetached(viewHolder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>





<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mChildHelper = ChildHelper</span><br></pre></td></tr></table></div></figure>



<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mAdapterHelper = AdapterHelper</span><br></pre></td></tr></table></div></figure>



<p>在LinearLayoutManager的构造函数里面：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinearLayoutManager</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> defStyleRes)</span> </span>&#123;</span><br><span class="line">    Properties properties = getProperties(context, attrs, defStyleAttr, defStyleRes);</span><br><span class="line">    <span class="comment">// 初始化我们的方向计算辅助类 orientationHelper类</span></span><br><span class="line">    setOrientation(properties.orientation);</span><br><span class="line">    <span class="comment">// 设置我们布局方向是反向还是正向 mReverseLayout = true or false</span></span><br><span class="line">    setReverseLayout(properties.reverseLayout);</span><br><span class="line">    <span class="comment">// 设置填充方向 当 stack from bottom 设置为 true 时，列表从视图底部开始填充其内容 				// mStackFromEnd = true or false</span></span><br><span class="line">    setStackFromEnd(properties.stackFromEnd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrientation</span><span class="params">(<span class="meta">@RecyclerView</span>.Orientation <span class="keyword">int</span> orientation)</span> </span>&#123;</span><br><span class="line">    assertNotInLayoutOrScroll(<span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// mOrientation的默认值是vertical</span></span><br><span class="line">    <span class="comment">// mOrientationHelper 由于有很多关于方向上的计算需要处理，然后为了保持代码的易读性，就将计算的操作交给了OrientationHelper这个类做了。</span></span><br><span class="line">    <span class="comment">// 给mAnchorInfor设置上我们的方向计算器orientationHelper。</span></span><br><span class="line">    <span class="keyword">if</span> (orientation != mOrientation || mOrientationHelper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mOrientationHelper =<span class="comment">//创建了两个一个是垂直的方向计算 一个是水平创建</span></span><br><span class="line">                OrientationHelper.createOrientationHelper(<span class="keyword">this</span>, orientation);</span><br><span class="line">        mAnchorInfo.mOrientationHelper = mOrientationHelper;</span><br><span class="line">        mOrientation = orientation;</span><br><span class="line">        requestLayout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<p>页面上滑的时候滑动增量是大于0的，页面下滑的时候滑动增量式小于零：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过最后一刻的滑动增量 判断滑动方向，并且设置到LayoutState里面。</span></span><br><span class="line">mLayoutState.mLayoutDirection = mLayoutState.mLastScrollDelta &gt;= <span class="number">0</span></span><br><span class="line">        ? LayoutState.LAYOUT_END : LayoutState.LAYOUT_START;</span><br></pre></td></tr></table></div></figure>






        <h1 id="calculateExtraLayoutSpace">
          <a href="#calculateExtraLayoutSpace" class="heading-link"><i class="fas fa-link"></i></a><a href="#calculateExtraLayoutSpace" class="headerlink" title="calculateExtraLayoutSpace"></a>calculateExtraLayoutSpace</h1>
      <p>这个方法很重要，他是做缓存计算的，比如，如果你在向上滑动的时候，你想预加载下一项或者夏两项的时候，我们就可以通过这个方法，计算缓存的临界值。在LinearLayoutManager里面，他的计算会报错到extreLayoutSpace数组里面，extraLayoutSpace[0] = 顶部/左侧的额外空间。extraLayoutSpace[1]底部/右侧的额外空间。默认情况下，LinearlayoutManager在平滑滚动时会在滚动方向上额外不知一个项目，并在所有其他i情况下都不会布置额外的空间。你可以覆盖这个方法以实现自己的自定义预缓存逻辑。使用<code>Recycleview.State.hasTargerScrollPosition()</code>找出是否正在平滑滚动到某项位置，并使用<code>Recycleview.Satte.getTargetScrollPosition()</code>找出它正在滚动到哪个项目。</p>
<div align="center"><img src="/2021/09/08/Recycleview%E7%9A%84%E7%BB%98%E5%88%B6%E8%BF%87%E7%A8%8B/图1.png" alt="img-0" style="zoom: 50%;"></div>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 通过源码可以看到在LinearlayoutManager。缓存值是recycleview的高度。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">calculateExtraLayoutSpace</span><span class="params">(<span class="meta">@NonNull</span> RecyclerView.State state,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> <span class="keyword">int</span>[] extraLayoutSpace)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> extraLayoutSpaceStart = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> extraLayoutSpaceEnd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 看源码知道这个extraScrollSpace的值是recycleview的高度-顶部边距减去底部边距剩下的空间</span></span><br><span class="line">    <span class="keyword">int</span> extraScrollSpace = getExtraLayoutSpace(state);</span><br><span class="line">    <span class="comment">// mLayoutDirection在上面我们已经分析了。在onLayoutChildren方法里面</span></span><br><span class="line">    <span class="comment">// 会根据recycleview的每次滑动值也就是scrollby的值。判断是在向上滑动还是在向</span></span><br><span class="line">    <span class="comment">// 下滑动。</span></span><br><span class="line">    <span class="keyword">if</span> (mLayoutState.mLayoutDirection == LayoutState.LAYOUT_START) &#123;</span><br><span class="line">       <span class="comment">// 如果是向上滑动 就设置上的值 如果下就设置下的值</span></span><br><span class="line">        extraLayoutSpaceStart = extraScrollSpace;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        extraLayoutSpaceEnd = extraScrollSpace;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    extraLayoutSpace[<span class="number">0</span>] = extraLayoutSpaceStart;</span><br><span class="line">    extraLayoutSpace[<span class="number">1</span>] = extraLayoutSpaceEnd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="scrapOrRecycleView">
          <a href="#scrapOrRecycleView" class="heading-link"><i class="fas fa-link"></i></a><a href="#scrapOrRecycleView" class="headerlink" title="scrapOrRecycleView"></a>scrapOrRecycleView</h1>
      <ul>
<li>报废或回收视图</li>
</ul>
<p>就是做了个情况操作，把展示在recycleview的内容全部干掉</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scrapOrRecycleView</span><span class="params">(Recycler recycler, <span class="keyword">int</span> index, View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ViewHolder viewHolder = getChildViewHolderInt(view);</span><br><span class="line">    <span class="keyword">if</span> (viewHolder.shouldIgnore()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (viewHolder.isInvalid() &amp;&amp; !viewHolder.isRemoved()</span><br><span class="line">            &amp;&amp; !mRecyclerView.mAdapter.hasStableIds()) &#123;</span><br><span class="line">    <span class="comment">//如果这个viewHolder不可用了 &amp;&amp; 这个viewHolder没有被移除，那么就把这个view从</span></span><br><span class="line">    <span class="comment">//recycleview里面移除调</span></span><br><span class="line">        removeViewAt(index);</span><br><span class="line">    <span class="comment">//内部实现检查视图是否被废弃或附加，如果是则抛出异常。 公共版本在调用回收之前取消报废</span></span><br><span class="line">        recycler.recycleViewHolderInternal(viewHolder);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        detachViewAt(index);</span><br><span class="line">        recycler.scrapView(view);</span><br><span class="line">        mRecyclerView.mViewInfoStore.onViewDetached(viewHolder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="Recycler">
          <a href="#Recycler" class="heading-link"><i class="fas fa-link"></i></a><a href="#Recycler" class="headerlink" title="Recycler"></a>Recycler</h1>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">final ArrayList&lt;ViewHolder&gt; mAttachedScrap = new ArrayList&lt;&gt;();</span><br><span class="line">final ArrayList&lt;ViewHolder&gt; mCachedViews = new ArrayList&lt;ViewHolder&gt;();</span><br><span class="line">RecycledViewPool mRecyclerPool;</span><br></pre></td></tr></table></div></figure>

<p>这些数组都找不到对应的viewHolder,那么就会调用createViewHolder方法。</p>

        <h1 id="ChildHelper">
          <a href="#ChildHelper" class="heading-link"><i class="fas fa-link"></i></a><a href="#ChildHelper" class="headerlink" title="ChildHelper"></a>ChildHelper</h1>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">final List&lt;View&gt; mHiddenViews;</span><br></pre></td></tr></table></div></figure>




        <h1 id="AdapterHelper">
          <a href="#AdapterHelper" class="heading-link"><i class="fas fa-link"></i></a><a href="#AdapterHelper" class="headerlink" title="AdapterHelper"></a>AdapterHelper</h1>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">final ArrayList&lt;UpdateOp&gt; mPostponedList = new ArrayList&lt;UpdateOp&gt;();</span><br></pre></td></tr></table></div></figure>





<p>mPendingScrollPosition：目标要滚动到的位置</p>
<p>mAnchorInfo.mLayoutFromEnd：是从上往下还是从下往上。</p>
<p>在onLayoutChildren里面判断有没有目标滚动位置(mPendingScrollPosotion)。对AnchorInfo的数据进行了重置，然后设置了mAnchorInfo.mLayoutFromEnd的值(是从上往下还是从下往上布局)。然后执行了updateAnchorInfoForLayout方法目的是计算锥的位置和坐标。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LinearLayoutManager</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateAnchorInfoForLayout</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state,</span></span></span><br><span class="line"><span class="params"><span class="function">            AnchorInfo anchorInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (updateAnchorFromPendingData(state, anchorInfo)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (updateAnchorFromChildren(recycler, state, anchorInfo)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;deciding anchor info for fresh state&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// 设置值：AnchorInfo.mCoordinate = 如果是从尾开始布局那么mCoordinate的值 = 整个recycleviewde高度  如果是从头开始布局那么mCoordinate的值 = 就等于recyclew的paddingtop值。</span></span><br><span class="line">        anchorInfo.assignCoordinateFromPadding();</span><br><span class="line">    <span class="comment">// 设置当前布局的位置 anchorInfo的当前位置mPosition = 0</span></span><br><span class="line">        anchorInfo.mPosition = mStackFromEnd ? state.getItemCount() - <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="AnchorInfo">
          <a href="#AnchorInfo" class="heading-link"><i class="fas fa-link"></i></a><a href="#AnchorInfo" class="headerlink" title="AnchorInfo"></a>AnchorInfo</h1>
      <ul>
<li><p>mPosition：用户设置的最先起始布置的位置。默认为0。如果你想从中间开始布局，可以设置你的数据/2的那个位置。然后布局的时候他会从这个位置先往下布局布局结束后在往上</p>
</li>
<li><p>mCoordinate：我在onLayoutChildren的updateAnchorInfoForLayout看到了他的首次赋值是recycleview的paddingTop</p>
</li>
<li><p>mValid：默认为false。有效的意思。</p>
</li>
<li><p>mLayoutFromEnd：是从上往下还是从下往上布局。</p>
</li>
</ul>

        <h1 id="LayoutState">
          <a href="#LayoutState" class="heading-link"><i class="fas fa-link"></i></a><a href="#LayoutState" class="headerlink" title="LayoutState"></a>LayoutState</h1>
      <p>在onLayoutChildren里面进行了对象创建。</p>
<ul>
<li>mLayoutDirection: 根据每次的滑动值来判断滑动方向。如果mLastScrollDelta&gt;=0 则等于1 否则等于-1</li>
<li>mLastScrollDelta：滑动的改变值。</li>
<li>mInfinite：只有当recycleview的测量模式为UNSPECIFIED 并且 recycleview的高度为0，这个值才为true。他的中文意思是 无限。</li>
<li>mIsPreLayout： 他的值等于 state.isPreLayout</li>
<li>mRecycle = faslse</li>
<li>mNoRecycleSapce = 0</li>
<li>mAvailable：recycleview的高度 - 偏移量（初始的时候偏移量为0）。在滑动的时候 这个值等于 滑动的距离 - 最后一个视图全部展现出来需要滑动的距离。官方解释：在布局放向上，我们应该填充的像素数。</li>
<li>mScrollingOffset：默认值 = LayoutState.SCROLLING_OFFSET_NaN。这个值记录了最后一个子view全部展现在屏幕 或者最上面一个子view全部展现在屏幕上所需要滑动的距离。官方解释：在滚动的时候，这个值代表在不创建新的视图的情况下可以进行的滚动量。</li>
<li>mItemDirection：布局的方向，如果不是反向布局这个值等于1</li>
<li>mCurrentPosition：当前的位置他的首次赋值等于anchorInfo.mPosition</li>
<li>mLayoutDirection：等于1</li>
<li>mExtraFillSpace：中文翻译是额外填充空间。</li>
<li>mScrapList</li>
<li>mOffset：保存布局完成所有view所需要消耗的高度。根据方向进行的累加。每布局完成一次叠加一次。</li>
</ul>
<blockquote>
<p>这张图是对mAvailable 和 mScrollingOffset参数含义的演示。</p>
</blockquote>
<div align="center"><img src="/2021/09/08/Recycleview%E7%9A%84%E7%BB%98%E5%88%B6%E8%BF%87%E7%A8%8B/图4.png" alt="img-0" style="zoom: 50%;"></div>






        <h1 id="LayoutChunkResult">
          <a href="#LayoutChunkResult" class="heading-link"><i class="fas fa-link"></i></a><a href="#LayoutChunkResult" class="headerlink" title="LayoutChunkResult"></a>LayoutChunkResult</h1>
      <ul>
<li>mCinsumed：布局一个item所需要消耗的高度</li>
<li>mFinished：是否结束布局</li>
<li>mIgnoreConsumed：是否忽略这次布局的消耗值</li>
<li>mFocusable：是否获取焦点</li>
</ul>

        <h1 id="State">
          <a href="#State" class="heading-link"><i class="fas fa-link"></i></a><a href="#State" class="headerlink" title="State"></a>State</h1>
      <ul>
<li>mIsMeasuring: 表示是否正在测量 在onLayout的时候设置为了fasle</li>
<li>mLayoutStep：表示下一步所处阶段，根据这个变量来选择recycleview布局得三步走走哪个。</li>
<li>mRemainingScrollHorizontal: 在横向还需要滑动的距离。</li>
<li>mRemainingScrollVertical: 在纵向还需要滑动的距离。</li>
<li>mItemCount: 它的值等于我们给adapter设置的值。</li>
</ul>

        <h1 id="fill">
          <a href="#fill" class="heading-link"><i class="fas fa-link"></i></a><a href="#fill" class="headerlink" title="fill"></a>fill</h1>
      <p>LinearLayoutManager</p>
<p>哇 这个fill方法只是进行了addView操作，正真的页面平移是在fill结束后才进行的。我们可以看scrollBy方法：先执行了fill方法。然后在执行了offsetChildren方法。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">scrollBy</span><span class="params">(<span class="keyword">int</span> delta, RecyclerView.Recycler recycler, RecyclerView.State state)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// fill方法只是进行的addView操作.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> consumed = mLayoutState.mScrollingOffset</span><br><span class="line">                + fill(recycler, mLayoutState, state, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 这个offsetChildren方法才是真正的让页面进行了平移</span></span><br><span class="line">        mOrientationHelper.offsetChildren(-scrolled);</span><br><span class="line">        <span class="keyword">return</span> scrolled;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>正真进行视图的添加的方法：</strong></p>
<p>里面有一个循环，当剩下的布局空间 &gt; 0 那么就继续这个循环，往Recycleview里面添加布局view。每次添加完成一个view，remainSpace的值就会减去布局这个view所消耗的高度。叠减知道减到小于0。并且我们也没有更过的view的时候。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fill</span><span class="params">(RecyclerView.Recycler recycler, LayoutState layoutState,</span></span></span><br><span class="line"><span class="params"><span class="function">        RecyclerView.State state, <span class="keyword">boolean</span> stopOnFocusable)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这个值等于 recycleview的高度 - 偏移量（初始的时候偏移量为0）</span></span><br><span class="line">    <span class="comment">// 在触发页面滚动的时候，这个layoutState.mAvaliable的值等于</span></span><br><span class="line">    <span class="comment">// 等于: 这次页面的滑动距离  -  最后一个子view划出屏幕需要的距离  具体代码可以看</span></span><br><span class="line">    <span class="comment">//  updateLayoutState()</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> start = layoutState.mAvailable;</span><br><span class="line">    <span class="keyword">if</span> (layoutState.mScrollingOffset != LayoutState.SCROLLING_OFFSET_NaN) &#123;</span><br><span class="line">        <span class="comment">// 在触发滑动事件的时候，mScrollingOffset的值会被赋值为 最后一个子view全部展现在屏幕上所需要滑动的距离。所以在滑动的时候这个判断会成立，就进来了。</span></span><br><span class="line">            <span class="keyword">if</span> (layoutState.mAvailable &lt; <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// 小于0代表 这次触发的滑动的距离值 小于 最后一个子视图全部展示出来所需要的值</span></span><br><span class="line">         <span class="comment">// 这里减一下 mScrollingOffset = 这次滑动的触发的滑动距离</span></span><br><span class="line">                layoutState.mScrollingOffset += layoutState.mAvailable;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">// 这个方法可搞死我了。我放在下面详细讲解这个方法。 这个方法完成了对不可见视图的回收操作。</span></span><br><span class="line">            recycleByLayoutState(recycler, layoutState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// remainingSpace 剩余空间  1. 在触发滑动的时候 mAcailable的值 = 滑动距离 - 最后一个view全部划出屏幕需要的距离 如果滑动距离小于最后一个view全部出现距离，则不需要添加新的view进来，也就不会执行这个while循环里面的代码。也就不会执行addView代码。</span></span><br><span class="line">    <span class="comment">// 2. 在第一次布局的时候 mAvailable 的值等于 recycleview的高度</span></span><br><span class="line">    <span class="comment">// 这个remaingSpace起到了一个是否要执行addView的操作。1. 在初始化布局的时候，mAvailable的值是recycleview的高度，第一次布局页面是空的需要我们进行布局。</span></span><br><span class="line">    <span class="comment">// 2. 在滚动的时候，如果滚动的距离 小于最后一个view全部展示出来的view 则说明这次滚动不足以出现一个新的视图，那么我们就没必要执行addView操作。只有当滑动的距离大于了最后一个view全部展示出来的距离的时候才会触发addView操作。</span></span><br><span class="line">    <span class="keyword">int</span> remainingSpace = layoutState.mAvailable + layoutState.mExtraFillSpace;</span><br><span class="line">    LayoutChunkResult layoutChunkResult = mLayoutChunkResult;</span><br><span class="line">    <span class="comment">//mInfinite只有在recycleview的高度为0并且没有指定测量模式才会为true</span></span><br><span class="line">    <span class="comment">//remainingSpace:当偏移量超过了recycleview的高度的时候这个值会变成false</span></span><br><span class="line">    <span class="comment">// hasMore：当当前的mCurrentPosition大于adapter里面设置的值是 等于 fasle </span></span><br><span class="line">    <span class="keyword">while</span> ((layoutState.mInfinite || remainingSpace &gt; <span class="number">0</span>) &amp;&amp; layoutState.hasMore(state)) &#123;</span><br><span class="line">        <span class="comment">// 重置layoutChunkResult的状态</span></span><br><span class="line">        <span class="comment">// mConsumed=0.mFinished=fasle.mIgnoreConsumed=false.mFocusable=fasle</span></span><br><span class="line">        layoutChunkResult.resetInternal();</span><br><span class="line">        <span class="comment">// 进行布局</span></span><br><span class="line">        layoutChunk(recycler, state, layoutState, layoutChunkResult);</span><br><span class="line">        <span class="comment">// 当我们找不到一个可用的view的时候，这个view就等于了null 这个时候mFinished的值就是true</span></span><br><span class="line">        <span class="keyword">if</span> (layoutChunkResult.mFinished) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// layoutChunkResult.mConsumed值=布局一个item所需要消耗的高度</span></span><br><span class="line">        <span class="comment">// 累加所有view布局完成后消耗的值</span></span><br><span class="line">        layoutState.mOffset += layoutChunkResult.mConsumed * layoutState.mLayoutDirection;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Consume the available space if:</span></span><br><span class="line"><span class="comment">         * * layoutChunk did not request to be ignored</span></span><br><span class="line"><span class="comment">         * * OR we are laying out scrap children</span></span><br><span class="line"><span class="comment">         * * OR we are not doing pre-layout</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!layoutChunkResult.mIgnoreConsumed || layoutState.mScrapList != <span class="keyword">null</span></span><br><span class="line">                || !state.isPreLayout()) &#123;</span><br><span class="line">            <span class="comment">// 还剩下的可以布局的空间</span></span><br><span class="line">            layoutState.mAvailable -= layoutChunkResult.mConsumed;</span><br><span class="line">            <span class="comment">// 还剩下可以布局的空间</span></span><br><span class="line">            remainingSpace -= layoutChunkResult.mConsumed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (layoutState.mScrollingOffset != LayoutState.SCROLLING_OFFSET_NaN) &#123;</span><br><span class="line">            layoutState.mScrollingOffset += layoutChunkResult.mConsumed;</span><br><span class="line">            <span class="keyword">if</span> (layoutState.mAvailable &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                layoutState.mScrollingOffset += layoutState.mAvailable;</span><br><span class="line">            &#125;</span><br><span class="line">            recycleByLayoutState(recycler, layoutState);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (stopOnFocusable &amp;&amp; layoutChunkResult.mFocusable) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> start - layoutState.mAvailable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">layoutChunk</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state,</span></span></span><br><span class="line"><span class="params"><span class="function">            LayoutState layoutState, LayoutChunkResult result)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 从recycler里面获取我们需要的view</span></span><br><span class="line">     <span class="comment">// 分别从recycler的四级缓存里面拿，如果都找不到那么就去执行view的创建。执行我们熟知的onCreateViewHolder()</span></span><br><span class="line">     View view = layoutState.next(recycler);</span><br><span class="line">        <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 在recycler里面也找不到，创建view也失败了</span></span><br><span class="line">            result.mFinished = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        RecyclerView.LayoutParams params = (RecyclerView.LayoutParams) view.getLayoutParams();</span><br><span class="line">        <span class="keyword">if</span> (layoutState.mScrapList == <span class="keyword">null</span>) &#123;</span><br><span class="line">                addView(view);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                addDisappearingView(view);</span><br><span class="line">        &#125;</span><br><span class="line">        measureChildWithMargins(view, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">     	<span class="comment">//  mOrientationHelper.getDecoratedMeasurement(view); 获取的值是一个itemView所需要使用到的高度。marginTop bottom 分界线的高度都包括在里面。</span></span><br><span class="line">        result.mConsumed = mOrientationHelper.getDecoratedMeasurement(view);</span><br><span class="line">        <span class="keyword">int</span> left, top, right, bottom;</span><br><span class="line">        <span class="keyword">if</span> (mOrientation == VERTICAL) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isLayoutRTL()) &#123;</span><br><span class="line">                right = getWidth() - getPaddingRight();</span><br><span class="line">                left = right - mOrientationHelper.getDecoratedMeasurementInOther(view);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                left = getPaddingLeft();</span><br><span class="line">                right = left + mOrientationHelper.getDecoratedMeasurementInOther(view);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (layoutState.mLayoutDirection == LayoutState.LAYOUT_START) &#123;</span><br><span class="line">                bottom = layoutState.mOffset;</span><br><span class="line">                top = layoutState.mOffset - result.mConsumed;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                top = layoutState.mOffset;</span><br><span class="line">                bottom = layoutState.mOffset + result.mConsumed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            top = getPaddingTop();</span><br><span class="line">            bottom = top + mOrientationHelper.getDecoratedMeasurementInOther(view);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (layoutState.mLayoutDirection == LayoutState.LAYOUT_START) &#123;</span><br><span class="line">                right = layoutState.mOffset;</span><br><span class="line">                left = layoutState.mOffset - result.mConsumed;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                left = layoutState.mOffset;</span><br><span class="line">                right = layoutState.mOffset + result.mConsumed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">     	<span class="comment">// 布局view</span></span><br><span class="line">        layoutDecoratedWithMargins(view, left, top, right, bottom);</span><br><span class="line">        <span class="keyword">if</span> (params.isItemRemoved() || params.isItemChanged()) &#123;</span><br><span class="line">            result.mIgnoreConsumed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">     	<span class="comment">// 这个view是否有焦点</span></span><br><span class="line">        result.mFocusable = view.hasFocusable();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<div align="center"><img src="/2021/09/08/Recycleview%E7%9A%84%E7%BB%98%E5%88%B6%E8%BF%87%E7%A8%8B/图7.png" alt="img-0" style="zoom: 50%;"></div>




        <h1 id="Recycleview是怎么创建viewHolder的">
          <a href="#Recycleview是怎么创建viewHolder的" class="heading-link"><i class="fas fa-link"></i></a><a href="#Recycleview是怎么创建viewHolder的" class="headerlink" title="Recycleview是怎么创建viewHolder的"></a>Recycleview是怎么创建viewHolder的</h1>
      <p>这里需要看LinearLayoutManager的layoutChunk方法里的layoutState.next方法。</p>
<p>在next方法里面调用了recycler.getViewForPosition(position)方法获取想要的view。</p>
<p>来看下<code>recycler.getViewForPosition</code>：</p>

        <h1 id="recycler-getViewForPosition">
          <a href="#recycler-getViewForPosition" class="heading-link"><i class="fas fa-link"></i></a><a href="#recycler-getViewForPosition" class="headerlink" title="recycler.getViewForPosition"></a>recycler.getViewForPosition</h1>
      <p>首先进入getScrapOrHiddenOrCachedHolderForPostion方法：</p>
<p>遍历数组：<code>mAttachedScrap</code> ： 屏幕内</p>
<p>遍历数组：Childhelper.mHiddenViews </p>
<p>遍历数组：mCachedViews ： 屏幕外 大小为2</p>
<p>遍历数组：mViewCacheExtension ： 自定义缓存</p>
<p>遍历数组：mRecyclerPool : 缓存池</p>
<p>在没有的话：执行createViewHolder</p>

        <h1 id="updateLayoutState-int-layoutDirection-int-requiredSpace-booldean-canUseExistingSpace-Recycleview-State-state">
          <a href="#updateLayoutState-int-layoutDirection-int-requiredSpace-booldean-canUseExistingSpace-Recycleview-State-state" class="heading-link"><i class="fas fa-link"></i></a><a href="#updateLayoutState-int-layoutDirection-int-requiredSpace-booldean-canUseExistingSpace-Recycleview-State-state" class="headerlink" title="updateLayoutState(int layoutDirection,int requiredSpace,booldean canUseExistingSpace,Recycleview.State state)"></a>updateLayoutState(int layoutDirection,int requiredSpace,booldean canUseExistingSpace,Recycleview.State state)</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用来保存最后一个view全部展示出来需要滑动的距离</span></span><br><span class="line"><span class="comment">// 或者是最上面一个view全部展示出来需要的距离。</span></span><br><span class="line"><span class="comment">// 以及这次滑动值requireSpace - 最后一个view全部展示出来需要滑动的距离 他们的值的状态</span></span><br><span class="line"><span class="comment">// 如果大于0代表这次滑动最后一个view可以全部展示出来，需要去添加一个新view进来了。</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateLayoutState</span><span class="params">(<span class="keyword">int</span> layoutDirection, <span class="keyword">int</span> requiredSpace,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">boolean</span> canUseExistingSpace, RecyclerView.State state)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里假设手指运动方向是从下往上 则 layoutDirection = LayoutState.LAYOUT_END</span></span><br><span class="line">    mLayoutState.mInfinite = resolveIsInfinite(); <span class="comment">//fasle</span></span><br><span class="line">    mLayoutState.mLayoutDirection = layoutDirection; <span class="comment">// 1</span></span><br><span class="line">    mReusableIntPair[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    mReusableIntPair[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    calculateExtraLayoutSpace(state, mReusableIntPair);<span class="comment">// 现在看来啥也没干</span></span><br><span class="line">    <span class="keyword">int</span> extraForStart = Math.max(<span class="number">0</span>, mReusableIntPair[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">int</span> extraForEnd = Math.max(<span class="number">0</span>, mReusableIntPair[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">boolean</span> layoutToEnd = layoutDirection == LayoutState.LAYOUT_END;</span><br><span class="line">    mLayoutState.mExtraFillSpace = layoutToEnd ? extraForEnd : extraForStart;</span><br><span class="line">    mLayoutState.mNoRecycleSpace = layoutToEnd ? extraForStart : extraForEnd;</span><br><span class="line">    <span class="keyword">int</span> scrollingOffset;</span><br><span class="line">    <span class="keyword">if</span> (layoutToEnd) &#123;<span class="comment">//这里为true</span></span><br><span class="line">        <span class="comment">// 我没搞懂这里为啥要叠加recycleview的paddingBottom的值</span></span><br><span class="line">        mLayoutState.mExtraFillSpace += mOrientationHelper.getEndPadding();</span><br><span class="line">        <span class="comment">// 找到最底下的view</span></span><br><span class="line">        <span class="keyword">final</span> View child = getChildClosestToEnd();</span><br><span class="line">        <span class="comment">// 由于不是反向布局 这里的mItemDirection = 1</span></span><br><span class="line">        mLayoutState.mItemDirection = mShouldReverseLayout ? LayoutState.ITEM_DIRECTION_HEAD</span><br><span class="line">                : LayoutState.ITEM_DIRECTION_TAIL;</span><br><span class="line">        <span class="comment">// 比如我们页面已经添加了12个子view，那么这个getPosition(child)的值就是11 然后 由于是下上滑动的那么mItemDirection的值就是1  结果显而易见 mLayoutState.mCurrentPositiond = 11 + 1</span></span><br><span class="line">        mLayoutState.mCurrentPosition = getPosition(child) + mLayoutState.mItemDirection;</span><br><span class="line">        <span class="comment">// mOffset 的值 等于 当前这个view距离父视图底部的距离。bottom的值。</span></span><br><span class="line">        mLayoutState.mOffset = mOrientationHelper.getDecoratedEnd(child);</span><br><span class="line">        <span class="comment">// calculate how much we can scroll without adding new children (independent of layout)</span></span><br><span class="line">        <span class="comment">// mOrientationHelper.getDecoratedEnd(child) 由于这个child是最底部的这个子视图。所以这个获取的值就是最底下的view距离recycleview顶部的距离。</span></span><br><span class="line">        <span class="comment">//mOrientationHelper.getEndAfterPadding()获取的是recycleview的高度-paddingBottom值</span></span><br><span class="line">        <span class="comment">// 这两个一减代表最后一个字view全部出现到屏幕上需要移动的距离</span></span><br><span class="line">        scrollingOffset = mOrientationHelper.getDecoratedEnd(child)</span><br><span class="line">                - mOrientationHelper.getEndAfterPadding();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> View child = getChildClosestToStart();</span><br><span class="line">        mLayoutState.mExtraFillSpace += mOrientationHelper.getStartAfterPadding();</span><br><span class="line">        mLayoutState.mItemDirection = mShouldReverseLayout ? LayoutState.ITEM_DIRECTION_TAIL</span><br><span class="line">                : LayoutState.ITEM_DIRECTION_HEAD;</span><br><span class="line">        mLayoutState.mCurrentPosition = getPosition(child) + mLayoutState.mItemDirection;</span><br><span class="line">        mLayoutState.mOffset = mOrientationHelper.getDecoratedStart(child);</span><br><span class="line">        <span class="comment">// 最上面一个view全部出现到屏幕上需要移动的距离</span></span><br><span class="line">        scrollingOffset = -mOrientationHelper.getDecoratedStart(child)</span><br><span class="line">                + mOrientationHelper.getStartAfterPadding();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// requiredSpace的值就是滚动的值</span></span><br><span class="line">    mLayoutState.mAvailable = requiredSpace;</span><br><span class="line">    <span class="comment">// 这个canUseExistingSpace的值等于true</span></span><br><span class="line">    <span class="keyword">if</span> (canUseExistingSpace) &#123;</span><br><span class="line">    <span class="comment">// scrollingOffset代表最后一个view全部划出屏幕的距离</span></span><br><span class="line">    <span class="comment">// mLayoutState.mAvailable 代表此次滑动需要的距离</span></span><br><span class="line">    <span class="comment">// 两者一减： 如果结果&gt;0 代表最后一个view已经全部出现在屏幕了，这个时候需要去添加一个新的view</span></span><br><span class="line">       <span class="comment">// 如果减的&lt;0，则代表最后一个视图还不足以全部出现，也就不用添加新的页面了</span></span><br><span class="line">        mLayoutState.mAvailable -= scrollingOffset;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置为最后一个view全部展示出来需要的距离</span></span><br><span class="line">    mLayoutState.mScrollingOffset = scrollingOffset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;再触发一次滑动的时候，比如这次滑动距离为 10 。 最后一个view全部展示出来需要的距离为20。那么：mAvailable = 10 - 20 = -10  mScrollingOffset = 20。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;然后进入fill方法。当mAvailable&lt;0 那么重新给mScrollingOffset 设值为： 20 - 10 = 10</p>

        <h1 id="scrollBy">
          <a href="#scrollBy" class="heading-link"><i class="fas fa-link"></i></a><a href="#scrollBy" class="headerlink" title="scrollBy"></a>scrollBy</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LinearLayoutManager</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">scrollBy</span><span class="params">(<span class="keyword">int</span> delta, RecyclerView.Recycler recycler, RecyclerView.State state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getChildCount() == <span class="number">0</span> || delta == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ensureLayoutState();</span><br><span class="line">    mLayoutState.mRecycle = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = delta &gt; <span class="number">0</span> ? LayoutState.LAYOUT_END : LayoutState.LAYOUT_START;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> absDelta = Math.abs(delta);</span><br><span class="line">    <span class="comment">// 这个方法上面讲了是干嘛的。</span></span><br><span class="line">    updateLayoutState(layoutDirection, absDelta, <span class="keyword">true</span>, state);</span><br><span class="line">    <span class="comment">// mLayoutState.mScrollingOffset 表示最后一个子view全部展现在屏幕上所需要的距离</span></span><br><span class="line">    <span class="comment">// 或者是最顶上的view全部展现在屏幕上需要的距离</span></span><br><span class="line">    <span class="comment">// 现在需要看下这个fill干了啥</span></span><br><span class="line">    <span class="comment">// 如果这次滑动的距离不足以让最后一个view展示出来的话，那么fill的返回值就为0</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> consumed = mLayoutState.mScrollingOffset</span><br><span class="line">            + fill(recycler, mLayoutState, state, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (consumed &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 表示没消耗滑动距离</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> scrolled = absDelta &gt; consumed ? layoutDirection * consumed : delta;</span><br><span class="line">   <span class="comment">// 这里会回调到recycleview里面执行offsetChildrenVertical方法。遍历全部的view执行offsetTopAndBottom方法。实现他们的位移变化。</span></span><br><span class="line">    <span class="comment">// 既然这里是做了位移变化，那上面的fill方法是在干嘛？</span></span><br><span class="line">    mOrientationHelper.offsetChildren(-scrolled);</span><br><span class="line">    mLayoutState.mLastScrollDelta = scrolled;</span><br><span class="line">    <span class="keyword">return</span> scrolled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="recycleByLayoutState">
          <a href="#recycleByLayoutState" class="heading-link"><i class="fas fa-link"></i></a><a href="#recycleByLayoutState" class="headerlink" title="recycleByLayoutState"></a>recycleByLayoutState</h1>
      <blockquote>
<p> LinearLayoutManager</p>
</blockquote>
<p><strong>这个方法完成了对不可见视图的回收操作。</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recycleByLayoutState</span><span class="params">(RecyclerView.Recycler recycler, LayoutState layoutState)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 触发滑动的时候，mRecycle设置为了true</span></span><br><span class="line">    <span class="keyword">if</span> (!layoutState.mRecycle || layoutState.mInfinite) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在方法fill里面。执行了layoutState.mScrollingOffset += layoutState.mAvailable;</span></span><br><span class="line">    <span class="comment">// 由于mAvailable 的值 = 滑动距离 - 最后一个子view全部展示在屏幕需要滑动的距离</span></span><br><span class="line">    <span class="comment">// 得出 mScrollingOffset = 此次的滑动距离</span></span><br><span class="line">    <span class="keyword">int</span> scrollingOffset = layoutState.mScrollingOffset;</span><br><span class="line">    <span class="keyword">int</span> noRecycleSpace = layoutState.mNoRecycleSpace;<span class="comment">//为0</span></span><br><span class="line">    <span class="keyword">if</span> (layoutState.mLayoutDirection == LayoutState.LAYOUT_START) &#123;</span><br><span class="line">        <span class="comment">// 这是往下滑</span></span><br><span class="line">        recycleViewsFromEnd(recycler, scrollingOffset, noRecycleSpace);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 往上滑触发 也就是手指从下往上</span></span><br><span class="line">        recycleViewsFromStart(recycler, scrollingOffset, noRecycleSpace);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recycleViewsFromStart</span><span class="params">(RecyclerView.Recycler recycler, <span class="keyword">int</span> scrollingOffset,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> noRecycleSpace)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//scrollingOffset 此次的滑距离</span></span><br><span class="line">    <span class="keyword">if</span> (scrollingOffset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// limit 此次的滑动距离</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> limit = scrollingOffset - noRecycleSpace;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            View child = getChildAt(i);</span><br><span class="line">    <span class="comment">// 这里干了见很重要的事情，用来判断是否要回收那些看不到的view</span></span><br><span class="line">    <span class="comment">// getDecoratedEnd 获取的是当前child的getBottom()的值。也就是child全部划出屏幕需要走的距离。见图：</span></span><br><span class="line">        <span class="comment">// getTransformedEndWithDecoration 这个方法得到的结果 child.height - child.getTop</span></span><br><span class="line">        <span class="comment">// 得到的结果还是 这个child划出屏幕所需要的距离。</span></span><br><span class="line">            <span class="keyword">if</span> (mOrientationHelper.getDecoratedEnd(child) &gt; limit</span><br><span class="line">                    || mOrientationHelper.getTransformedEndWithDecoration(child) &gt; limit) &#123;</span><br><span class="line">                recycleChildren(recycler, <span class="number">0</span>, i);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<div align="center"><img src="/2021/09/08/Recycleview%E7%9A%84%E7%BB%98%E5%88%B6%E8%BF%87%E7%A8%8B/图2.png" alt="img-0" style="zoom: 50%;"></div>




        <h1 id="ScrollVectorProvider">
          <a href="#ScrollVectorProvider" class="heading-link"><i class="fas fa-link"></i></a><a href="#ScrollVectorProvider" class="headerlink" title="ScrollVectorProvider"></a>ScrollVectorProvider</h1>
      <p>这是一个接口，在Recycleview出现惯性滑动得时候会被调用：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ScrollVectorProvider</span> </span>&#123;</span><br><span class="line">           <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * 应该计算指向可以找到目标位置的方向的向量。</span></span><br><span class="line"><span class="comment">		 *LinearSmoothScroller使用此方法启动向目标位置的滚动。</span></span><br><span class="line"><span class="comment">		 *矢量的大小并不重要。 在被LinearSmoothScroller使用之前它总是被标准化。</span></span><br><span class="line"><span class="comment">	     *LayoutManager 不应该检查该位置是否存在于适配器中。</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="meta">@Nullable</span></span><br><span class="line">           <span class="function">PointF <span class="title">computeScrollVectorForPosition</span><span class="params">(<span class="keyword">int</span> targetPosition)</span></span>;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LinearSmoothScroller</span><br></pre></td></tr></table></div></figure>




        <h1 id="SnapHelper">
          <a href="#SnapHelper" class="heading-link"><i class="fas fa-link"></i></a><a href="#SnapHelper" class="headerlink" title="SnapHelper"></a>SnapHelper</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">snapFromFling</span><span class="params">(<span class="meta">@NonNull</span> RecyclerView.LayoutManager layoutManager, <span class="keyword">int</span> velocityX,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> velocityY)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 判断recycleview是否继承了接口ScrollVectorProvider</span></span><br><span class="line">    <span class="comment">// 很明显recycleview继承了。</span></span><br><span class="line">    <span class="keyword">if</span> (!(layoutManager <span class="keyword">instanceof</span> RecyclerView.SmoothScroller.ScrollVectorProvider)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建对象LinearSmoothScroller</span></span><br><span class="line">    RecyclerView.SmoothScroller smoothScroller = createScroller(layoutManager);</span><br><span class="line">    <span class="keyword">if</span> (smoothScroller == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到目标滚动到的位置</span></span><br><span class="line">    <span class="comment">// 原理就是 先计算recycleview的中心点位置，然后遍历所有的孩子。找到那个孩子（child.getTop + child.高度/2）这个值距离recycleiew中心点最近和最远的那两个view</span></span><br><span class="line">    <span class="comment">// 然后通过滑动防线判断是获取这两个哪个孩子的位置为最终位置 然后返回出来。</span></span><br><span class="line">    <span class="keyword">int</span> targetPosition = findTargetSnapPosition(layoutManager, velocityX, velocityY);</span><br><span class="line">    <span class="keyword">if</span> (targetPosition == RecyclerView.NO_POSITION) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    smoothScroller.setTargetPosition(targetPosition);</span><br><span class="line">    <span class="comment">// 让recycleview滚动到指定位置  我们可以学习这部分代码让recycleview平滑的滚动到指定位置</span></span><br><span class="line">    layoutManager.startSmoothScroll(smoothScroller);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">protected</span> RecyclerView.<span class="function">SmoothScroller <span class="title">createScroller</span><span class="params">(RecyclerView.LayoutManager layoutManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createSnapScroller(layoutManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> LinearSmoothScroller <span class="title">createSnapScroller</span><span class="params">(RecyclerView.LayoutManager layoutManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(layoutManager <span class="keyword">instanceof</span> RecyclerView.SmoothScroller.ScrollVectorProvider)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LinearSmoothScroller(mRecyclerView.getContext()) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onTargetFound</span><span class="params">(View targetView, RecyclerView.State state, Action action)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (mRecyclerView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span>[] snapDistances = calculateDistanceToFinalSnap(mRecyclerView.getLayoutManager(),</span><br><span class="line">                        targetView);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> dx = snapDistances[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> dy = snapDistances[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> time = calculateTimeForDeceleration(Math.max(Math.abs(dx), Math.abs(dy)));</span><br><span class="line">                <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    action.update(dx, dy, time, mDecelerateInterpolator);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">float</span> <span class="title">calculateSpeedPerPixel</span><span class="params">(DisplayMetrics displayMetrics)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> MILLISECONDS_PER_INCH / displayMetrics.densityDpi;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="PagerSnapHelper">
          <a href="#PagerSnapHelper" class="heading-link"><i class="fas fa-link"></i></a><a href="#PagerSnapHelper" class="headerlink" title="PagerSnapHelper"></a>PagerSnapHelper</h1>
      <p>研究下他是怎么通过手指头抬起得速度判断是否需要滑动到下一页：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个方法的返回值就是目标item位置，最终recycleview停下的位置</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findTargetSnapPosition</span><span class="params">(RecyclerView.LayoutManager layoutManager, <span class="keyword">int</span> velocityX,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> velocityY)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这个count是我们在adapter里面设置得总数。</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> itemCount = layoutManager.getItemCount();</span><br><span class="line">    <span class="keyword">if</span> (itemCount == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> RecyclerView.NO_POSITION;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这个对象上面已经分析过了，分为垂直的和横向的</span></span><br><span class="line">    <span class="keyword">final</span> OrientationHelper orientationHelper = getOrientationHelper(layoutManager);</span><br><span class="line">    <span class="keyword">if</span> (orientationHelper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> RecyclerView.NO_POSITION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//closestChildBeforeCenter: 距离recycleview中点上面最近的一个点</span></span><br><span class="line">    View closestChildBeforeCenter = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> distanceBefore = Integer.MIN_VALUE;</span><br><span class="line">    <span class="comment">//closestChildAfterCenter: 距离recycleview中心点下面最近的一个点</span></span><br><span class="line">    View closestChildAfterCenter = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> distanceAfter = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//找到中心之前的第一个视图和中心之后的第一个视图</span></span><br><span class="line">    <span class="comment">// getChildCount的值是 recycleview这个viewGroup里面包含的孩子数量。和getItenCount的值不一样。</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = layoutManager.getChildCount();</span><br><span class="line">    <span class="comment">// 通过这么一个循环。遍历了全部的子view用来寻找这个距离recycleview中心点之前最近的一个view 。 找出一个距离recycleview中心点下面最近的一个点。</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> View child = layoutManager.getChildAt(i);</span><br><span class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 找到item处理recycleview中间的位置。</span></span><br><span class="line">        <span class="comment">// 计算方法 distance = （目标child距离recycleView的getTop() + child的高度/2） - （recycleview的高度/2）</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> distance = distanceToCenter(layoutManager, child, orientationHelper);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (distance &lt;= <span class="number">0</span> &amp;&amp; distance &gt; distanceBefore) &#123;</span><br><span class="line">            <span class="comment">// distance小于0代表 这个child的中心点在recycleview的中心点上面</span></span><br><span class="line">            distanceBefore = distance;</span><br><span class="line">            closestChildBeforeCenter = child;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (distance &gt;= <span class="number">0</span> &amp;&amp; distance &lt; distanceAfter) &#123;</span><br><span class="line">           <span class="comment">// distance小于0代表 这个child的中心点在recycleview的中心点下面</span></span><br><span class="line">            distanceAfter = distance;</span><br><span class="line">            closestChildAfterCenter = child;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 上面一个循环走完 也就找到了两个距离中心点一上一下最近的点了。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回第一个孩子的位置，从中心，在投掷的方向</span></span><br><span class="line">    <span class="comment">// 如果这个layoutManager是支持横向滑动的然后如果 veloityX&gt;0则返回true</span></span><br><span class="line">    <span class="comment">// 否则 veloctyY&gt;0 返回true</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forwardDirection = isForwardFling(layoutManager, velocityX, velocityY);</span><br><span class="line">    <span class="comment">// 然后通过滑动方向，判断是拿距离中心点上面最近的view还是拿距离中心点下面最近的view</span></span><br><span class="line">    <span class="keyword">if</span> (forwardDirection &amp;&amp; closestChildAfterCenter != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> layoutManager.getPosition(closestChildAfterCenter);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!forwardDirection &amp;&amp; closestChildBeforeCenter != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> layoutManager.getPosition(closestChildBeforeCenter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面这里很少情况会触发。。以下不是正常情况会发生的</span></span><br><span class="line">    View visibleView = forwardDirection ? closestChildBeforeCenter : closestChildAfterCenter;</span><br><span class="line">    <span class="keyword">if</span> (visibleView == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> RecyclerView.NO_POSITION;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> visiblePosition = layoutManager.getPosition(visibleView);</span><br><span class="line">    <span class="keyword">int</span> snapToPosition = visiblePosition</span><br><span class="line">            + (isReverseLayout(layoutManager) == forwardDirection ? -<span class="number">1</span> : +<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snapToPosition &lt; <span class="number">0</span> || snapToPosition &gt;= itemCount) &#123;</span><br><span class="line">        <span class="keyword">return</span> RecyclerView.NO_POSITION;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> snapToPosition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>可以看到在recycleview内部是通过LayoutManager.getPosition的方法获取view的位置的。再看getPosition的源码。是通过view去获得他的viewHolder然后掉用viewHolder.getLayoutPosition方法获取的</strong></p>

        <h1 id="自己想让recycleview滚动起来可以怎么做：">
          <a href="#自己想让recycleview滚动起来可以怎么做：" class="heading-link"><i class="fas fa-link"></i></a><a href="#自己想让recycleview滚动起来可以怎么做：" class="headerlink" title="自己想让recycleview滚动起来可以怎么做："></a>自己想让recycleview滚动起来可以怎么做：</h1>
      <p>在看PagerSnapHelper的源码发现。</p>
<p>在实现惯性滑动的时候，recycleview的底层是通过这样的方法让recycleview滚动起来的。：</p>
<ol>
<li>首先我们需要new一个Recycleview.SmoothScroller对象</li>
<li>给Recycleview.SmoothScroller对象设置一个目标滚动位置</li>
<li>调用layoutManager的startSmoothScroll(RecycleView.SmaoothScroller)方法</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这部分全部代码在 SnaperHelper的 snapFromFling()方法里面。</span></span><br><span class="line"><span class="comment">// 创建Recycleview.SmoothScroller对象       </span></span><br><span class="line">RecyclerView.SmoothScroller smoothScroller = createScroller(layoutManager);</span><br><span class="line">        <span class="keyword">if</span> (smoothScroller == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> targetPosition = <span class="number">10</span></span><br><span class="line"><span class="comment">// 设置滚动到的位置</span></span><br><span class="line">        smoothScroller.setTargetPosition(targetPosition);</span><br><span class="line"><span class="comment">// 然recycleview滚动起来</span></span><br><span class="line">        layoutManager.startSmoothScroll(smoothScroller);</span><br></pre></td></tr></table></div></figure>




        <h1 id="LayoutManger-startSmaoothScroll-SmoothScroller-smoothScroller">
          <a href="#LayoutManger-startSmaoothScroll-SmoothScroller-smoothScroller" class="heading-link"><i class="fas fa-link"></i></a><a href="#LayoutManger-startSmaoothScroll-SmoothScroller-smoothScroller" class="headerlink" title="LayoutManger.startSmaoothScroll(SmoothScroller smoothScroller)"></a>LayoutManger.startSmaoothScroll(SmoothScroller smoothScroller)</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startSmoothScroll</span><span class="params">(SmoothScroller smoothScroller)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mSmoothScroller != <span class="keyword">null</span> &amp;&amp; smoothScroller != mSmoothScroller</span><br><span class="line">            &amp;&amp; mSmoothScroller.isRunning()) &#123;</span><br><span class="line">        mSmoothScroller.stop();</span><br><span class="line">    &#125;</span><br><span class="line">    mSmoothScroller = smoothScroller;</span><br><span class="line">    mSmoothScroller.start(mRecyclerView, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Recycleview</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">(RecyclerView recyclerView, LayoutManager layoutManager)</span> </span>&#123;</span><br><span class="line">    recyclerView.mViewFlinger.stop();</span><br><span class="line">    mRecyclerView = recyclerView;</span><br><span class="line">    mLayoutManager = layoutManager;</span><br><span class="line">    <span class="keyword">if</span> (mTargetPosition == RecyclerView.NO_POSITION) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Invalid target position&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 可以看到在触发滑动的时候才会给mTargetPostion参数赋值</span></span><br><span class="line">    mRecyclerView.mState.mTargetPosition = mTargetPosition;</span><br><span class="line">    mRunning = <span class="keyword">true</span>;</span><br><span class="line">    mPendingInitialRun = <span class="keyword">true</span>;</span><br><span class="line">    mTargetView = findViewByPosition(getTargetPosition());</span><br><span class="line">    onStart();</span><br><span class="line">    <span class="comment">// 发送了动画播放消息</span></span><br><span class="line">    <span class="comment">// 这个mViewFlinger是一个继承Runnable的类。显而易见这个是一个消息</span></span><br><span class="line">    mRecyclerView.mViewFlinger.postOnAnimation();</span><br><span class="line"></span><br><span class="line">    mStarted = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">postOnAnimation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//mEatRunOnAnimationRequest 这个参数是延迟播放的意思 如果要延迟 这个参数为true</span></span><br><span class="line">    <span class="comment">// 默认为false</span></span><br><span class="line">   <span class="keyword">if</span> (mEatRunOnAnimationRequest) &#123;</span><br><span class="line">         mReSchedulePostAnimationCallback = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="comment">// 进到这里</span></span><br><span class="line">         internalPostOnAnimation();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">internalPostOnAnimation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 移除message消息</span></span><br><span class="line">      removeCallbacks(<span class="keyword">this</span>);</span><br><span class="line">   <span class="comment">// 向消息队列里面发送一个关于滚动视图的消息</span></span><br><span class="line">    <span class="comment">// 这里把消息插入到了ViewRootImpl里面触发 这里也很有研究价值</span></span><br><span class="line">      ViewCompat.postOnAnimation(RecyclerView.<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>// 可以看到一个滚动的message被发送了出去。所以可以看类ViewFlinger的run方法：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ViewFlinger 他是recycleview的内部类 </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (mLayout == <span class="keyword">null</span>) &#123;</span><br><span class="line">                stop();</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// no layout, cannot scroll.</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mReSchedulePostAnimationCallback = <span class="keyword">false</span>;</span><br><span class="line">            mEatRunOnAnimationRequest = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            consumePendingUpdateOperations();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// TODO(72745539): After reviewing the code, it seems to me we may actually want to</span></span><br><span class="line">            <span class="comment">// update the reference to the OverScroller after onAnimation.  It looks to me like</span></span><br><span class="line">            <span class="comment">// it is possible that a new OverScroller could be created (due to a new Interpolator</span></span><br><span class="line">            <span class="comment">// being used), when the current OverScroller knows it&#x27;s done after</span></span><br><span class="line">            <span class="comment">// scroller.computeScrollOffset() is called.  If that happens, and we don&#x27;t update the</span></span><br><span class="line">            <span class="comment">// reference, it seems to me that we could prematurely stop the newly created scroller</span></span><br><span class="line">            <span class="comment">// due to setScrollState(SCROLL_STATE_IDLE) being called below.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Keep a local reference so that if it is changed during onAnimation method, it won&#x27;t</span></span><br><span class="line">            <span class="comment">// cause unexpected behaviors</span></span><br><span class="line">            <span class="keyword">final</span> OverScroller scroller = mOverScroller;</span><br><span class="line">            <span class="keyword">if</span> (scroller.computeScrollOffset()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> x = scroller.getCurrX();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> y = scroller.getCurrY();</span><br><span class="line">                <span class="keyword">int</span> unconsumedX = x - mLastFlingX;</span><br><span class="line">                <span class="keyword">int</span> unconsumedY = y - mLastFlingY;</span><br><span class="line">                mLastFlingX = x;</span><br><span class="line">                mLastFlingY = y;</span><br><span class="line">                <span class="keyword">int</span> consumedX = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> consumedY = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Nested Pre Scroll</span></span><br><span class="line">                mReusableIntPair[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">                mReusableIntPair[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (dispatchNestedPreScroll(unconsumedX, unconsumedY, mReusableIntPair, <span class="keyword">null</span>,</span><br><span class="line">                        TYPE_NON_TOUCH)) &#123;</span><br><span class="line">                    unconsumedX -= mReusableIntPair[<span class="number">0</span>];</span><br><span class="line">                    unconsumedY -= mReusableIntPair[<span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Based on movement, we may want to trigger the hiding of existing over scroll</span></span><br><span class="line">                <span class="comment">// glows.</span></span><br><span class="line">                <span class="keyword">if</span> (getOverScrollMode() != View.OVER_SCROLL_NEVER) &#123;</span><br><span class="line">                    considerReleasingGlowsOnScroll(unconsumedX, unconsumedY);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Local Scroll</span></span><br><span class="line">                <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mReusableIntPair[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">                    mReusableIntPair[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">                    scrollStep(unconsumedX, unconsumedY, mReusableIntPair);</span><br><span class="line">                    consumedX = mReusableIntPair[<span class="number">0</span>];</span><br><span class="line">                    consumedY = mReusableIntPair[<span class="number">1</span>];</span><br><span class="line">                    unconsumedX -= consumedX;</span><br><span class="line">                    unconsumedY -= consumedY;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// If SmoothScroller exists, this ViewFlinger was started by it, so we must</span></span><br><span class="line">                    <span class="comment">// report back to SmoothScroller.</span></span><br><span class="line">                    SmoothScroller smoothScroller = mLayout.mSmoothScroller;</span><br><span class="line">                    <span class="keyword">if</span> (smoothScroller != <span class="keyword">null</span> &amp;&amp; !smoothScroller.isPendingInitialRun()</span><br><span class="line">                            &amp;&amp; smoothScroller.isRunning()) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> adapterSize = mState.getItemCount();</span><br><span class="line">                        <span class="keyword">if</span> (adapterSize == <span class="number">0</span>) &#123;</span><br><span class="line">                            smoothScroller.stop();</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (smoothScroller.getTargetPosition() &gt;= adapterSize) &#123;</span><br><span class="line">                            smoothScroller.setTargetPosition(adapterSize - <span class="number">1</span>);</span><br><span class="line">                            smoothScroller.onAnimation(consumedX, consumedY);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            smoothScroller.onAnimation(consumedX, consumedY);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!mItemDecorations.isEmpty()) &#123;</span><br><span class="line">                    invalidate();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Nested Post Scroll</span></span><br><span class="line">                mReusableIntPair[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">                mReusableIntPair[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">                dispatchNestedScroll(consumedX, consumedY, unconsumedX, unconsumedY, <span class="keyword">null</span>,</span><br><span class="line">                        TYPE_NON_TOUCH, mReusableIntPair);</span><br><span class="line">                unconsumedX -= mReusableIntPair[<span class="number">0</span>];</span><br><span class="line">                unconsumedY -= mReusableIntPair[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (consumedX != <span class="number">0</span> || consumedY != <span class="number">0</span>) &#123;</span><br><span class="line">                    dispatchOnScrolled(consumedX, consumedY);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!awakenScrollBars()) &#123;</span><br><span class="line">                    invalidate();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// We are done scrolling if scroller is finished, or for both the x and y dimension,</span></span><br><span class="line">                <span class="comment">// we are done scrolling or we can&#x27;t scroll further (we know we can&#x27;t scroll further</span></span><br><span class="line">                <span class="comment">// when we have unconsumed scroll distance).  It&#x27;s possible that we don&#x27;t need</span></span><br><span class="line">                <span class="comment">// to also check for scroller.isFinished() at all, but no harm in doing so in case</span></span><br><span class="line">                <span class="comment">// of old bugs in Overscroller.</span></span><br><span class="line">                <span class="keyword">boolean</span> scrollerFinishedX = scroller.getCurrX() == scroller.getFinalX();</span><br><span class="line">                <span class="keyword">boolean</span> scrollerFinishedY = scroller.getCurrY() == scroller.getFinalY();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> doneScrolling = scroller.isFinished()</span><br><span class="line">                        || ((scrollerFinishedX || unconsumedX != <span class="number">0</span>)</span><br><span class="line">                        &amp;&amp; (scrollerFinishedY || unconsumedY != <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Get the current smoothScroller. It may have changed by this point and we need to</span></span><br><span class="line">                <span class="comment">// make sure we don&#x27;t stop scrolling if it has changed and it&#x27;s pending an initial</span></span><br><span class="line">                <span class="comment">// run.</span></span><br><span class="line">                SmoothScroller smoothScroller = mLayout.mSmoothScroller;</span><br><span class="line">                <span class="keyword">boolean</span> smoothScrollerPending =</span><br><span class="line">                        smoothScroller != <span class="keyword">null</span> &amp;&amp; smoothScroller.isPendingInitialRun();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!smoothScrollerPending &amp;&amp; doneScrolling) &#123;</span><br><span class="line">                    <span class="comment">// If we are done scrolling and the layout&#x27;s SmoothScroller is not pending,</span></span><br><span class="line">                    <span class="comment">// do the things we do at the end of a scroll and don&#x27;t postOnAnimation.</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (getOverScrollMode() != View.OVER_SCROLL_NEVER) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> vel = (<span class="keyword">int</span>) scroller.getCurrVelocity();</span><br><span class="line">                        <span class="keyword">int</span> velX = unconsumedX &lt; <span class="number">0</span> ? -vel : unconsumedX &gt; <span class="number">0</span> ? vel : <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">int</span> velY = unconsumedY &lt; <span class="number">0</span> ? -vel : unconsumedY &gt; <span class="number">0</span> ? vel : <span class="number">0</span>;</span><br><span class="line">                        absorbGlows(velX, velY);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ALLOW_THREAD_GAP_WORK) &#123;</span><br><span class="line">                        mPrefetchRegistry.clearPrefetchPositions();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Otherwise continue the scroll.</span></span><br><span class="line"></span><br><span class="line">                    postOnAnimation();</span><br><span class="line">                    <span class="keyword">if</span> (mGapWorker != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mGapWorker.postFromTraversal(RecyclerView.<span class="keyword">this</span>, consumedX, consumedY);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            SmoothScroller smoothScroller = mLayout.mSmoothScroller;</span><br><span class="line">            <span class="comment">// call this after the onAnimation is complete not to have inconsistent callbacks etc.</span></span><br><span class="line">            <span class="keyword">if</span> (smoothScroller != <span class="keyword">null</span> &amp;&amp; smoothScroller.isPendingInitialRun()) &#123;</span><br><span class="line">                smoothScroller.onAnimation(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mEatRunOnAnimationRequest = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (mReSchedulePostAnimationCallback) &#123;</span><br><span class="line">                internalPostOnAnimation();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                setScrollState(SCROLL_STATE_IDLE);</span><br><span class="line">                stopNestedScroll(TYPE_NON_TOUCH);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/09/02/SimpleDrwawwView%E5%8A%A8%E6%80%81%E8%AE%BE%E7%BD%AE/">SimpleDrwawwView动态设置</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-09-02</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-09-02</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>动态设置属性：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">RoundingParams roundingParams = <span class="keyword">new</span> RoundingParams();</span><br><span class="line">roundingParams.setRoundAsCircle(<span class="keyword">true</span>);</span><br><span class="line">GenericDraweeHierarchy hierarchy = GenericDraweeHierarchyBuilder.newInstance(context.getResources())</span><br><span class="line">        <span class="comment">//设置圆形圆角参数</span></span><br><span class="line">        .setRoundingParams(roundingParams)</span><br><span class="line">        .setRoundingParams(RoundingParams.fromCornersRadius(ViewUtil.INSTANCE.dip2px(<span class="number">10f</span>)))</span><br><span class="line">        .setFadeDuration(<span class="number">1000</span>)</span><br><span class="line">        .setActualImageScaleType(ScalingUtils.ScaleType.FIT_XY)</span><br><span class="line">        <span class="comment">//构建</span></span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  SimpleWebpView firstChargeWebp = v.findViewById(R.id.simpleview);</span><br><span class="line">  firstChargeWebp.setHierarchy(hierarchy);</span><br></pre></td></tr></table></div></figure>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/page/4/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/6/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">libertyYu</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/librityYu/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="1169927533" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">84</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">32</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">15</div><div class="sidebar-ov-state-item__name">标签</div></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><script src="https://unpkg.com/mermaid@8.8.3/dist/mermaid.min.js"></script><var>me = require('mermaid')</var></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script></body></html>